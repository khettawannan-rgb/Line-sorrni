<div class="page-header">
  <div>
    <h1>ผูก LINE ↔ Company</h1>
    <p class="muted">เชื่อม LINE userId กับข้อมูลบริษัท เพื่อจัดส่งรายงานและข้อความอัตโนมัติ</p>
  </div>
  <div class="actions">
    <a class="btn ghost" href="/admin/members">กลับไปยัง Members</a>
  </div>
</div>

<% if (result && result.ok) { %>
  <div class="alert success">
    <strong>สำเร็จ</strong>
    <pre class="mono"><%= result.message %></pre>
  </div>
<% } else if (result && result.error) { %>
  <div class="alert error">
    <strong>เกิดข้อผิดพลาด</strong>
    <pre class="mono"><%= result.error %></pre>
  </div>
<% } %>

<section class="section-block">
  <div class="grid grid-2 align-start">

  <section class="panel card">
    <div class="panel-header panel__header">
      <h3>ค้นโปรไฟล์จาก UID</h3>
    </div>

    <form class="form" method="post" action="/admin/link/profile">
      <div class="form-row">
        <label>LINE User ID (UID)</label>
        <input name="uid" placeholder="Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" value="<%= form.uid || '' %>" required>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn primary">ดึงโปรไฟล์</button>
      </div>
    </form>

    <% if (profile) { %>
      <div class="card mt-3">
        <h4>โปรไฟล์</h4>
        <div class="flex gap-md align-center">
          <% if (profile.pictureUrl) { %>
            <img src="<%= profile.pictureUrl %>" alt="avatar" class="avatar-md">
          <% } %>
          <div>
            <div><strong><%= profile.displayName %></strong></div>
            <div class="muted"><code><%= profile.userId %></code></div>
            <% if (profile.statusMessage) { %>
              <div class="muted"><%= profile.statusMessage %></div>
            <% } %>
          </div>
        </div>
      </div>

      <div class="card mt-2">
        <h4>ผูกกับบริษัท</h4>
        <form class="form" method="post" action="/admin/link/save">
          <input type="hidden" name="uid" value="<%= profile.userId %>">

          <div class="form-row">
            <label>Company</label>
            <select name="companyId" required>
              <% (companies||[]).forEach(c => { %>
                <option value="<%= c._id %>" <%= (existing && existing.companyId && existing.companyId._id?.toString() === c._id?.toString()) || (form.companyId===c._id?.toString()) ? 'selected' : '' %>>
                  <%= c.name %>
                </option>
              <% }) %>
            </select>
          </div>

          <div class="form-row">
            <label>Display Name (optional)</label>
            <input name="displayName" placeholder="เว้นว่างเพื่อใช้ชื่อจาก LINE" value="<%= existing?.displayName || profile.displayName || '' %>">
          </div>

          <div class="form-actions">
            <button type="submit" class="btn primary">บันทึกการผูก</button>
            <% if (existing) { %>
              <button class="btn danger" formaction="/admin/link/unlink" formmethod="post" name="uid" value="<%= profile.userId %>" onclick="return confirm('ปิดการใช้งานผู้ใช้นี้?')">ปิดการใช้งาน</button>
            <% } %>
          </div>
        </form>
      </div>
    <% } %>
  </section>

  <section class="panel card">
    <div class="panel-header panel__header">
      <h3>รายการผู้ใช้ที่ผูกอยู่</h3>
    </div>
    <% if (!members || members.length === 0) { %>
      <p class="muted">ยังไม่มีสมาชิก</p>
    <% } else { %>
      <div class="table-wrap table-scroll">
        <table class="table">
          <thead>
            <tr>
              <th>Display</th>
              <th>UID</th>
              <th>Company</th>
              <th>Active</th>
              <th class="col-actions"></th>
            </tr>
          </thead>
          <tbody>
            <% members.forEach(m => { %>
              <tr>
                <td><strong><%= m.displayName || '-' %></strong></td>
                <td><code><%= m.lineUserId %></code></td>
                <td><%= m.companyId ? m.companyId.name : '-' %></td>
                <td>
                  <% if (m.active) { %>
                    <span class="badge success">Active</span>
                  <% } else { %>
                    <span class="badge gray">Inactive</span>
                  <% } %>
                </td>
                <td class="table-actions col-actions">
                  <form method="post" action="/admin/link/profile">
                    <input type="hidden" name="uid" value="<%= m.lineUserId %>">
                    <button class="btn small ghost" type="submit">ดู/แก้</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </section>

  </div>
</section>
