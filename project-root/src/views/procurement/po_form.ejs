<%
  const guestMode = typeof isGuest !== 'undefined' ? !!isGuest : false;
  const action = '/admin/po';
  const items = Array.isArray(form.items)
    ? form.items
    : Array.isArray(form.lines)
      ? form.lines
      : [{ description: '', quantity: '', unitPrice: '', uom: 'EA', sku: '', notes: '' }];
  const computedSubtotal = items.reduce((sum, item) => {
    const qty = Number(item.quantity || 0);
    const price = Number(item.unitPrice || 0);
    return sum + (Number(item.lineTotal || item.amount) || qty * price);
  }, 0);
  const taxValue = Number(form.taxAmount ?? 0);
  const shippingValue = Number(form.shippingFee ?? 0);
  const subtotalValue = Number(form.subtotal ?? computedSubtotal);
  const totalValue = Number(form.totalAmount ?? subtotalValue + taxValue + shippingValue);
  const loginRedirect = `/admin/login?redirect=${encodeURIComponent('/admin/po/new')}`;
%>

<section class="page-hero">
  <div>
    <h1><%= form.prId ? 'สร้าง PO จาก PR' : 'สร้างใบสั่งซื้อ (PO)' %></h1>
    <p>ตรวจสอบรายละเอียดคำสั่งซื้อ ระบุการจัดส่ง และสร้างใบสั่งซื้อฉบับสมบูรณ์</p>
  </div>
  <div class="actions">
    <a href="/admin/po" class="btn ghost">← ย้อนกลับ</a>
  </div>
</section>

<% if (errors && errors.length) { %>
  <div class="alert danger">
    <strong>ตรวจสอบข้อมูลอีกครั้ง</strong>
    <ul>
      <% errors.forEach((err) => { %>
        <li><%= err %></li>
      <% }) %>
    </ul>
  </div>
<% } %>

<form method="post" action="<%= action %>" class="grid">
  <input type="hidden" name="prId" value="<%= form.prId || '' %>" />
  <% if (guestMode) { %>
    <div class="alert neutral">
      โหมดผู้เยี่ยมชม: ฟอร์มเปิดให้ดูเท่านั้น หากต้องการสร้าง PO กรุณาล็อกอินก่อน
    </div>
  <% } %>

  <fieldset class="grid" <%= guestMode ? 'disabled' : '' %>>
    <section class="card">
      <header>
        <h2>ข้อมูลเอกสาร</h2>
        <p class="subtitle">ข้อมูลหลักของใบสั่งซื้อ</p>
      </header>
      <div class="form-grid">
        <div class="form-group">
          <label for="vendorId">ผู้ขาย</label>
          <select id="vendorId" name="vendorId" required>
            <option value="">เลือกผู้ขาย...</option>
            <% vendors.forEach((vendor) => { %>
              <option value="<%= vendor._id %>" <%= String(form.vendorId) === String(vendor._id) ? 'selected' : '' %>><%= vendor.name %></option>
            <% }) %>
          </select>
        </div>
        <div class="form-group">
          <label for="companyId">บริษัท (ถ้ามี)</label>
          <input id="companyId" name="companyId" value="<%= form.companyId || '' %>" placeholder="ระบุรหัสบริษัทหรือเว้นว่าง" />
        </div>
        <div class="form-group">
          <label for="currency">สกุลเงิน</label>
          <input id="currency" name="currency" value="<%= form.currency || 'THB' %>" />
        </div>
        <div class="form-group">
          <label for="paymentTerms">เงื่อนไขการชำระเงิน</label>
          <input id="paymentTerms" name="paymentTerms" value="<%= form.paymentTerms || 'Credit 30 days' %>" />
        </div>
        <div class="form-group">
          <label for="incoterms">Incoterms</label>
          <input id="incoterms" name="incoterms" value="<%= form.incoterms || 'FOB' %>" />
        </div>
        <div class="form-group">
          <label for="expectedDeliveryDate">กำหนดส่ง</label>
          <input id="expectedDeliveryDate" name="expectedDeliveryDate" type="date" value="<%= form.expectedDeliveryDate ? dayjs(form.expectedDeliveryDate).format('YYYY-MM-DD') : '' %>" />
        </div>
      </div>
    </section>

    <section class="card">
      <header>
        <h2>รายการสินค้า</h2>
        <p class="subtitle">ตรวจสอบจำนวน ราคา และหมายเหตุให้ครบถ้วน</p>
      </header>
      <div class="line-items" data-item-list>
        <% items.forEach((item) => { %>
          <div class="item-row">
            <div>
              <label>SKU</label>
              <input name="itemSku" value="<%= item.sku || '' %>" />
            </div>
            <div>
              <label>รายละเอียด</label>
              <input name="itemDescription" value="<%= item.description || item.itemName || '' %>" required />
            </div>
            <div>
              <label>จำนวน</label>
              <input name="itemQuantity" type="number" step="0.01" min="0" value="<%= item.quantity || '' %>" required />
            </div>
            <div>
              <label>หน่วย</label>
              <input name="itemUom" value="<%= item.uom || item.unit || 'EA' %>" />
            </div>
            <div>
              <label>ราคา/หน่วย</label>
              <input name="itemUnitPrice" type="number" step="0.01" min="0" value="<%= item.unitPrice || '' %>" />
            </div>
            <div>
              <label>หมายเหตุ</label>
              <input name="itemNote" value="<%= item.notes || item.note || '' %>" />
            </div>
          </div>
        <% }) %>
      </div>
      <button type="button" class="btn ghost small" data-add-row>+ เพิ่มรายการสินค้า</button>
    </section>

    <section class="card">
      <header>
        <h2>การจัดส่ง</h2>
      </header>
      <div class="form-grid">
        <div class="form-group">
          <label for="shipTo">Ship To</label>
          <input id="shipTo" name="shipTo" value="<%= form.shipping?.shipTo || '' %>" />
        </div>
        <div class="form-group">
          <label for="shippingContact">ผู้ติดต่อ</label>
          <input id="shippingContact" name="shippingContact" value="<%= form.shipping?.contact || '' %>" />
        </div>
        <div class="form-group form-full">
          <label for="shippingAddress">ที่อยู่จัดส่ง</label>
          <textarea id="shippingAddress" name="shippingAddress" rows="3"><%= form.shipping?.address || '' %></textarea>
        </div>
        <div class="form-group form-full">
          <label for="remarks">หมายเหตุ</label>
          <textarea id="remarks" name="remarks" rows="3"><%= form.remarks || '' %></textarea>
        </div>
      </div>
    </section>
  </fieldset>

  <section class="card sticky-actions">
      <dl class="definition-list">
        <div>
          <dt>รวมก่อนภาษี</dt>
          <dd>฿<%= money(subtotalValue) %></dd>
        </div>
        <div>
          <dt>VAT</dt>
          <dd>฿<%= money(taxValue) %></dd>
        </div>
        <div>
          <dt>ค่าขนส่ง</dt>
          <dd>฿<%= money(shippingValue) %></dd>
        </div>
        <div>
          <dt>ยอดสุทธิ</dt>
          <dd><strong>฿<%= money(totalValue) %></strong></dd>
        </div>
      </dl>

    <% if (guestMode) { %>
      <a href="<%= loginRedirect %>" class="btn primary btn-block btn-lg">ล็อกอินเพื่อสร้าง PO</a>
    <% } else { %>
      <div class="form-actions">
        <button type="submit" class="btn primary btn-lg">สร้างใบสั่งซื้อ</button>
      </div>
    <% } %>
  </section>
</form>
