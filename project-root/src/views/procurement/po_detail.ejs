<%
  const guestMode = typeof isGuest !== 'undefined' ? !!isGuest : false;
  const loginRedirect = `/admin/login?redirect=${encodeURIComponent('/admin/po/' + po._id)}`;
  const vendorName = po.vendorId?.name || vendor?.name || '-';
%>

<section class="page-hero">
  <div>
    <h1><%= po.poNumber %></h1>
    <p>
      สร้างเมื่อ <%= dayjs(po.createdAt).format('DD MMM YYYY HH:mm') %>
      <% if (po.prId) { %>
        · จาก PR <a href="/admin/pr/<%= po.prId._id || po.prId %>"><%= po.prId.prNumber %></a>
      <% } %>
    </p>
  </div>
  <div class="actions">
    <span class="badge status-<%= po.status %>"><%= STATUS_LABELS[po.status] %></span>
    <a class="btn ghost" href="/admin/po">← ย้อนกลับ</a>
    <% if (!guestMode) { %>
      <a class="btn ghost" href="/admin/po/<%= po._id %>/pdf">Export PDF</a>
    <% } %>
  </div>
</section>

<% if (typeof toast !== 'undefined' && toast) { %>
  <div class="alert success"><%= toast %></div>
<% } %>

<div class="grid grid-2">
  <section class="card">
    <header>
      <h2>รายละเอียดใบสั่งซื้อ</h2>
    </header>
    <dl class="definition-list">
      <div>
        <dt>Vendor</dt>
        <dd>
          <strong><%= vendorName %></strong><br />
          <span class="text-muted"><%= vendor?.email || '-' %></span>
        </dd>
      </div>
      <div>
        <dt>สถานะ</dt>
        <dd><span class="badge status-<%= po.status %>"><%= STATUS_LABELS[po.status] %></span></dd>
      </div>
      <div>
        <dt>ยอดสุทธิ (ก่อน VAT)</dt>
        <dd>฿<%= po.subtotal.toLocaleString('th-TH', { minimumFractionDigits: 2 }) %></dd>
      </div>
      <div>
        <dt>VAT</dt>
        <dd>฿<%= po.taxAmount.toLocaleString('th-TH', { minimumFractionDigits: 2 }) %></dd>
      </div>
      <div>
        <dt>ค่าขนส่ง</dt>
        <dd>฿<%= po.shippingFee.toLocaleString('th-TH', { minimumFractionDigits: 2 }) %></dd>
      </div>
      <div>
        <dt>ยอดรวม</dt>
        <dd><strong>฿<%= po.totalAmount.toLocaleString('th-TH', { minimumFractionDigits: 2 }) %></strong></dd>
      </div>
      <div>
        <dt>Payment Terms</dt>
        <dd><%= po.paymentTerms || '-' %></dd>
      </div>
      <div>
        <dt>Incoterms</dt>
        <dd><%= po.incoterms || '-' %></dd>
      </div>
      <div>
        <dt>Ship To</dt>
        <dd>
          <strong><%= po.shipping?.shipTo || '-' %></strong><br />
          <span class="text-muted"><%= po.shipping?.address || '' %></span><br />
          <span class="text-muted"><%= po.shipping?.contact || '' %></span>
        </dd>
      </div>
      <div>
        <dt>กำหนดส่ง</dt>
        <dd><%= po.expectedDeliveryDate ? dayjs(po.expectedDeliveryDate).format('DD MMM YYYY') : '-' %></dd>
      </div>
      <% if (po.remarks) { %>
        <div class="span-2">
          <dt>หมายเหตุ</dt>
          <dd><%= po.remarks %></dd>
        </div>
      <% } %>
    </dl>
  </section>

  <section class="card">
    <header>
      <h2>การดำเนินการ</h2>
    </header>
    <% if (guestMode) { %>
      <div class="alert neutral">
        โหมดผู้เยี่ยมชม: ต้องล็อกอินก่อนดำเนินการแก้ไขหรืออนุมัติใบสั่งซื้อ
      </div>
      <a href="<%= loginRedirect %>" class="btn primary btn-block">ล็อกอินเพื่อดำเนินการ</a>
    <% } else { %>
      <% if (po.status === PO_STATUSES.DRAFT) { %>
        <form method="post" action="/admin/po/<%= po._id %>/approve" class="stack">
          <label>Remark</label>
          <textarea name="remark" rows="2" placeholder="ข้อความบันทึกเมื่ออนุมัติ"></textarea>
          <button type="submit" class="btn success btn-block">Approve PO</button>
        </form>
      <% } %>
      <form method="post" action="/admin/po/<%= po._id %>/status" class="stack">
        <label>อัปเดตสถานะ</label>
        <select name="status">
          <% Object.values(PO_STATUSES).forEach((status) => { %>
            <option value="<%= status %>" <%= po.status === status ? 'selected' : '' %>><%= STATUS_LABELS[status] %></option>
          <% }) %>
        </select>
        <textarea name="remark" rows="2" placeholder="หมายเหตุเพิ่มเติม"></textarea>
        <button type="submit" class="btn secondary btn-block">อัปเดตสถานะ</button>
      </form>
      <% if (po.pdfUrl) { %>
        <a class="btn ghost btn-block" href="<%= po.pdfUrl %>" target="_blank" rel="noopener">ดาวน์โหลด PDF ล่าสุด</a>
      <% } %>
    <% } %>
  </section>
</div>

<section class="card">
  <header>
    <h2>รายการสินค้า</h2>
  </header>
  <div class="responsive-table">
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>SKU</th>
          <th>รายละเอียด</th>
          <th>จำนวน</th>
          <th>หน่วย</th>
          <th class="text-right">ราคา/หน่วย</th>
          <th class="text-right">รวม</th>
        </tr>
      </thead>
      <tbody>
        <% po.items.forEach((item, idx) => { %>
          <tr>
            <td data-label="#"><%= idx + 1 %></td>
            <td data-label="SKU"><%= item.sku || '-' %></td>
            <td data-label="รายละเอียด">
              <strong><%= item.itemName %></strong>
              <% if (item.note) { %>
                <div class="text-muted text-xs"><%= item.note %></div>
              <% } %>
            </td>
            <td data-label="จำนวน"><%= item.quantity %></td>
            <td data-label="หน่วย"><%= item.unit %></td>
            <td data-label="ราคา/หน่วย" class="text-right">฿<%= item.unitPrice.toLocaleString('th-TH', { minimumFractionDigits: 2 }) %></td>
            <td data-label="รวม" class="text-right">฿<%= item.lineTotal.toLocaleString('th-TH', { minimumFractionDigits: 2 }) %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <header>
    <h2>ประวัติการเปลี่ยนสถานะ</h2>
  </header>
  <% if (!po.statusHistory || !po.statusHistory.length) { %>
    <p class="text-muted">ยังไม่มีประวัติการเปลี่ยนสถานะ</p>
  <% } else { %>
    <ul class="timeline">
      <% po.statusHistory.slice().reverse().forEach((entry) => { %>
        <li>
          <div class="timeline__time"><%= dayjs(entry.at).format('DD MMM YYYY HH:mm') %></div>
          <div class="timeline__body">
            <strong><%= STATUS_LABELS[entry.status] || entry.status %></strong>
            <span class="text-muted">โดย <%= entry.actor %></span>
            <% if (entry.remark) { %>
              <div><%= entry.remark %></div>
            <% } %>
          </div>
        </li>
      <% }) %>
    </ul>
  <% } %>
</section>
