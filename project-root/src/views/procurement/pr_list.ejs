<section class="page-header">
  <div>
    <h1>Smart Procurement · Purchase Requisitions</h1>
    <p class="text-muted">
      ตรวจสอบสถานะสินค้า, สร้างใบขอซื้อ (PR) และเตรียมการสั่งซื้ออัตโนมัติจากข้อมูลคงคลัง
    </p>
  </div>
  <div class="actions">
    <a href="#pr-create-form" class="btn primary" data-dialog-open="pr-create-dialog">+ สร้างใบขอซื้อ</a>
  </div>
</section>

<% if (Array.isArray(lowStock) && lowStock.length) { %>
  <section class="card highlight">
    <header>
      <h2>สินค้าที่ใกล้หมด (Auto-Reorder Suggestions)</h2>
      <p>สร้าง PR ได้ทันทีเมื่อคงเหลือถึงจุดสั่งซื้อใหม่ (Reorder Point)</p>
    </header>
    <div class="grid grid-3">
      <% lowStock.forEach((item) => { %>
        <article class="card card-compact">
          <header>
            <strong><%= item.itemName %></strong>
            <span class="badge warning">Low Stock</span>
          </header>
          <dl>
            <div><dt>คงเหลือ</dt><dd><%= item.currentQuantity %> <%= item.unit %></dd></div>
            <div><dt>Reorder Point</dt><dd><%= item.reorderPoint %></dd></div>
            <div><dt>ค่าใช้เฉลี่ย/วัน</dt><dd><%= item.avgDailyUsage %> <%= item.unit %></dd></div>
            <div><dt>คาดว่าจะหมด</dt><dd><%= item.forecastDate ? dayjs(item.forecastDate).format('DD MMM YYYY') : '-' %></dd></div>
          </dl>
          <form class="inline" method="post" action="/admin/pr">
            <input type="hidden" name="autoGenerated" value="true" />
            <input type="hidden" name="requestedBy" value="<%= (user && user.username) || 'system' %>" />
            <input type="hidden" name="companyId" value="<%= defaultCompanyId || '' %>" />
            <input type="hidden" name="itemName" value="<%= item.itemName %>" />
            <input type="hidden" name="quantity" value="<%= Math.max(item.reorderPoint - item.currentQuantity, 1) %>" />
            <input type="hidden" name="unit" value="<%= item.unit %>" />
            <input type="hidden" name="itemNote" value="Auto reorder suggestion from stock monitor" />
            <button type="submit" class="btn small secondary">สร้าง PR อัตโนมัติ</button>
          </form>
        </article>
      <% }) %>
    </div>
  </section>
<% } %>

<section class="card">
  <header>
    <h2>รายการใบขอซื้อ</h2>
    <p>ติดตามสถานะและเชื่อมต่อกับใบสั่งซื้อ (PO)</p>
  </header>

  <table class="table">
    <thead>
      <tr>
        <th>PR No.</th>
        <th>สถานะ</th>
        <th>Requester</th>
        <th>รายการ</th>
        <th>เชื่อม PO</th>
        <th>อัปเดตล่าสุด</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <% if (!prs.length) { %>
        <tr>
          <td colspan="7" class="text-center text-muted">ยังไม่มีใบขอซื้อ</td>
        </tr>
      <% } %>
      <% prs.forEach((pr) => { %>
        <tr>
          <td><strong><%= pr.prNumber %></strong></td>
          <td><span class="badge status-<%= pr.status %>"><%= STATUS_LABELS[pr.status] || pr.status %></span></td>
          <td><%= pr.requestedBy %></td>
          <td>
            <ul class="list-compact">
              <% pr.items.forEach((item) => { %>
                <li><%= item.itemName %> · <%= item.quantity %> <%= item.unit %></li>
              <% }) %>
            </ul>
          </td>
          <td>
            <% if (pr.linkedPurchaseOrder) { %>
              <a href="/admin/po?highlight=<%= pr.linkedPurchaseOrder._id %>"><%= pr.linkedPurchaseOrder.poNumber %></a>
            <% } else { %>
              <span class="text-muted">-</span>
            <% } %>
          </td>
          <td><%= dayjs(pr.updatedAt).format('DD MMM YYYY HH:mm') %></td>
          <td class="text-right">
            <div class="btn-group">
              <% if (pr.status === PR_STATUSES.DRAFT) { %>
                <form method="post" action="/admin/pr/<%= pr._id %>/submit">
                  <button type="submit" class="btn small primary">ส่งอนุมัติ</button>
                </form>
              <% } %>
              <% if (pr.status === PR_STATUSES.PENDING_APPROVAL) { %>
                <form method="post" action="/admin/pr/<%= pr._id %>/status">
                  <input type="hidden" name="status" value="<%= PR_STATUSES.APPROVED %>" />
                  <button type="submit" class="btn small success">อนุมัติ</button>
                </form>
                <form method="post" action="/admin/pr/<%= pr._id %>/status">
                  <input type="hidden" name="status" value="<%= PR_STATUSES.REJECTED %>" />
                  <button type="submit" class="btn small danger">ปฏิเสธ</button>
                </form>
              <% } %>
            </div>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</section>

<section class="card">
  <header>
    <h2>ภาพรวมคงคลัง</h2>
    <p>ข้อมูลสต็อกจาก weighbridge / manual input</p>
  </header>
  <table class="table">
    <thead>
      <tr>
        <th>รายการ</th>
        <th>คงเหลือ</th>
        <th>Reorder Point</th>
        <th>Avg Daily Usage</th>
        <th>Forecast</th>
      </tr>
    </thead>
    <tbody>
      <% if (!stockItems.length) { %>
        <tr><td colspan="5" class="text-center text-muted">ยังไม่มีข้อมูลคงคลัง</td></tr>
      <% } %>
      <% stockItems.forEach((item) => { %>
        <tr>
          <td><%= item.itemName %></td>
          <td><%= item.currentQuantity %> <%= item.unit %></td>
          <td><%= item.reorderPoint %></td>
          <td><%= item.avgDailyUsage %> /วัน</td>
          <td><%= item.forecastDepletionDate ? dayjs(item.forecastDepletionDate).format('DD MMM YYYY') : '-' %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</section>

<div class="dialog" id="pr-create-dialog" hidden>
  <div class="dialog-content">
    <header class="dialog-header">
      <h3>สร้างใบขอซื้อ</h3>
      <button type="button" class="dialog-close" data-dialog-close>&times;</button>
    </header>
    <form id="pr-create-form" method="post" action="/admin/pr" enctype="multipart/form-data" class="form-grid">
      <input type="hidden" name="companyId" value="<%= defaultCompanyId || '' %>" />
      <div class="form-group">
        <label>ผู้ร้องขอ</label>
        <input type="text" name="requestedBy" value="<%= (user && user.username) || '' %>" required />
      </div>
      <div class="form-group">
        <label>หมายเหตุ</label>
        <textarea name="note" rows="2" placeholder="รายละเอียดเพิ่มเติม"></textarea>
      </div>

      <fieldset class="form-group" data-item-list>
        <legend>รายการสินค้า</legend>
        <div class="item-row">
          <input type="text" name="itemName" placeholder="ชื่อสินค้า" required />
          <input type="number" name="quantity" placeholder="จำนวน" min="1" required />
          <input type="text" name="unit" placeholder="หน่วย" value="ตัน" />
          <input type="text" name="itemNote" placeholder="หมายเหตุ" />
        </div>
      </fieldset>
      <div class="form-group">
        <button type="button" class="btn small secondary" data-add-row>+ เพิ่มรายการ</button>
      </div>

      <div class="form-group">
        <label>แนบไฟล์ (PDF/เอกสาร)</label>
        <input type="file" name="attachments" multiple />
      </div>

      <footer class="dialog-footer">
        <button type="submit" class="btn primary">บันทึกใบขอซื้อ</button>
        <button type="button" class="btn ghost" data-dialog-close>ยกเลิก</button>
      </footer>
    </form>
  </div>
</div>
