<%
  const action = MODE === 'edit' ? `/admin/pr/${form._id}` : '/admin/pr';
  const guestMode = typeof isGuest !== 'undefined' ? !!isGuest : false;
  const taxPercent = Number(form.taxRate || 0) * 100;
  const loginRedirect = `/admin/login?redirect=${encodeURIComponent(action + (MODE === 'edit' ? '' : '/new'))}`;
  const lineItems = Array.isArray(form.lines) && form.lines.length
    ? form.lines
    : [
        { sku: '', description: '', quantity: '', uom: 'EA', unitPrice: '', notes: '' },
      ];
  const computedSubtotal = lineItems.reduce((sum, line) => {
        const qty = Number(line.quantity || 0);
        const price = Number(line.unitPrice || 0);
        return sum + (Number(line.amount || qty * price) || 0);
      }, 0);
  const subtotalValue = Number(form.subtotal ?? computedSubtotal);
  const taxValue = Number(form.taxAmount ?? 0);
  const totalValue = Number(form.total ?? subtotalValue + taxValue);
%>

<section class="page-hero">
  <div>
    <h1><%= MODE === 'edit' ? `แก้ไข ${form.prNumber}` : 'สร้างใบขอซื้อ (PR)' %></h1>
    <p>กรอกข้อมูลผู้ขาย รายละเอียดสินค้า และสรุปยอดเพื่อบันทึก PR</p>
  </div>
  <div class="actions">
    <a href="/admin/pr" class="btn ghost">← ย้อนกลับ</a>
  </div>
</section>

<% if (errors && errors.length) { %>
  <div class="alert danger">
    <strong>ไม่สามารถบันทึกได้</strong>
    <ul>
      <% errors.forEach((err) => { %>
        <li><%= err %></li>
      <% }) %>
    </ul>
  </div>
<% } %>

<form method="post" action="<%= action %>" enctype="multipart/form-data" class="grid">
  <% if (guestMode) { %>
    <div class="alert neutral">
      โหมดผู้เยี่ยมชม: สามารถดูตัวอย่างฟอร์มได้ แต่ต้องล็อกอินก่อนจึงจะบันทึกหรือส่งอนุมัติได้
    </div>
  <% } %>

  <fieldset class="grid" <%= guestMode ? 'disabled' : '' %>>
    <section class="card">
      <header>
        <h2>ข้อมูลเอกสาร</h2>
        <p class="subtitle">ข้อมูลหลักของใบขอซื้อ</p>
      </header>
      <div class="form-grid">
        <div class="form-group">
          <label for="requester">ผู้ร้องขอ</label>
          <input id="requester" name="requester" value="<%= form.requester || '' %>" required />
        </div>
        <div class="form-group">
          <label for="vendor">ผู้ขาย</label>
          <select id="vendor" name="vendorId" required>
            <option value="">เลือกผู้ขาย...</option>
            <% vendors.forEach((vendor) => { %>
              <option value="<%= vendor._id %>" <%= String(form.vendorId) === String(vendor._id) ? 'selected' : '' %>><%= vendor.name %></option>
            <% }) %>
          </select>
        </div>
        <div class="form-group">
          <label for="currency">สกุลเงิน</label>
          <input id="currency" name="currency" value="<%= form.currency || 'THB' %>" />
        </div>
        <div class="form-group">
          <label for="companyId">บริษัท (ถ้ามี)</label>
          <input id="companyId" name="companyId" value="<%= form.companyId || '' %>" placeholder="ระบุ ID บริษัท หรือเว้นว่าง" />
        </div>
        <div class="form-group">
          <label for="taxRate">VAT (%)</label>
          <input id="taxRate" name="taxRate" type="number" step="0.01" value="<%= taxPercent.toFixed(2) %>" />
          <small>ระบุเป็นเปอร์เซ็นต์ เช่น 7.00</small>
        </div>
        <div class="form-group">
          <label for="taxAmount">ภาษี (บาท)</label>
          <input id="taxAmount" name="taxAmount" type="number" step="0.01" value="<%= form.taxAmount || '' %>" />
        </div>
        <div class="form-group form-full">
          <label for="notes">หมายเหตุ</label>
          <textarea id="notes" name="notes" rows="3"><%= form.notes || '' %></textarea>
        </div>
      </div>
    </section>

    <section class="card">
      <header>
        <h2>รายการสินค้า</h2>
        <p class="subtitle">เพิ่มรายการสินค้า/บริการที่ต้องการสั่งซื้อ</p>
      </header>
      <div class="line-items" data-item-list>
        <% lineItems.forEach((line) => { %>
          <div class="item-row">
            <div>
              <label>SKU</label>
              <input name="lineSku" value="<%= line.sku || '' %>" />
            </div>
            <div>
              <label>รายละเอียด</label>
              <input name="lineDescription" value="<%= line.description || '' %>" required />
            </div>
            <div>
              <label>จำนวน</label>
              <input name="lineQuantity" type="number" step="0.01" min="0" value="<%= line.quantity || '' %>" required />
            </div>
            <div>
              <label>หน่วย</label>
              <input name="lineUom" value="<%= line.uom || 'EA' %>" />
            </div>
            <div>
              <label>ราคา/หน่วย</label>
              <input name="linePrice" type="number" step="0.01" min="0" value="<%= line.unitPrice || '' %>" />
            </div>
            <div>
              <label>หมายเหตุ</label>
              <input name="lineNote" value="<%= line.notes || '' %>" />
            </div>
          </div>
        <% }) %>
      </div>
      <button type="button" class="btn ghost small" data-add-row>+ เพิ่มรายการสินค้า</button>
    </section>

    <section class="card">
      <header>
        <h2>ไฟล์แนบ</h2>
        <p class="subtitle">แนบใบเสนอราคา ใบแจ้งหนี้ หรือเอกสารประกอบ</p>
      </header>
      <div class="form-group form-full">
        <input type="file" name="attachments" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx" multiple />
        <small>รองรับสูงสุด 5 ไฟล์</small>
      </div>
      <% if (Array.isArray(form.attachments) && form.attachments.length) { %>
        <ul class="attachment-list">
          <% form.attachments.forEach((att) => { %>
            <li>
              <a href="<%= att.url %>" target="_blank" rel="noopener"><%= att.originalName || att.filename %></a>
              <span class="text-muted"><%= att.size ? (att.size / 1024).toFixed(1) + ' KB' : '' %></span>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </section>
  </fieldset>

  <section class="card sticky-actions">
    <% if (guestMode) { %>
      <a href="<%= loginRedirect %>" class="btn primary btn-block btn-lg">ล็อกอินเพื่อบันทึก PR</a>
    <% } else { %>
      <dl class="definition-list">
        <div>
          <dt>รวมก่อนภาษี</dt>
          <dd>฿<%= money(subtotalValue) %></dd>
        </div>
        <div>
          <dt>VAT</dt>
          <dd>฿<%= money(taxValue) %></dd>
        </div>
        <div>
          <dt>ยอดสุทธิ</dt>
          <dd><strong>฿<%= money(totalValue) %></strong></dd>
        </div>
      </dl>
      <div class="form-actions">
        <button type="submit" class="btn primary btn-lg">
          <%= MODE === 'edit' ? 'บันทึกการแก้ไข' : 'บันทึก Draft' %>
        </button>
        <% if (MODE === 'edit' && form.status === PR_STATUSES.DRAFT) { %>
          <button type="submit" formaction="/admin/pr/<%= form._id %>/submit" class="btn success btn-lg">
            ส่งอนุมัติ
          </button>
        <% } %>
      </div>
    <% } %>
  </section>
</form>
