<%
  const action = MODE === 'edit' ? `/admin/pr/${form._id}` : '/admin/pr';
  const mobileView = typeof isLineMobile !== 'undefined' && isLineMobile;
%>

<% if (mobileView) { %>
  <section class="line-mobile-hero">
    <div class="line-mobile-hero__title">
      <h1><%= MODE === 'edit' ? `แก้ไข ${form.prNumber}` : 'สร้างใบขอซื้อ' %></h1>
      <p>กรอกข้อมูลสั้น ๆ เพื่อสร้างใบ PR จากมือถือ</p>
    </div>
    <div class="line-mobile-hero__stats compact">
      <div>
        <span class="label">ผู้ขาย</span>
        <strong><%= vendors.length %></strong>
      </div>
      <div>
        <span class="label">รายการ</span>
        <strong><%= form.lines.length %></strong>
      </div>
      <div>
        <span class="label">ภาษี</span>
        <strong><%= Number(form.taxRate || 0) * 100 %>%</strong>
      </div>
    </div>
    <a href="/admin/pr" class="btn ghost btn-block">← กลับรายการ PR</a>
  </section>
<% } else { %>
  <section class="page-header">
    <div>
      <h1><%= MODE === 'edit' ? `Edit ${form.prNumber}` : 'Create PR' %></h1>
      <p class="text-muted">ระบุรายละเอียดผู้ขาย รายการสินค้า และแนบไฟล์ที่เกี่ยวข้อง</p>
    </div>
    <div class="actions">
      <a href="/admin/pr" class="btn ghost">← กลับรายการ PR</a>
    </div>
  </section>
<% } %>

<section class="card <%= mobileView ? 'line-mobile-card' : '' %>">
  <% if (errors && errors.length) { %>
    <div class="alert danger">
      <strong>ไม่สามารถบันทึกได้</strong>
      <ul>
        <% errors.forEach((err) => { %>
          <li><%= err %></li>
        <% }) %>
      </ul>
    </div>
  <% } %>

  <form method="post" action="<%= action %>" enctype="multipart/form-data" class="form-grid <%= mobileView ? 'mobile' : '' %>">
    <div class="form-group">
      <label for="requester">ผู้ร้องขอ (Requester)</label>
      <input id="requester" name="requester" value="<%= form.requester || '' %>" required />
    </div>
    <div class="form-group">
      <label for="vendor">ผู้ขาย (Vendor)</label>
      <select id="vendor" name="vendorId" required>
        <option value="">เลือกผู้ขาย...</option>
        <% vendors.forEach((vendor) => { %>
          <option value="<%= vendor._id %>" <%= String(form.vendorId) === String(vendor._id) ? 'selected' : '' %>>
            <%= vendor.name %>
          </option>
        <% }) %>
      </select>
    </div>
    <div class="form-group">
      <label for="currency">สกุลเงิน</label>
      <input id="currency" name="currency" value="<%= form.currency || 'THB' %>" />
    </div>
    <div class="form-group">
      <label for="companyId">บริษัท (optional)</label>
      <input id="companyId" name="companyId" value="<%= form.companyId || '' %>" placeholder="Mongo ID หรือปล่อยว่าง" />
    </div>

    <div class="form-group form-full">
      <label>รายการสินค้า</label>
      <div class="line-items" data-item-list>
        <% form.lines.forEach((line, idx) => { %>
          <div class="item-row">
            <div>
              <label>SKU</label>
              <input name="lineSku" value="<%= line.sku || '' %>" />
            </div>
            <div>
              <label>รายละเอียด</label>
              <input name="lineDescription" value="<%= line.description || '' %>" required />
            </div>
            <div>
              <label>จำนวน</label>
              <input name="lineQuantity" type="number" step="0.01" min="0" value="<%= line.quantity || '' %>" required />
            </div>
            <div>
              <label>หน่วย</label>
              <input name="lineUom" value="<%= line.uom || 'EA' %>" />
            </div>
            <div>
              <label>ราคา/หน่วย</label>
              <input name="linePrice" type="number" step="0.01" min="0" value="<%= line.unitPrice || '' %>" />
            </div>
            <div>
              <label>หมายเหตุ</label>
              <input name="lineNote" value="<%= line.notes || '' %>" />
            </div>
          </div>
        <% }) %>
      </div>
      <button type="button" class="btn ghost small <%= mobileView ? 'btn-block' : '' %>" data-add-row>+ เพิ่มแถว</button>
    </div>

    <div class="form-group">
      <label for="taxRate">VAT (%)</label>
      <input id="taxRate" name="taxRate" type="number" step="0.01" value="<%= (Number(form.taxRate || 0) * 100).toFixed(2) %>" />
      <small class="text-muted">ระบบจะคิดเป็นทศนิยม เช่น 7% = 7.00</small>
    </div>
    <div class="form-group">
      <label for="taxAmount">ภาษี (บาท)</label>
      <input id="taxAmount" name="taxAmount" type="number" step="0.01" value="<%= form.taxAmount || '' %>" />
    </div>
    <div class="form-group">
      <label for="notes">หมายเหตุ</label>
      <textarea id="notes" name="notes" rows="3"><%= form.notes || '' %></textarea>
    </div>

    <div class="form-group form-full">
      <label>แนบไฟล์ (PDF/ภาพ สูงสุด 5 ไฟล์)</label>
      <input type="file" name="attachments" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx" multiple />
      <% if (Array.isArray(form.attachments) && form.attachments.length) { %>
        <ul class="attachment-list">
          <% form.attachments.forEach((att) => { %>
            <li>
              <a href="<%= att.url %>" target="_blank" rel="noopener"><%= att.originalName || att.filename %></a>
              <span class="text-muted"><%= (att.size / 1024).toFixed(1) %> KB</span>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </div>

    <div class="form-actions form-full <%= mobileView ? 'line-mobile-actions' : '' %>">
      <button type="submit" class="btn primary <%= mobileView ? 'btn-block btn-lg' : '' %>">
        <%= MODE === 'edit' ? 'Save Changes' : 'Create PR' %>
      </button>
      <% if (MODE === 'edit' && form.status === PR_STATUSES.DRAFT) { %>
        <button type="submit" formaction="/admin/pr/<%= form._id %>/submit" class="btn success <%= mobileView ? 'btn-block btn-lg' : '' %>">
          Submit for Approval
        </button>
      <% } %>
    </div>
  </form>
</section>
