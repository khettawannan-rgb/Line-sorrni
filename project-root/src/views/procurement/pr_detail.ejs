<%
  const guestMode = typeof isGuest !== 'undefined' ? !!isGuest : false;
  const loginRedirect = `/admin/login?redirect=${encodeURIComponent('/admin/pr/' + pr._id)}`;
  const vendorName = get(vendor, 'name', get(pr, 'vendorId.name', '-'));
  const subtotalValue = Number(get(pr, 'subtotal', get(pr, 'total', 0) - get(pr, 'taxAmount', 0)));
  const taxValue = Number(get(pr, 'taxAmount', 0));
  const totalValue = Number(get(pr, 'total', 0));
  const lines = Array.isArray(pr.lines) ? pr.lines : [];
%>

<section class="page-hero">
  <div>
    <h1><%= get(pr, 'prNumber', '-') %></h1>
    <p>สร้างเมื่อ <%= dateFmt(get(pr, 'createdAt', null), 'DD MMM YYYY HH:mm') %> · โดย <%= get(pr, 'requester', '-') %></p>
  </div>
  <div class="actions">
    <span class="badge status-<%= pr.status %>"><%= get(STATUS_LABELS, pr.status, pr.status) %></span>
    <a href="/admin/pr" class="btn ghost">← ย้อนกลับ</a>
  </div>
</section>

<% if (typeof toast !== 'undefined' && toast) { %>
  <div class="alert success"><%= toast %></div>
<% } %>

<div class="grid grid-2">
  <section class="card">
    <header>
      <h2>รายละเอียดใบขอซื้อ</h2>
    </header>
    <dl class="definition-list">
      <div>
        <dt>ผู้ร้องขอ</dt>
        <dd><%= get(pr, 'requester', '-') %></dd>
      </div>
      <div>
        <dt>บริษัท</dt>
        <dd><%= get(pr, 'companyId', '-') %></dd>
      </div>
      <div>
        <dt>ยอดรวมก่อนภาษี</dt>
        <dd>฿<%= money(subtotalValue) %></dd>
      </div>
      <div>
        <dt>VAT</dt>
        <dd><%= num(get(pr, 'taxRate', 0) * 100, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>% · ฿<%= money(taxValue) %></dd>
      </div>
      <div>
        <dt>ยอดสุทธิ</dt>
        <dd><strong>฿<%= money(totalValue) %></strong></dd>
      </div>
      <% if (get(pr, 'notes')) { %>
        <div class="span-2">
          <dt>หมายเหตุ</dt>
          <dd><%= get(pr, 'notes', '') %></dd>
        </div>
      <% } %>
    </dl>
    <% if (Array.isArray(pr.attachments) && pr.attachments.length) { %>
      <hr style="border:none;border-top:1px solid var(--border);margin:18px 0;">
      <h3>ไฟล์แนบ</h3>
      <ul class="attachment-list">
        <% pr.attachments.forEach((att) => { %>
          <li>
            <a href="<%= att.url %>" target="_blank" rel="noopener"><%= att.originalName || att.filename %></a>
            <span class="text-muted"><%= dateFmt(att.uploadedAt, 'DD MMM YYYY HH:mm') %></span>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </section>

  <section class="card">
    <header>
      <h2>Vendor &amp; การดำเนินการ</h2>
    </header>
    <dl class="definition-list">
      <div>
        <dt>Vendor</dt>
        <dd>
          <strong><%= vendorName %></strong><br />
          <span class="text-muted"><%= get(vendor, 'email', get(pr, 'vendorId.email', '-')) %></span>
        </dd>
      </div>
      <div>
        <dt>สถานะ</dt>
        <dd><span class="badge status-<%= pr.status %>"><%= get(STATUS_LABELS, pr.status, pr.status) %></span></dd>
      </div>
    </dl>

    <% if (guestMode) { %>
      <div class="alert neutral">
        โหมดผู้เยี่ยมชม: ต้องล็อกอินก่อนจึงจะอนุมัติ/แก้ไขเอกสารได้
      </div>
      <a href="<%= loginRedirect %>" class="btn primary btn-block">ล็อกอินเพื่อดำเนินการ</a>
    <% } else { %>
      <% if (pr.status === PR_STATUSES.DRAFT) { %>
        <div class="form-actions">
          <a class="btn ghost" href="/admin/pr/<%= pr._id %>/edit">แก้ไข PR</a>
          <form method="post" action="/admin/pr/<%= pr._id %>/submit" class="inline">
            <button type="submit" class="btn primary">ส่งอนุมัติ</button>
          </form>
        </div>
      <% } else if (pr.status === PR_STATUSES.WAITING_APPROVAL) { %>
        <form method="post" action="/admin/pr/<%= pr._id %>/approve" class="stack">
          <h3>อนุมัติและสร้าง PO</h3>
          <label>Remark
            <textarea name="remark" rows="2" placeholder="คำอธิบายเพิ่มเติม"></textarea>
          </label>
          <label>Ship To
            <input name="shipTo" placeholder="ชื่อผู้รับสินค้า" />
          </label>
          <label>ที่อยู่จัดส่ง
            <textarea name="shippingAddress" rows="2"></textarea>
          </label>
          <label>ผู้ติดต่อ
            <input name="shippingContact" placeholder="เบอร์ติดต่อ/อีเมล" />
          </label>
          <label>Payment Terms
            <input name="paymentTerms" value="Credit 30 days" />
          </label>
          <label>Incoterms
            <input name="incoterms" value="FOB" />
          </label>
          <button type="submit" class="btn success btn-block">อนุมัติ &amp; สร้าง PO</button>
        </form>

        <form method="post" action="/admin/pr/<%= pr._id %>/reject" class="stack">
          <h3>ปฏิเสธเอกสาร</h3>
          <label>เหตุผลการปฏิเสธ</label>
          <textarea name="reason" rows="2" required></textarea>
          <button type="submit" class="btn danger btn-block">ปฏิเสธ PR</button>
        </form>
      <% } else if (pr.linkedPurchaseOrder) { %>
        <a href="/admin/po/<%= pr.linkedPurchaseOrder._id %>" class="btn ghost btn-block">
          เปิด PO <%= get(pr, 'linkedPurchaseOrder.poNumber', '-') %>
        </a>
      <% } else { %>
        <p class="text-muted">ไม่มีการดำเนินการเพิ่มเติมในสถานะนี้</p>
      <% } %>
    <% } %>
  </section>
</div>

<section class="card">
  <header>
    <h2>รายการสินค้า</h2>
  </header>
  <div class="responsive-table">
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>รายละเอียด</th>
          <th>จำนวน</th>
          <th>หน่วย</th>
          <th class="text-right">ราคา/หน่วย</th>
          <th class="text-right">รวม</th>
        </tr>
      </thead>
      <tbody>
        <% lines.forEach((line, idx) => { %>
          <tr>
            <td data-label="#"><%= idx + 1 %></td>
            <td data-label="รายละเอียด">
              <strong><%= get(line, 'description', '-') %></strong>
              <% if (get(line, 'notes')) { %>
                <div class="text-muted text-xs"><%= get(line, 'notes', '') %></div>
              <% } %>
            </td>
            <td data-label="จำนวน"><%= num(get(line, 'quantity', 0)) %></td>
            <td data-label="หน่วย"><%= get(line, 'uom', '-') %></td>
            <td data-label="ราคา/หน่วย" class="text-right">฿<%= money(get(line, 'unitPrice', 0)) %></td>
            <td data-label="รวม" class="text-right">฿<%= money(get(line, 'amount', 0)) %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</section>

<section class="card">
  <header>
    <h2>ไทม์ไลน์การดำเนินงาน</h2>
  </header>
  <% const history = Array.isArray(pr.history) ? pr.history : []; %>
  <% if (!history.length) { %>
    <p class="text-muted">ยังไม่มีประวัติการดำเนินงาน</p>
  <% } else { %>
    <ul class="timeline">
      <% history.slice().reverse().forEach((entry) => { %>
        <li>
          <div class="timeline__time"><%= dateFmt(get(entry, 'at', null), 'DD MMM YYYY HH:mm') %></div>
          <div class="timeline__body">
            <strong><%= get(entry, 'action', '-') %></strong>
            <span class="text-muted">โดย <%= get(entry, 'actor', '-') %></span>
            <% if (get(entry, 'remark')) { %>
              <div><%= get(entry, 'remark', '') %></div>
            <% } %>
          </div>
        </li>
      <% }) %>
    </ul>
  <% } %>
</section>
