<!-- src/views/consents.ejs -->
<div class="panel">
  <div class="panel-header panel__header">
    <h2>LINE Consents (Manual)</h2>
    <p class="muted">สำหรับทดสอบระบบเท่านั้น: ปรับสถานะให้ผู้ใช้สามารถส่งข้อความเข้ามาได้โดยไม่ต้องผ่านลิงก์ยินยอม</p>
  </div>

  <% if (feedback?.success) { %>
    <div class="alert success"><%= feedback.success %></div>
  <% } %>
  <% if (feedback?.error) { %>
    <div class="alert error"><%= feedback.error %></div>
  <% } %>

  <form class="form-inline" method="get" action="/admin/consents">
    <input class="input-lg" type="text" name="q" placeholder="ค้นหา userId หรือชื่อ" value="<%= search %>">
    <select class="input-md" name="status">
      <option value="" <%= statusFilter ? '' : 'selected' %>>ทุกสถานะ</option>
      <option value="granted" <%= statusFilter==='granted' ? 'selected' : '' %>>granted</option>
      <option value="pending" <%= statusFilter==='pending' ? 'selected' : '' %>>pending</option>
      <option value="revoked" <%= statusFilter==='revoked' ? 'selected' : '' %>>revoked</option>
    </select>
    <input class="input-sm" type="number" name="limit" value="<%= limit %>" min="10" max="500" step="10">
    <button class="btn primary" type="submit">ค้นหา</button>
    <a class="btn ghost" href="/admin/consents">ล้าง</a>
  </form>

  <div class="stats mt-3">
    <div class="stat">
      <div>granted</div>
      <strong><%= (summary && summary.granted) || 0 %></strong>
    </div>
    <div class="stat">
      <div>pending</div>
      <strong><%= (summary && summary.pending) || 0 %></strong>
    </div>
    <div class="stat">
      <div>revoked</div>
      <strong><%= (summary && summary.revoked) || 0 %></strong>
    </div>
  </div>
</div>

<div class="panel">
  <div class="panel-header panel__header">
    <h3>รายการยินยอม (<%= consents.length %> รายการ)</h3>
    <p class="muted">เลือกสถานะใหม่ กรอกหมายเหตุ (ถ้ามี) แล้วกดบันทึก</p>
  </div>

  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th class="w-220">ผู้ใช้</th>
          <th class="w-160">สถานะ</th>
          <th>ปรับสถานะ</th>
          <th class="w-260">ประวัติ</th>
        </tr>
      </thead>
      <tbody>
        <% if (!consents || consents.length === 0) { %>
          <tr>
            <td colspan="4" class="muted">ยังไม่มีข้อมูลความยินยอม</td>
          </tr>
        <% } %>
        <% (consents || []).forEach(function(consent){ %>
          <tr>
            <td>
              <strong><%= consent.displayName || '(ไม่มีชื่อ)' %></strong><br />
              <code><%= consent.userId %></code>
            </td>
            <td>
              <% const badgeClass = consent.status === 'granted' ? 'badge success' : (consent.status === 'pending' ? 'badge warn' : 'badge gray'); %>
              <span class="<%= badgeClass %>"><%= consent.status %></span>
              <div class="muted mt-2">
                อัปเดต: <%= consent.updatedAt ? new Date(consent.updatedAt).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }) : '-' %>
              </div>
              <div class="muted">
                ยินยอมล่าสุด: <%= consent.grantedAt ? new Date(consent.grantedAt).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }) : '-' %>
              </div>
            </td>
            <td>
              <form action="/admin/consents/update" method="post" class="consent-update">
                <input type="hidden" name="userId" value="<%= consent.userId %>">
                <input type="hidden" name="search" value="<%= search %>">
                <input type="hidden" name="statusFilter" value="<%= statusFilter %>">
                <input type="hidden" name="limit" value="<%= limit %>">

                <input type="text" name="displayName" placeholder="Display name (optional)" value="<%= consent.displayName || '' %>">

                <div class="actions">
                  <select class="input-md" name="status">
                    <option value="granted" <%= consent.status==='granted' ? 'selected' : '' %>>granted</option>
                    <option value="pending" <%= consent.status==='pending' ? 'selected' : '' %>>pending</option>
                    <option value="revoked" <%= consent.status==='revoked' ? 'selected' : '' %>>revoked</option>
                  </select>
                  <input class="input-md" type="text" name="note" placeholder="หมายเหตุ" />
                  <button class="btn primary small" type="submit">บันทึก</button>
                </div>
              </form>
            </td>
            <td>
              <% const history = (consent.history || []).slice(-5).reverse(); %>
              <% if (history.length === 0) { %>
                <span class="muted">ยังไม่มีประวัติ</span>
              <% } else { %>
                <ul class="clean text-sm">
                  <% history.forEach(function(item){ %>
                    <li>
                      <strong><%= item.status %></strong>
                      <span class="muted"> · <%= item.at ? new Date(item.at).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }) : '-' %></span>
                      <div class="muted">ช่องทาง: <%= item.channel || '-' %></div>
                      <% if (item.note) { %>
                        <div><%= item.note %></div>
                      <% } %>
                    </li>
                  <% }); %>
                </ul>
              <% } %>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
</div>
