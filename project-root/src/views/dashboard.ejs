<!-- project-root/src/views/dashboard.ejs -->
<% const fmtCount = (val) => Number(val || 0).toLocaleString('th-TH'); %>
<% const fmtTons = (val) => Number(val || 0).toLocaleString('th-TH', { minimumFractionDigits: 0, maximumFractionDigits: 2 }); %>
<% const fmtPercent = (ratio) => `${Math.round(Number(ratio || 0) * 100)}%`; %>
<% const fmtDate = (iso) => {
     if (!iso) return '-';
     const date = new Date(`${iso}T00:00:00+07:00`);
     if (Number.isNaN(date.getTime())) return iso;
     return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
   }; %>
<% const fmtDateTime = (value) => {
     if (!value) return '-';
     const date = new Date(value);
     if (Number.isNaN(date.getTime())) return value;
     return date.toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' });
   }; %>
<% const totalsData = (typeof totals === 'object' && totals) ? totals : { buyTons: 0, sellTons: 0, records: 0 }; %>
<% const providedDailySeries = (typeof dailySeries !== 'undefined') ? dailySeries : []; %>
<% const safeDailySeries = Array.isArray(providedDailySeries) ? providedDailySeries : []; %>
<% const providedTrendSeries = (typeof trendSeries !== 'undefined') ? trendSeries : []; %>
<% const safeTrendSeries = Array.isArray(providedTrendSeries) ? providedTrendSeries : []; %>
<% const providedLatestRecords = (typeof latestRecords !== 'undefined') ? latestRecords : []; %>
<% const safeLatestRecords = Array.isArray(providedLatestRecords) ? providedLatestRecords : []; %>
<% const providedCompanySummary = (typeof companySummary !== 'undefined') ? companySummary : []; %>
<% const safeCompanySummary = Array.isArray(providedCompanySummary) ? providedCompanySummary : []; %>
<% const providedProductChart = (typeof productChart !== 'undefined') ? productChart : []; %>
<% const safeProductChart = Array.isArray(providedProductChart) ? providedProductChart : []; %>
<% const providedMixSummary = (typeof mixSummary !== 'undefined') ? mixSummary : []; %>
<% const safeMixSummary = Array.isArray(providedMixSummary) ? providedMixSummary : []; %>
<% const providedProvinceMap = (typeof provinceMap !== 'undefined') ? provinceMap : []; %>
<% const safeProvinceMap = Array.isArray(providedProvinceMap) ? providedProvinceMap : []; %>
<% const providedChat = (typeof chat !== 'undefined' && chat) ? chat : { topicSummary: [], latestUsers: [] }; %>
<% const lastDaily = safeDailySeries.length ? safeDailySeries[safeDailySeries.length - 1] : null; %>
<% const buyToday = Number(lastDaily?.buyTons || 0); %>
<% const sellToday = Number(lastDaily?.sellTons || 0); %>
<% const entriesToday = Number(lastDaily?.entryCount || 0); %>
<% const inventoryBalance = Math.max(Number(totalsData.buyTons || 0) - Number(totalsData.sellTons || 0), 0); %>
<% const dailyWindow = safeDailySeries.length ? [...safeDailySeries].slice(-7).reverse() : []; %>
<% const recentRecords = safeLatestRecords.slice(0, 8); %>
<% const topCompanies = safeCompanySummary.slice(0, 6); %>
<% const topProducts = safeProductChart.slice(0, 6); %>
<% const topMix = safeMixSummary.slice(0, 6); %>
<% const provinceLeaders = safeProvinceMap.slice(0, 6); %>
<% const chatTopics = Array.isArray(providedChat.topicSummary) ? providedChat.topicSummary.slice(0, 5) : []; %>
<% const latestLineUsers = Array.isArray(providedChat.latestUsers) ? providedChat.latestUsers.slice(0, 5) : []; %>
<% const chatStats = (typeof chatUserStats === 'object' && chatUserStats) ? chatUserStats : { active7d: 0, new7d: 0, returning7d: 0, active30d: 0, totalUsers: 0, messages7d: 0, messagesTotal: 0 }; %>
<% const summaryTimestamp = new Date().toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' }); %>
<% const provinceStats = (typeof provinceMapStats === 'object' && provinceMapStats) ? provinceMapStats : {}; %>
<% const focusAreas = [
  { label: 'On-time Delivery', ratio: provinceStats?.onTimeRate ?? 0.72 },
  { label: 'Invoice Accuracy', ratio: provinceStats?.accuracyRate ?? 0.63 },
  { label: 'Customer Satisfaction', ratio: (chatStats?.satisfactionRate ?? 0.81) },
  { label: 'Open Issues Resolved', ratio: provinceStats?.issueCloseRate ?? 0.58 },
]; %>
<% const meetings = [
  { title: 'Daily Logistics Sync', date: 'Tue, 16 Jul', time: '08:30', channel: 'Zoom', href: '#daily-sync' },
  { title: 'Vendor Check-in', date: 'Tue, 16 Jul', time: '11:00', channel: 'Google Meet', href: '#vendor-call' },
  { title: 'PR Approval Board', date: 'Tue, 16 Jul', time: '15:30', channel: 'Teams', href: '#pr-board' },
  { title: 'Customer Insight Review', date: 'Wed, 17 Jul', time: '09:00', channel: 'Zoom', href: '#insight-review' },
]; %>
<% const quickActions = [
  { label: 'Upload Orders', description: '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', href: '/admin/upload', icon: '‚§¥Ô∏è' },
  { label: 'Send Daily Summary', description: '‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏´‡∏≤ LINE ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', href: '/admin/tools/send-daily', icon: 'üí¨' },
  { label: 'Manage Members', description: '‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó', href: '/admin/members', icon: 'üë•' },
  { label: 'Rich Menu Studio', description: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡∏∞ CTA', href: '/admin/richmenu', icon: 'üß≠' },
]; %>
<% const subPage = typeof locals.subPage === 'string' ? locals.subPage : 'overview'; %>
<% const isOverview = subPage === 'overview'; %>
<% const isEngagement = subPage === 'engagement'; %>
<% const isControl = subPage === 'control'; %>
<% const heroTitle = isOverview
    ? `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö, ${(locals.user && (locals.user.fullName || locals.user.displayName || locals.user.username)) || '‡∏ó‡∏µ‡∏° Sorrni'}`
    : (isEngagement
      ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'
      : 'Command Center ¬∑ ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°'); %>
<% const heroSubtitle = isEngagement
    ? '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° LINE, ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'
    : (isControl
      ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'
      : null); %>
<% const heroPrimaryHref = isControl ? '#control-center' : '/admin/upload'; %>
<% const heroPrimaryLabel = isControl ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°' : '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; %>

<div class="dashboard-shell">
  <nav class="dashboard-quicknav" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏±‡∏î‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î">
    <div class="dashboard-quicknav__brand">
      <img src="/static/img/sorni.png" alt="Sorrni" class="dashboard-quicknav__logo" />
      <strong class="dashboard-quicknav__title">SORRNI CONTROL</strong>
      <span>Unified Ops &amp; CDP</span>
    </div>
    <div class="dashboard-quicknav__meta">
      <span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
      <strong><%= summaryTimestamp %></strong>
    </div>
    <ul class="dashboard-quicknav__list">
      <li><a href="/admin" class="<%= isOverview ? 'is-active' : '' %>" <%= isOverview ? 'aria-current="true"' : '' %>>‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å</a></li>
      <li><a href="/admin/dashboard/engagement" class="<%= isEngagement ? 'is-active' : '' %>" <%= isEngagement ? 'aria-current="true"' : '' %>>‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a></li>
      <li><a href="/admin/dashboard/control" class="<%= isControl ? 'is-active' : '' %>" <%= isControl ? 'aria-current="true"' : '' %>>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</a></li>
    </ul>
    <div class="dashboard-quicknav__cta">
      <a class="btn secondary btn-block" href="/admin/tools/send-daily">‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</a>
    </div>
  </nav>

  <div class="dashboard-canvas">
  <main class="dashboard-main">
    <header class="dash-hero">
      <div class="dash-hero__intro">
        <span class="dash-pill">Sorrni Workspace</span>
        <h1><%= heroTitle %></h1>
        <p>
          <% if (isOverview) { %>
            ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠ <strong><%= summaryTimestamp %></strong>
          <% } else { %>
            <%= heroSubtitle %>
          <% } %>
        </p>
      </div>
      <div class="dash-hero__actions <%= isControl ? 'dash-hero__actions--compact' : '' %>">
        <% if (!isControl) { %>
          <div class="dash-search">
            <span aria-hidden="true">üîç</span>
            <input type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" />
          </div>
        <% } %>
        <a class="btn primary" href="<%= heroPrimaryHref %>"><%= heroPrimaryLabel %></a>
      </div>
    </header>

    <nav class="dashboard-subnav" aria-label="‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î">
      <a href="/admin" class="dashboard-subnav__item <%= isOverview ? 'is-active' : '' %>" <%= isOverview ? 'aria-current="true"' : '' %>>‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å</a>
      <a href="/admin/dashboard/engagement" class="dashboard-subnav__item <%= isEngagement ? 'is-active' : '' %>" <%= isEngagement ? 'aria-current="true"' : '' %>>‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a>
      <a href="/admin/dashboard/control" class="dashboard-subnav__item <%= isControl ? 'is-active' : '' %>" <%= isControl ? 'aria-current="true"' : '' %>>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</a>
    </nav>

    <% if (isOverview) { %>
    <section class="section-block" id="ops-intel">
      <header class="section-header">
        <div class="section-header__titles">
          <span class="section-pill">Operations</span>
          <h2>Operational Intelligence</h2>
          <p class="muted">‡∏°‡∏≠‡∏ô‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
        </div>
        <div class="section-header__actions">
          <span class="section-chip">Realtime</span>
          <span class="section-chip">Sync: <%= summaryTimestamp %></span>
        </div>
      </header>
      <div class="section-body">
        <div class="ops-overview">
          <article class="highlight-card gradient gradient--ocean">
            <header>
              <h3>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)</h3>
              <span>‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏∞‡∏™‡∏° - ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°</span>
            </header>
            <div class="highlight-value"><%= fmtTons(inventoryBalance) %><small> ‡∏ï‡∏±‡∏ô</small></div>
            <p>‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏∞‡∏™‡∏° <strong><%= fmtTons(totalsData.buyTons || 0) %></strong> ‡∏ï‡∏±‡∏ô ‚Ä¢ ‡∏Ç‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏° <strong><%= fmtTons(totalsData.sellTons || 0) %></strong> ‡∏ï‡∏±‡∏ô</p>
          </article>
          <article class="highlight-card gradient gradient--sunset">
            <header>
              <h3>‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
              <span>BUY (‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)</span>
            </header>
            <div class="highlight-value"><%= fmtTons(buyToday) %><small> ‡∏ï‡∏±‡∏ô</small></div>
            <p>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <strong><%= entriesToday ? fmtTons(buyToday / Math.max(entriesToday, 1)) : '0' %></strong> ‡∏ï‡∏±‡∏ô</p>
          </article>
          <article class="highlight-card gradient gradient--lavender">
            <header>
              <h3>‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
              <span>SELL (‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)</span>
            </header>
            <div class="highlight-value"><%= fmtTons(sellToday) %><small> ‡∏ï‡∏±‡∏ô</small></div>
            <p>Net Today <strong><%= fmtTons(buyToday - sellToday) %></strong> ‡∏ï‡∏±‡∏ô</p>
          </article>
          <article class="highlight-card gradient">
            <header>
              <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
              <span>‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
            </header>
            <div class="highlight-value"><%= fmtCount(entriesToday) %><small> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</small></div>
            <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong><%= fmtCount(totalsData.records || 0) %></strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
          </article>
        </div>

        <div class="ops-grid">
      <article class="panel card ops-table">
        <header class="panel__header">
          <div>
            <h2>‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å 7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</h2>
            <p class="muted">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏¢‡∏≠‡∏î‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ - ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</p>
          </div>
        </header>
        <div class="table-wrap">
          <table class="table small">
            <thead>
              <tr>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th class="text-right">‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏ï‡∏±‡∏ô)</th>
                <th class="text-right">‡∏≠‡∏≠‡∏Å (‡∏ï‡∏±‡∏ô)</th>
                <th class="text-right">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                <th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              </tr>
            </thead>
            <tbody>
              <% if (dailyWindow.length) { %>
                <% dailyWindow.forEach((row) => { %>
                  <% const net = Number(row.buyTons || 0) - Number(row.sellTons || 0); %>
                  <tr>
                    <td><%= fmtDate(row.date) %></td>
                    <td class="text-right"><%= fmtTons(row.buyTons) %></td>
                    <td class="text-right"><%= fmtTons(row.sellTons) %></td>
                    <td class="text-right <%= net >= 0 ? 'text-success' : 'text-danger' %>"><%= fmtTons(net) %></td>
                    <td class="text-right"><%= fmtCount(row.entryCount) %></td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr><td colspan="5" class="text-center muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</td></tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </article>

      <article class="panel card ops-recent">
        <header class="panel__header">
          <div>
            <h2>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
            <p class="muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å 8 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
          </div>
          <a class="btn ghost small" href="/admin/records">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
        </header>
        <ul class="record-list">
          <% if (recentRecords.length) { %>
            <% recentRecords.forEach((item) => { %>
              <% const type = String(item.type || '').toUpperCase(); %>
              <li class="record-item">
                <div class="record-item__icon <%= type === 'BUY' ? 'is-inbound' : 'is-outbound' %>">
                  <%= type === 'BUY' ? '‚¨á' : '‚¨Ü' %>
                </div>
                <div class="record-item__body">
                  <strong><%= item.product || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)' %></strong>
                  <span class="muted">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: <%= item.companyId?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' %></span>
                </div>
                <div class="record-item__meta">
                  <span class="record-weight"><%= fmtTons(item.weightTons || item.weight || 0) %> ‡∏ï‡∏±‡∏ô</span>
                  <span class="muted"><%= fmtDateTime(item.createdAt || item.dateStr) %></span>
                </div>
              </li>
            <% }) %>
          <% } else { %>
            <li class="record-item is-empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</li>
          <% } %>
        </ul>
      </article>
    </div>

        <div class="dash-panel-grid">
      <article class="panel card company-card">
        <header class="panel__header">
          <div>
            <h2>Top Companies</h2>
            <p class="muted">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p>
          </div>
        </header>
        <ul class="company-list">
          <% if (topCompanies.length) { %>
            <% const leader = topCompanies[0]?.totalTons || 1; %>
            <% topCompanies.forEach((company, idx) => { %>
              <li>
                <div class="company-rank"><%= idx + 1 %></div>
                <div class="company-info">
                  <strong><%= company.name %></strong>
                  <span><%= fmtTons(company.totalTons) %> ‡∏ï‡∏±‡∏ô ‚Ä¢ <%= fmtCount(company.entryCount) %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                  <div class="progress-track">
                    <span style="width: <%= Math.min(100, (company.totalTons || 0) / leader * 100) %>%"></span>
                  </div>
                </div>
              </li>
            <% }) %>
          <% } else { %>
            <li class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</li>
          <% } %>
        </ul>
      </article>

      <article class="panel card product-card">
        <header class="panel__header">
          <div>
            <h2>Top Products</h2>
            <p class="muted">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p>
          </div>
        </header>
        <ul class="product-list">
          <% if (topProducts.length) { %>
            <% const leader = topProducts[0]?.totalTons || 1; %>
            <% topProducts.forEach((product, idx) => { %>
              <li>
                <span class="product-index"><%= idx + 1 %></span>
                <div class="product-meta">
                  <strong><%= product.product %></strong>
                  <span><%= fmtTons(product.totalTons) %> ‡∏ï‡∏±‡∏ô ‚Ä¢ <%= fmtCount(product.entryCount) %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                  <div class="progress-track">
                    <span style="width: <%= Math.min(100, (product.totalTons || 0) / leader * 100) %>%"></span>
                  </div>
                </div>
              </li>
            <% }) %>
          <% } else { %>
            <li class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</li>
          <% } %>
        </ul>
      </article>
        </div>
      </div>
    </section>
    <% } %>

    <% if (isEngagement) { %>
    <section class="section-block" id="cdp-intel">
      <header class="section-header">
        <div class="section-header__titles">
          <span class="section-pill section-pill--cdp">Customer &amp; CDP</span>
          <h2>Engagement &amp; Behaviour</h2>
          <p class="muted">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏≤‡∏£‡∏ú‡∏™‡∏°‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ü‡∏Å‡∏±‡∏™</p>
        </div>
        <div class="section-header__actions">
          <span class="section-chip">Active 7 ‡∏ß‡∏±‡∏ô <%= fmtCount(chatStats.active7d) %></span>
          <span class="section-chip">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° 7 ‡∏ß‡∏±‡∏ô <%= fmtCount(chatStats.messages7d) %></span>
        </div>
      </header>
      <div class="section-body">
        <div class="dash-panel-grid">
          <article class="panel card chart-card insight-chart" data-chart-trend='<%- JSON.stringify(safeTrendSeries.slice(-14)) %>'>
            <header class="panel__header">
              <div>
                <h2>LINE Interaction Trend</h2>
                <p class="muted">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô</p>
              </div>
            </header>
            <div class="chart-frame chart-card__body">
              <canvas id="chat-trend-chart" height="240"></canvas>
            </div>
          </article>

          <article class="panel card mix-card">
            <header class="panel__header">
              <div>
                <h2>Mix Projects</h2>
                <p class="muted">‡∏á‡∏≤‡∏ô‡∏ú‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p>
              </div>
            </header>
            <ul class="mix-list">
              <% if (topMix.length) { %>
                <% topMix.forEach((mix) => { %>
                  <li>
                    <div>
                      <strong><%= mix.projectName || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)' %></strong>
                      <span class="muted"><%= mix.projectCode || '-' %> ‚Ä¢ <%= mix.mixName || '-' %></span>
                    </div>
                    <div class="mix-meta">
                      <strong><%= fmtTons(mix.totalNetWeightTons) %> ‡∏ï‡∏±‡∏ô</strong>
                      <span class="muted"><%= fmtCount(mix.entryCount) %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ <%= fmtCount(mix.dayCount || 0) %> ‡∏ß‡∏±‡∏ô</span>
                    </div>
                  </li>
                <% }) %>
              <% } else { %>
                <li class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mix</li>
              <% } %>
            </ul>
          </article>
        </div>

        <div class="dash-panel-grid">
      <article class="panel card province-card">
        <header class="panel__header">
          <div>
            <h2>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h2>
            <p class="muted">‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î</p>
          </div>
        </header>
        <ul class="province-list">
          <% if (provinceLeaders.length) { %>
            <% const leader = provinceLeaders[0]?.count || 1; %>
            <% provinceLeaders.forEach((province, idx) => { %>
              <li>
                <span class="province-rank"><%= idx + 1 %></span>
                <div class="province-meta">
                  <strong><%= province.province %></strong>
                  <span><%= fmtCount(province.count) %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
                <div class="province-bar">
                  <span style="width: <%= Math.min(100, (province.count || 0) / leader * 100) %>%"></span>
                </div>
              </li>
            <% }) %>
          <% } else { %>
            <li class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</li>
          <% } %>
        </ul>
      </article>

      <article class="panel card performance-card">
        <header class="panel__header">
          <div>
            <h2>Performance Pulse</h2>
            <p class="muted">‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</p>
          </div>
        </header>
        <ul class="progress-list">
          <li>
            <div>
              <strong>‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ</strong>
              <span><%= fmtCount(provinceStats.provincesWithCoords || 0) %> ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</span>
            </div>
            <div class="progress-track">
              <span style="width: <%= provinceStats.totalProvinces ? (provinceStats.provincesWithCoords || 0) / provinceStats.totalProvinces * 100 : 0 %>%"></span>
            </div>
          </li>
          <li>
            <div>
              <strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Location ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</strong>
              <span><%= fmtCount(provinceStats.totalLocations || 0) %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
            <div class="progress-track">
              <span style="width: <%= Math.min(100, (provinceStats.totalLocations || 0) / 50 * 100) %>%"></span>
            </div>
          </li>
          <% focusAreas.forEach((item) => { %>
            <li>
              <div>
                <strong><%= item.label %></strong>
                <span><%= fmtPercent(item.ratio) %></span>
              </div>
              <div class="progress-track">
                <span style="width: <%= Math.min(100, Number(item.ratio || 0) * 100) %>%"></span>
              </div>
            </li>
          <% }) %>
        </ul>
      </article>
        </div>
      </div>
    </section>
    <% } %>

    <% if (isControl) { %>
    <section class="section-block" id="control-center">
      <header class="section-header">
        <div class="section-header__titles">
          <span class="section-pill">Control</span>
          <h2>Command Center</h2>
          <p class="muted">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
        </div>
      </header>
      <div class="section-body">
        <article class="panel card profile-card">
          <div class="profile-card__avatar">
            <img src="/static/img/sorni.png" alt="Sorrni" />
          </div>
          <div class="profile-card__meta">
            <h2>Sorrni Control Center</h2>
            <p>‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
          </div>
          <dl class="profile-stats">
            <div>
              <dt>‡πÑ‡∏ü‡∏•‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</dt>
              <dd><%= fmtCount(safeLatestRecords.length || 0) %></dd>
            </div>
            <div>
              <dt>‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</dt>
              <dd><%= fmtTons(buyToday + sellToday) %></dd>
            </div>
            <div>
              <dt>Location Map</dt>
              <dd><%= fmtCount(provinceStats.totalProvinces || 0) %></dd>
            </div>
          </dl>
        </article>

        <article class="panel card meetings-card">
          <header class="panel__header">
            <div>
              <h2>Today‚Äôs Meetings</h2>
              <p class="muted">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</p>
            </div>
          </header>
          <ul class="meetings-list">
            <% meetings.forEach((meeting) => { %>
              <li>
                <div>
                  <strong><%= meeting.title %></strong>
                  <span><%= meeting.date %> ¬∑ <%= meeting.time %> ¬∑ <%= meeting.channel %></span>
                </div>
                <a href="<%= meeting.href %>" class="btn ghost small">Join</a>
              </li>
            <% }) %>
          </ul>
        </article>

        <article class="panel card quick-actions">
          <header class="panel__header">
            <div>
              <h2>Quick Actions</h2>
              <p class="muted">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥ ‡πÜ ‡πÉ‡∏ô‡πÑ‡∏°‡πà‡∏Å‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å</p>
            </div>
          </header>
          <div class="quick-actions__grid">
            <% quickActions.forEach((action) => { %>
              <a href="<%= action.href %>" class="quick-action">
                <span class="quick-action__icon"><%= action.icon %></span>
                <span class="quick-action__label"><%= action.label %></span>
                <span class="quick-action__desc"><%= action.description %></span>
              </a>
            <% }) %>
          </div>
        </article>
      </div>
    </section>

    <section class="section-block" id="cdp-pulse">
      <header class="section-header">
        <div class="section-header__titles">
          <span class="section-pill section-pill--cdp">CDP</span>
          <h2>LINE Activity Highlights</h2>
          <p class="muted">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å LINE Official Account</p>
        </div>
      </header>
      <div class="section-body">
        <article class="panel card chat-card">
          <header class="panel__header">
            <div>
              <h2>LINE Activity</h2>
              <p class="muted">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á LINE Official</p>
            </div>
          </header>
          <div class="chat-metrics">
            <div>
              <span>Active 7 ‡∏ß‡∏±‡∏ô</span>
              <strong><%= fmtCount(chatStats.active7d) %></strong>
            </div>
            <div>
              <span>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà 7 ‡∏ß‡∏±‡∏ô</span>
              <strong><%= fmtCount(chatStats.new7d) %></strong>
            </div>
            <div>
              <span>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° 7 ‡∏ß‡∏±‡∏ô</span>
              <strong><%= fmtCount(chatStats.messages7d) %></strong>
            </div>
            <div>
              <span>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏°</span>
              <strong><%= fmtCount(chatStats.messagesTotal) %></strong>
            </div>
          </div>
          <div class="topic-list">
            <h3>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h3>
            <ul>
              <% if (chatTopics.length) { %>
                <% chatTopics.forEach((topic) => { %>
                  <li>
                    <strong><%= topic.label %></strong>
                    <span><%= fmtCount(topic.count) %> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
                  </li>
                <% }) %>
              <% } else { %>
                <li class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</li>
              <% } %>
            </ul>
          </div>
          <div class="latest-users">
            <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            <ul>
              <% if (latestLineUsers.length) { %>
                <% latestLineUsers.forEach((user) => { %>
                  <li>
                    <strong><%= user.displayName || user.userId %></strong>
                    <span class="muted"><%= user.status || 'unknown' %></span>
                  </li>
                <% }) %>
              <% } else { %>
                <li class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</li>
              <% } %>
            </ul>
          </div>
        </article>
      </div>
    </section>
    <% } %>
  </main>
</div>
</div>
