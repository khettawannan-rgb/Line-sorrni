<!-- project-root/src/views/dashboard.ejs -->
<% const fmtCount = (val) => Number(val || 0).toLocaleString('th-TH'); %>
<% const fmtTons = (val, opts = {}) => Number(val || 0).toLocaleString('th-TH', { minimumFractionDigits: opts.min ?? 0, maximumFractionDigits: opts.max ?? 2 }); %>
<% const isLitreProduct = (name = '', unit = '') => /‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ï‡∏≤/i.test(String(name)) || /‡∏•‡∏¥‡∏ï‡∏£/.test(String(unit)); %>
<% const formatQuantity = (name, unit, tons) => {
     const liter = isLitreProduct(name, unit);
     const value = liter ? Number(tons || 0) * 1000 : Number(tons || 0);
     const decimals = liter ? 0 : 2;
     return {
       value,
       unit: liter ? '‡∏•‡∏¥‡∏ï‡∏£' : '‡∏ï‡∏±‡∏ô',
       formatted: Number(value || 0).toLocaleString('th-TH', {
         minimumFractionDigits: 0,
         maximumFractionDigits: decimals,
       }),
     };
   }; %>
<% const summaryTimestamp = new Date().toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' }); %>
<% const provinceDataJSON = JSON.stringify(provinceMap || []); %>
<% const provinceTopList = Array.isArray(provinceMapTop) ? provinceMapTop : []; %>
<% const provinceStats = provinceMapStats || { totalLocations: 0, uniqueUsers: 0, totalProvinces: 0, provincesWithCoords: 0, lastUpdatedAt: null }; %>
<% const hasProvinceCoords = Number(provinceStats.provincesWithCoords || 0) > 0; %>
<% const chatStats = chatUserStats || { active7d: 0, new7d: 0, returning7d: 0, active30d: 0, totalUsers: 0, messages7d: 0, messagesTotal: 0 }; %>
<% const consentTotals = consentStatusSummary || {}; %>
<% const chatTrendJSON = JSON.stringify(chatTrend || []); %>
<% const chatTopicTopJSON = JSON.stringify((chat.topicSummary || []).slice(0, 5)); %>
<% const consentStatusJSON = JSON.stringify(consentTotals); %>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-sA+e2jXUgXu3kGEXHOIa0GpCCMbnYIY01tZ5JfL0z0k="
  crossorigin="" />
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j7kC3U1JzDvsPWVn0AqfZbG9JQIvIDi64tT0+3s="
  crossorigin=""></script>

<div class="dashboard-shell dashboard-light">
  <aside class="dashboard-sidebar">
    <div class="sidebar-brand">
      <div class="sidebar-logo">
        <img src="/static/img/sorni.png" alt="Sorni" />
      </div>
      <span class="sidebar-title">Sorni</span>
    </div>
    <nav class="sidebar-nav">
      <a href="#overview" class="active">
        <span class="icon">üè†</span>
        <span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span>
      </a>
      <a href="#excel">
        <span class="icon">üì¶</span>
        <span>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
      </a>
      <a href="#companies">
        <span class="icon">üè¢</span>
        <span>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</span>
      </a>
      <a href="#customer-insights">
        <span class="icon">üí¨</span>
        <span>‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
      </a>
      <a href="#tools">
        <span class="icon">üõ†Ô∏è</span>
        <span>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</span>
      </a>
    </nav>
    <div class="sidebar-meta">
      <span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
      <strong><%= summaryTimestamp %></strong>
    </div>
    <div class="sidebar-footer">
      <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
    </div>
  </aside>

  <div class="dashboard-main">
    <header class="dashboard-top" id="overview">
      <div>
        <h1>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h1>
        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ</p>
      </div>
      <div class="top-actions">
        <div class="top-search">
          <span class="icon">üîç</span>
          <input type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" />
        </div>
        <button class="btn btn-pill">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
      </div>
    </header>

    <section class="panel-block panel-insights" id="customer-insights">
      <div class="panel-heading">
        <div>
          <h2>Customer Insights</h2>
          <p>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å LINE Official Account</p>
        </div>
        <div class="insight-meta">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 14 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
      </div>
      <div class="panel-body insight-body">
        <div class="insight-metrics">
          <article class="metric-card primary">
            <span class="metric-label">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ Active (7 ‡∏ß‡∏±‡∏ô)</span>
            <div class="metric-value"><%= fmtCount(chatStats.active7d) %><span>‡∏Ñ‡∏ô</span></div>
            <span class="metric-sub">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <%= fmtCount(chatStats.totalUsers) %> ‡∏Ñ‡∏ô</span>
          </article>
          <article class="metric-card">
            <span class="metric-label">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà (7 ‡∏ß‡∏±‡∏ô)</span>
            <div class="metric-value"><%= fmtCount(chatStats.new7d) %><span>‡∏Ñ‡∏ô</span></div>
            <span class="metric-sub"><%= chatStats.active7d ? ((chatStats.new7d / Math.max(chatStats.active7d, 1)) * 100).toFixed(1) : '0.0' %>% ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà active</span>
          </article>
          <article class="metric-card">
            <span class="metric-label">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤</span>
            <div class="metric-value"><%= fmtCount(chatStats.returning7d) %><span>‡∏Ñ‡∏ô</span></div>
            <span class="metric-sub">‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô</span>
          </article>
          <article class="metric-card">
            <span class="metric-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (7 ‡∏ß‡∏±‡∏ô)</span>
            <div class="metric-value"><%= fmtCount(chatStats.messages7d) %><span>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span></div>
            <span class="metric-sub">‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <%= fmtCount(chatStats.messagesTotal) %> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
          </article>
        </div>

        <div class="insight-chart-grid">
          <div class="card glass insight-chart" data-chart-trend='<%- chatTrendJSON %>'>
            <div class="card-heading">
              <h3>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° &amp; ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (14 ‡∏ß‡∏±‡∏ô)</h3>
            </div>
            <div class="chart-frame">
              <canvas id="chat-trend-chart" height="240"></canvas>
            </div>
          </div>
          <div class="card glass insight-chart" data-consent-status='<%- consentStatusJSON %>'>
            <div class="card-heading">
              <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°</h3>
              <span class="muted">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <%= fmtCount(consentTotals.total || 0) %> ‡∏Ñ‡∏ô</span>
            </div>
            <div class="chart-frame">
              <canvas id="consent-status-chart" height="240"></canvas>
            </div>
          </div>
          <div class="card glass insight-chart" data-topic-payload='<%- chatTopicTopJSON %>'>
            <div class="card-heading">
              <h3>Top ‡∏´‡∏°‡∏ß‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h3>
              <span class="muted">‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <%= fmtCount(chat.recentCount) %> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
            </div>
            <div class="chart-frame">
              <canvas id="topic-bar-chart" height="240"></canvas>
            </div>
          </div>
        </div>

        <div class="insight-table-grid">
          <div class="card glass">
            <div class="card-heading">
              <h3>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h3>
            </div>
            <div class="table-scroll">
              <table class="table compact ghost">
                <thead>
                  <tr>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  </tr>
                </thead>
                <tbody>
                  <% const msgKeys = Object.keys(chat.messageTypeCount || {}); %>
                  <% msgKeys.forEach(key => { %>
                    <tr>
                      <td><%= key %></td>
                      <td class="right"><%= fmtCount(chat.messageTypeCount[key]) %></td>
                    </tr>
                  <% }) %>
                  <% if (!msgKeys.length) { %>
                    <tr><td colspan="2" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ä‡∏ó</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card glass">
            <div class="card-heading">
              <h3>‡∏´‡∏°‡∏ß‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î</h3>
            </div>
            <div class="table-scroll">
              <table class="table compact ghost">
                <thead>
                  <tr>
                    <th>‡∏´‡∏°‡∏ß‡∏î</th>
                    <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</th>
                  </tr>
                </thead>
                <tbody>
                  <% (chat.topicSummary || []).forEach(item => { %>
                    <tr>
                      <td><strong><%= item.label %></strong></td>
                      <td class="right"><%= fmtCount(item.count) %></td>
                      <td>
                        <% (item.samples || []).forEach(sample => { %>
                          <div class="muted">‚Ä¢ <%= sample %></div>
                        <% }) %>
                      </td>
                    </tr>
                  <% }) %>
                  <% if (!chat.topicSummary || chat.topicSummary.length === 0) { %>
                    <tr><td colspan="3" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card glass">
            <div class="card-heading">
              <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            </div>
            <div class="table-scroll">
              <table class="table compact ghost">
                <thead>
                  <tr>
                    <th>Display Name</th>
                    <th>userId</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                  </tr>
                </thead>
                <tbody>
                  <% (chat.latestUsers || []).forEach(u => { %>
                    <tr>
                      <td><strong><%= u.displayName %></strong></td>
                      <td><code><%= u.userId %></code></td>
                      <td>
                        <% if (u.status === 'granted') { %>
                          <span class="badge success">granted</span>
                        <% } else if (u.status === 'pending') { %>
                          <span class="badge warn">pending</span>
                        <% } else { %>
                          <span class="badge gray"><%= u.status %></span>
                        <% } %>
                      </td>
                      <td><%= u.updatedAt ? new Date(u.updatedAt).toLocaleString('th-TH') : '-' %></td>
                    </tr>
                  <% }) %>
                  <% if (!chat.latestUsers || chat.latestUsers.length === 0) { %>
                    <tr><td colspan="4" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="summary-cards">
      <article class="summary-card">
        <div class="summary-label">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏°</div>
        <div class="summary-value"><%= fmtTons(totals.totalTons, { max: 2 }) %><small>‡∏ï‡∏±‡∏ô</small></div>
        <span class="summary-foot">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</span>
      </article>
      <article class="summary-card">
        <div class="summary-label">BUY</div>
        <div class="summary-value"><%= fmtTons(totals.buyTons) %><small>‡∏ï‡∏±‡∏ô</small></div>
        <span class="summary-foot"><%= totals.totalTons ? ((totals.buyTons / totals.totalTons) * 100).toFixed(1) : 0 %>% ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
      </article>
      <article class="summary-card">
        <div class="summary-label">SELL</div>
        <div class="summary-value"><%= fmtTons(totals.sellTons) %><small>‡∏ï‡∏±‡∏ô</small></div>
        <span class="summary-foot"><%= totals.totalTons ? ((totals.sellTons / totals.totalTons) * 100).toFixed(1) : 0 %>% ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
      </article>
      <article class="summary-card">
        <div class="summary-label">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ LINE</div>
        <div class="summary-value"><%= fmtCount(chat.distinctUsers) %><small>‡∏Ñ‡∏ô</small></div>
        <span class="summary-foot"><%= fmtCount(chat.recentCount) %> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
      </article>
    </section>

    <section class="panel-block" id="map-overview">
      <div
        class="dashboard-map-card"
        data-province-map
        data-map-payload='<%- provinceDataJSON %>'
        data-mapbox-token="<%= mapboxToken || '' %>">
        <div class="map-card-header">
          <span class="tag">Real-time map</span>
          <h3>‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</h3>
          <p>‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <strong><%= fmtCount(provinceStats.totalLocations) %></strong> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
        </div>
        <div class="map-card-body">
          <div class="map-card-figure <%= hasProvinceCoords ? 'has-data' : '' %>">
            <div class="map-placeholder">
              <img src="/static/img/Locations.png" alt="Locations illustration" />
            </div>
            <div class="province-map" data-map-canvas></div>
            <% if (hasProvinceCoords) { %>
              <div class="map-overlay">
                <div>
                  <span>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                  <strong><%= fmtCount(provinceStats.totalLocations) %></strong>
                </div>
                <div>
                  <span>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</span>
                  <strong><%= fmtCount(provinceStats.provincesWithCoords) %></strong>
                </div>
              </div>
            <% } %>
            <% if (!hasProvinceCoords) { %>
              <div class="map-empty">
                <div class="map-empty__icon">üõ∞Ô∏è</div>
                <div class="map-empty__text">
                  <strong>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î</strong>
                  <span>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ä‡∏£‡πå location ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span>
                  <small>Tip: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‚Äú‡πÅ‡∏ä‡∏£‡πå‡∏û‡∏¥‡∏Å‡∏±‡∏î‚Äù ‡πÉ‡∏ô LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö</small>
                </div>
              </div>
            <% } %>
          </div>
          <aside class="map-card-sidebar">
            <div class="map-stat">
              <span>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
              <strong><%= fmtCount(provinceStats.uniqueUsers) %></strong>
            </div>
            <div class="map-stat">
              <span>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
              <strong><%= fmtCount(provinceStats.provincesWithCoords) %></strong>
              <small>‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <%= fmtCount(provinceStats.totalProvinces) %></small>
            </div>
            <ul class="map-top-list">
              <% if (provinceTopList.length) { %>
                <% provinceTopList.forEach(function(item, idx){
                     const provinceName = (item.province || '').replace(/^‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î\s*/, '');
                %>
                  <li>
                    <span class="rank"><%= idx + 1 %></span>
                    <div>
                      <strong><%= provinceName || item.province %></strong>
                      <small><%= fmtCount(item.count) %> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</small>
                    </div>
                  </li>
                <% }) %>
              <% } else { %>
                <li class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</li>
              <% } %>
            </ul>
            <% if (provinceStats.lastUpdatedAt) { %>
              <span class="map-updated">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <%= new Date(provinceStats.lastUpdatedAt).toLocaleString('th-TH') %></span>
            <% } %>
          </aside>
        </div>
      </div>
    </section>

    <section class="panel-block" id="excel">
      <div class="panel-heading">
        <div>
          <h2>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
          <p>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
        </div>
      </div>
      <div class="panel-body grid-2 gap-xl">
        <div class="card glass donut-card">
          <div class="card-heading">
            <h3>Top ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <span class="muted">‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 8 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
          </div>
          <div class="donut-layout">
            <div class="donut-wrap" data-chart="product" data-chart-payload='<%- JSON.stringify(productChart || []) %>' data-chart-total="<%= productChartTotal %>">
              <canvas width="260" height="260"></canvas>
              <div class="donut-total">
                <span>‡∏£‡∏ß‡∏°</span>
                <strong><%= fmtTons(productChartTotal, { min: 0, max: 0 }) %></strong>
                <small>‡∏ï‡∏±‡∏ô</small>
              </div>
            </div>
            <div class="donut-legend">
              <% if (productChart && productChart.length) { %>
                <ul>
                  <% (productChart || []).forEach((item, idx) => { %>
                    <% const percent = productChartTotal ? Math.round((item.totalTons / productChartTotal) * 10000) / 100 : 0; %>
                    <% const qty = formatQuantity(item.product, '', item.totalTons); %>
                    <li>
                      <span class="donut-legend__dot" data-color-index="<%= idx %>"></span>
                      <div>
                        <strong><%= item.product %></strong>
                        <span><%= qty.formatted %> <span class="muted"><%= qty.unit %></span> ¬∑ <%= percent.toFixed(1) %>%</span>
                      </div>
                    </li>
                  <% }) %>
                </ul>
              <% } else { %>
                <p class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
              <% } %>
            </div>
          </div>
        </div>
        <div class="card glass">
          <div class="card-heading">
            <h3>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° 7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</h3>
            <span class="muted">‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</span>
          </div>
          <div class="table-scroll">
            <table class="table compact ghost">
              <thead>
                <tr>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th class="right">‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ô</th>
                  <th class="right">BUY</th>
                  <th class="right">SELL</th>
                  <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß</th>
                </tr>
              </thead>
              <tbody>
                <% (dailySeries || []).forEach(day => { %>
                  <tr>
                    <td><strong><%= day.date %></strong></td>
                    <td class="right"><%= fmtTons(day.totalTons) %></td>
                    <td class="right"><%= fmtTons(day.buyTons) %></td>
                    <td class="right"><%= fmtTons(day.sellTons) %></td>
                    <td class="right"><%= fmtCount(day.entryCount) %></td>
                  </tr>
                <% }) %>
                <% if (!dailySeries || dailySeries.length === 0) { %>
                  <tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</td></tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="panel-body">
        <div class="card glass">
          <div class="card-heading">
            <h3>‡∏™‡∏£‡∏∏‡∏õ MIX ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h3>
            <span class="muted">‡∏£‡∏ß‡∏° netWeight <strong><%= fmtTons(mixSummaryTotalTons || 0, { max: 2 }) %></strong> ‡∏ï‡∏±‡∏ô</span>
          </div>
          <div class="table-scroll">
            <table class="table compact ghost">
              <thead>
                <tr>
                  <th>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Name)</th>
                  <th>‡∏£‡∏´‡∏±‡∏™</th>
                  <th>Mix</th>
                  <th class="right">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (‡∏ï‡∏±‡∏ô)</th>
                  <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß</th>
                </tr>
              </thead>
              <tbody>
                <% if (mixSummary && mixSummary.length) { %>
                  <% mixSummary.forEach(item => { %>
                    <tr>
                      <td><strong><%= item.projectName %></strong></td>
                      <td><%= item.projectCode || '-' %></td>
                      <td><%= item.mixName || '-' %></td>
                      <td class="right"><%= fmtTons(item.totalNetWeightTons, { max: 2 }) %></td>
                      <td class="right"><%= fmtCount(item.entryCount) %></td>
                    </tr>
                  <% }) %>
                <% } else { %>
                  <tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å MIX</td></tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="panel-body">
        <div class="card glass line-card" data-chart="daily-lines" data-chart-payload='<%- dailySeriesPayload %>'>
          <div class="card-heading">
            <h3>‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
            <span class="muted">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (‡∏ï‡∏±‡∏ô)</span>
          </div>
          <div class="line-chart-wrap">
            <canvas height="220"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section class="panel-block" id="companies">
      <div class="panel-heading">
        <div>
          <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h2>
          <p>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
        </div>
      </div>
      <div class="panel-body grid-2 gap-xl">
        <div class="card glass">
          <div class="card-heading">
            <h3>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</h3>
          </div>
          <div class="table-scroll">
            <table class="table compact ghost">
              <thead>
                <tr>
                  <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
                  <th class="right">‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ô</th>
                  <th class="right">BUY</th>
                  <th class="right">SELL</th>
                  <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß</th>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                </tr>
              </thead>
              <tbody>
                <% (companySummary || []).forEach(item => { %>
                  <tr>
                    <td><strong><%= item.name %></strong></td>
                    <td class="right"><%= fmtTons(item.totalTons) %></td>
                    <td class="right"><%= fmtTons(item.buyTons) %></td>
                    <td class="right"><%= fmtTons(item.sellTons) %></td>
                    <td class="right"><%= fmtCount(item.entryCount) %></td>
                    <td><%= item.latestDate || '-' %></td>
                  </tr>
                <% }) %>
                <% if (!companySummary || companySummary.length === 0) { %>
                  <tr><td colspan="6" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card glass">
          <div class="card-heading">
            <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</h3>
          </div>
          <div class="table-scroll">
            <table class="table compact ghost">
              <thead>
                <tr>
                  <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                  <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                  <th class="right">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</th>
                  <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                  <th>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                </tr>
              </thead>
              <tbody>
                <% (latestRecords || []).forEach(rec => { %>
                  <% const qty = formatQuantity(rec.product, rec.unit, rec.weightTons); %>
                  <tr>
                    <td><strong><%= rec.companyId ? rec.companyId.name : (rec.sourceCompanyName || rec.sourceCompanyId || 'Unknown') %></strong></td>
                    <td><%= rec.dateStr %></td>
                    <td><%= rec.type || '-' %></td>
                    <td><%= rec.product || '-' %></td>
                    <td class="right"><%= qty.formatted %></td>
                    <td><%= qty.unit %></td>
                    <td><%= rec.createdAt ? new Date(rec.createdAt).toLocaleString('th-TH') : '-' %></td>
                  </tr>
                <% }) %>
                <% if (!latestRecords || latestRecords.length === 0) { %>
                  <tr><td colspan="7" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</td></tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="panel-block" id="tools">
      <div class="panel-heading">
        <div>
          <h2>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏î‡πà‡∏ß‡∏ô</h2>
          <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>
      </div>
      <div class="panel-body quick-actions">
        <a class="action-card" href="/admin/upload">
          <span class="icon">‚§¥Ô∏è</span>
          <span>
            <strong>Upload Excel</strong>
            <em>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</em>
          </span>
        </a>
        <a class="action-card" href="/admin/test">
          <span class="icon">üß™</span>
          <span>
            <strong>Test &amp; Send</strong>
            <em>‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß LINE</em>
          </span>
        </a>
        <a class="action-card" href="/admin/richmenu">
          <span class="icon">üß≠</span>
          <span>
            <strong>Rich Menu</strong>
            <em>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</em>
          </span>
        </a>
        <a class="action-card" href="/admin/tools/purge">
          <span class="icon">üóëÔ∏è</span>
          <span>
            <strong>Purge Data</strong>
            <em>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</em>
          </span>
        </a>
        <a class="action-card" href="/admin/consents">
          <span class="icon">‚úÖ</span>
          <span>
            <strong>Consents</strong>
            <em>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</em>
          </span>
        </a>
      </div>
    </section>
  </div>
</div>

<script src="/static/js/dashboard_map.js"></script>
