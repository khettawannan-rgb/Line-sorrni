<!-- project-root/src/views/dashboard.ejs -->
<% const fmtCount = (val) => Number(val || 0).toLocaleString('th-TH'); %>
<% const fmtPercent = (ratio) => `${Math.round(Number(ratio || 0) * 100)}%`; %>
<% const summaryTimestamp = new Date().toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' }); %>
<% const chatStats = chatUserStats || { active7d: 0, new7d: 0, returning7d: 0, active30d: 0, totalUsers: 0, messages7d: 0, messagesTotal: 0 }; %>
<% const fallbackTrendSeries = [
  { date: '2024-09-01', messageCount: 18, uniqueUsers: 7 },
  { date: '2024-09-02', messageCount: 22, uniqueUsers: 8 },
  { date: '2024-09-03', messageCount: 24, uniqueUsers: 9 },
  { date: '2024-09-04', messageCount: 28, uniqueUsers: 10 },
  { date: '2024-09-05', messageCount: 26, uniqueUsers: 9 },
  { date: '2024-09-06', messageCount: 31, uniqueUsers: 11 },
  { date: '2024-09-07', messageCount: 33, uniqueUsers: 12 },
  { date: '2024-09-08', messageCount: 29, uniqueUsers: 11 },
  { date: '2024-09-09', messageCount: 35, uniqueUsers: 13 },
  { date: '2024-09-10', messageCount: 32, uniqueUsers: 12 },
]; %>
<% const trendSeries = Array.isArray(chatTrend) && chatTrend.length ? chatTrend : fallbackTrendSeries; %>
<% const trendSeriesJSON = JSON.stringify(trendSeries.slice(-14)); %>
<% const provinceStats = provinceMapStats || {}; %>
<% const topProvinces = (provinceMapTop || []).slice(0, 5); %>
<% const currentUser =
     (typeof user !== 'undefined' && user)
       ? user
       : (locals && locals.user ? locals.user : null); %>
<% const dashboardDisplayName =
     (currentUser && (currentUser.fullName || currentUser.displayName || currentUser.username))
       ? (currentUser.fullName || currentUser.displayName || currentUser.username)
       : '‡∏ó‡∏µ‡∏° Sorrni'; %>
<% const focusAreas = [
  { label: 'On-time Delivery', ratio: provinceStats?.onTimeRate ?? 0.72 },
  { label: 'Invoice Accuracy', ratio: provinceStats?.accuracyRate ?? 0.63 },
  { label: 'Customer Satisfaction', ratio: (chatStats?.satisfactionRate ?? 0.81) },
  { label: 'Open Issues Resolved', ratio: provinceStats?.issueCloseRate ?? 0.58 },
]; %>
<% const meetings = [
  { title: 'Quick Daily Sync', date: 'Tue, 16 Jul', time: '08:30', channel: 'Zoom', href: '#daily-sync' },
  { title: 'Vendor Check-in', date: 'Tue, 16 Jul', time: '11:00', channel: 'Google Meet', href: '#vendor-call' },
  { title: 'PR Approval Board', date: 'Tue, 16 Jul', time: '15:30', channel: 'Teams', href: '#pr-board' },
  { title: 'Customer Insight Review', date: 'Wed, 17 Jul', time: '09:00', channel: 'Zoom', href: '#insight-review' },
]; %>
<% const quickActions = [
  { label: 'Upload Orders', description: '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', href: '/admin/upload', icon: '‚§¥Ô∏è' },
  { label: 'Send Daily Summary', description: '‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏´‡∏≤ LINE ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', href: '/admin/tools/send-daily', icon: 'üí¨' },
  { label: 'Manage Members', description: '‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó', href: '/admin/members', icon: 'üë•' },
  { label: 'Rich Menu Studio', description: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡∏∞ CTA', href: '/admin/richmenu', icon: 'üß≠' },
]; %>

<div class="dashboard-canvas">
  <main class="dashboard-main">
    <header class="dash-hero">
      <div class="dash-hero__intro">
        <span class="dash-pill">Sorrni Workspace</span>
        <h1>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö, <%= dashboardDisplayName %></h1>
        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠ <strong><%= summaryTimestamp %></strong></p>
      </div>
      <div class="dash-hero__actions">
        <div class="dash-search">
          <span aria-hidden="true">üîç</span>
          <input type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" />
        </div>
        <a class="btn primary" href="/admin/upload">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</a>
      </div>
    </header>

    <section class="dash-highlights">
      <article class="highlight-card gradient gradient--ocean">
        <header>
          <h3>Active Users (7 ‡∏ß‡∏±‡∏ô)</h3>
          <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <%= fmtCount(chatStats.totalUsers) %> ‡∏Ñ‡∏ô</span>
        </header>
        <div class="highlight-value"><%= fmtCount(chatStats.active7d) %></div>
        <p>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô <strong><%= fmtCount(chatStats.new7d) %></strong> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</p>
      </article>

      <article class="highlight-card gradient gradient--sunset">
        <header>
          <h3>Returning Users</h3>
          <span>‡∏ä‡πà‡∏ß‡∏á 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
        </header>
        <div class="highlight-value"><%= fmtCount(chatStats.returning7d) %></div>
        <p>‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô <strong><%= chatStats.active7d ? ((chatStats.returning7d / Math.max(chatStats.active7d, 1)) * 100).toFixed(1) : '0.0' %>%</strong> ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á engage</p>
      </article>

      <article class="highlight-card gradient gradient--lavender">
        <header>
          <h3>Messages Volume</h3>
          <span>‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
        </header>
        <div class="highlight-value"><%= fmtCount(chatStats.messages7d) %></div>
        <p>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong><%= fmtCount(chatStats.messagesTotal) %></strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
      </article>
    </section>

    <section class="dash-panel-grid">
      <article class="panel card chart-card insight-chart" data-chart-trend='<%- trendSeriesJSON %>'>
        <header class="panel__header">
          <div>
            <h2>Interaction Trend</h2>
            <p class="muted">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô</p>
          </div>
          <button type="button" class="btn ghost small hide-md">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
        </header>
        <div class="chart-frame chart-card__body">
          <canvas id="chat-trend-chart" height="240"></canvas>
        </div>
      </article>

      <article class="panel card task-card">
        <header class="panel__header">
          <div>
            <h2>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á</h2>
            <p class="muted">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏≤‡∏Å Pipeline</p>
          </div>
        </header>
        <ul class="task-list">
          <li>
            <div>
              <strong>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö PR ‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</strong>
              <span>12 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‚Ä¢ SLA 4 ‡∏ä‡∏°.</span>
            </div>
            <a href="/admin/pr" class="btn ghost small">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</a>
          </li>
          <li>
            <div>
              <strong>‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</strong>
              <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° 1.28M ‡∏ö‡∏≤‡∏ó ‚Ä¢ 8 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</span>
            </div>
            <a href="/admin/tools/send-daily" class="btn ghost small">‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ</a>
          </li>
          <li>
            <div>
              <strong>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</strong>
              <span>5 ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
            </div>
            <a href="/admin/po" class="btn ghost small">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</a>
          </li>
          <li>
            <div>
              <strong>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Rich Menu ‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç</strong>
              <span>‡πÄ‡∏û‡∏¥‡πà‡∏° CTA ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô ‡∏ï.‡∏Ñ.</span>
            </div>
            <a href="/admin/richmenu" class="btn ghost small">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
          </li>
        </ul>
      </article>
    </section>

    <section class="dash-panel-grid">
      <article class="panel card">
        <header class="panel__header">
          <div>
            <h2>Top Provinces</h2>
            <p class="muted">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p>
          </div>
        </header>
        <ul class="province-list">
          <% if (topProvinces.length) { %>
            <% topProvinces.forEach((prov, idx) => { %>
              <li>
                <span class="province-rank"><%= idx + 1 %></span>
                <div class="province-meta">
                  <strong><%= prov._id || prov.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' %></strong>
                  <span><%= fmtCount(prov.count || prov.total || 0) %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
                <div class="province-bar">
                  <span style="width: <%= Math.min(100, (prov.count || prov.total || 0) / Math.max(topProvinces[0]?.count || topProvinces[0]?.total || 1, 1) * 100) %>%"></span>
                </div>
              </li>
            <% }) %>
          <% } else { %>
            <li class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏™‡πà‡∏á</li>
          <% } %>
        </ul>
      </article>

      <article class="panel card">
        <header class="panel__header">
          <div>
            <h2>Performance Pulse</h2>
            <p class="muted">‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏™‡∏°‡∏≠</p>
          </div>
        </header>
        <ul class="progress-list">
          <% focusAreas.forEach((item) => { %>
            <li>
              <div>
                <strong><%= item.label %></strong>
                <span><%= fmtPercent(item.ratio) %></span>
              </div>
              <div class="progress-track">
                <span style="width: <%= Math.min(100, Number(item.ratio || 0) * 100) %>%"></span>
              </div>
            </li>
          <% }) %>
        </ul>
      </article>
    </section>
  </main>

  <aside class="dashboard-side">
    <section class="panel card profile-card">
      <div class="profile-card__avatar">
        <img src="/static/img/sorni.png" alt="Sorrni logo" />
      </div>
      <div class="profile-card__meta">
        <h2>Sorni HQ</h2>
        <p>Smart procurement ¬∑ LINE ERP Notifier</p>
      </div>
      <dl class="profile-stats">
        <div>
          <dt>PR/PO ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</dt>
          <dd>42</dd>
        </div>
        <div>
          <dt>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</dt>
          <dd>8</dd>
        </div>
        <div>
          <dt>Avg. SLA</dt>
          <dd>92%</dd>
        </div>
      </dl>
    </section>

    <section class="panel card meetings-card">
      <header class="panel__header">
        <div>
          <h2>Today‚Äôs Meetings</h2>
          <p class="muted">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</p>
        </div>
      </header>
      <ul class="meetings-list">
        <% meetings.forEach((meeting) => { %>
          <li>
            <div>
              <strong><%= meeting.title %></strong>
              <span><%= meeting.date %> ¬∑ <%= meeting.time %> ¬∑ <%= meeting.channel %></span>
            </div>
            <a href="<%= meeting.href %>" class="btn ghost small">Join</a>
          </li>
        <% }) %>
      </ul>
    </section>

    <section class="panel card quick-actions">
      <header class="panel__header">
        <div>
          <h2>Quick Actions</h2>
          <p class="muted">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥ ‡πÜ ‡πÉ‡∏ô‡πÑ‡∏°‡πà‡∏Å‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å</p>
        </div>
      </header>
      <div class="quick-actions__grid">
        <% quickActions.forEach((action) => { %>
          <a href="<%= action.href %>" class="quick-action">
            <span class="quick-action__icon"><%= action.icon %></span>
            <span class="quick-action__label"><%= action.label %></span>
            <span class="quick-action__desc"><%= action.description %></span>
          </a>
        <% }) %>
      </div>
    </section>
  </aside>
</div>
