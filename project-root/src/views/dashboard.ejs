<!-- project-root/src/views/dashboard.ejs -->
<% const fmtCount = (val) => Number(val || 0).toLocaleString('th-TH'); %>
<% const fmtTons = (val, opts = {}) => Number(val || 0).toLocaleString('th-TH', { minimumFractionDigits: opts.min ?? 0, maximumFractionDigits: opts.max ?? 2 }); %>
<% const isLitreProduct = (name = '', unit = '') => /‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ï‡∏≤/i.test(String(name)) || /‡∏•‡∏¥‡∏ï‡∏£/.test(String(unit)); %>
<% const formatQuantity = (name, unit, tons) => {
     const liter = isLitreProduct(name, unit);
     const value = liter ? Number(tons || 0) * 1000 : Number(tons || 0);
     const decimals = liter ? 0 : 2;
     return {
       value,
       unit: liter ? '‡∏•‡∏¥‡∏ï‡∏£' : '‡∏ï‡∏±‡∏ô',
       formatted: Number(value || 0).toLocaleString('th-TH', {
         minimumFractionDigits: 0,
         maximumFractionDigits: decimals,
       }),
     };
   }; %>
<% const summaryTimestamp = new Date().toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' }); %>
<% const provinceDataJSON = JSON.stringify(provinceMap || []); %>
<% const provinceTopList = Array.isArray(provinceMapTop) ? provinceMapTop : []; %>
<% const provinceStats = provinceMapStats || { totalLocations: 0, uniqueUsers: 0, totalProvinces: 0, provincesWithCoords: 0, lastUpdatedAt: null }; %>
<% const hasProvinceCoords = Number(provinceStats.provincesWithCoords || 0) > 0; %>
<% const chatStats = chatUserStats || { active7d: 0, new7d: 0, returning7d: 0, active30d: 0, totalUsers: 0, messages7d: 0, messagesTotal: 0 }; %>
<% const consentTotals = consentStatusSummary || {}; %>
<% const chatTrendJSON = JSON.stringify(chatTrend || []); %>
<% const chatTopicTopJSON = JSON.stringify((chat.topicSummary || []).slice(0, 5)); %>
<% const consentStatusJSON = JSON.stringify(consentTotals); %>
<% const behavior =
     (typeof dashboardBehavior !== 'undefined' && dashboardBehavior !== null)
       ? dashboardBehavior
       : (locals.dashboardBehavior || {}); %>

<%
const sampleInteractionSeries = [
  { date: '2024-09-01', messageCount: 18, uniqueUsers: 7 },
  { date: '2024-09-02', messageCount: 22, uniqueUsers: 8 },
  { date: '2024-09-03', messageCount: 24, uniqueUsers: 9 },
  { date: '2024-09-04', messageCount: 28, uniqueUsers: 10 },
  { date: '2024-09-05', messageCount: 26, uniqueUsers: 9 },
  { date: '2024-09-06', messageCount: 31, uniqueUsers: 11 },
  { date: '2024-09-07', messageCount: 33, uniqueUsers: 12 },
  { date: '2024-09-08', messageCount: 29, uniqueUsers: 11 },
  { date: '2024-09-09', messageCount: 35, uniqueUsers: 13 },
  { date: '2024-09-10', messageCount: 32, uniqueUsers: 12 },
];

const sampleHeatmap = [
  { dow: 1, hour: 9, volume: 12 },
  { dow: 1, hour: 11, volume: 9 },
  { dow: 2, hour: 10, volume: 16 },
  { dow: 2, hour: 13, volume: 10 },
  { dow: 3, hour: 14, volume: 19 },
  { dow: 3, hour: 16, volume: 13 },
  { dow: 4, hour: 9, volume: 14 },
  { dow: 4, hour: 15, volume: 11 },
  { dow: 5, hour: 10, volume: 18 },
  { dow: 6, hour: 12, volume: 15 },
];

const sampleSentimentTrend = [
  { date: '2024-09-01', positive: 14, neutral: 6, negative: 2 },
  { date: '2024-09-02', positive: 16, neutral: 5, negative: 3 },
  { date: '2024-09-03', positive: 18, neutral: 4, negative: 3 },
  { date: '2024-09-04', positive: 17, neutral: 6, negative: 4 },
  { date: '2024-09-05', positive: 19, neutral: 5, negative: 3 },
  { date: '2024-09-06', positive: 22, neutral: 4, negative: 2 },
  { date: '2024-09-07', positive: 21, neutral: 5, negative: 3 },
  { date: '2024-09-08', positive: 20, neutral: 6, negative: 4 },
  { date: '2024-09-09', positive: 24, neutral: 5, negative: 2 },
  { date: '2024-09-10', positive: 23, neutral: 6, negative: 3 },
];

const sampleIntentStack = [
  { week: '2024-W35', category: 'Inquiry', count: 48 },
  { week: '2024-W35', category: 'Order', count: 36 },
  { week: '2024-W35', category: 'Complaint', count: 12 },
  { week: '2024-W35', category: 'Support', count: 22 },
  { week: '2024-W35', category: 'Other', count: 8 },
  { week: '2024-W36', category: 'Inquiry', count: 54 },
  { week: '2024-W36', category: 'Order', count: 39 },
  { week: '2024-W36', category: 'Complaint', count: 15 },
  { week: '2024-W36', category: 'Support', count: 27 },
  { week: '2024-W36', category: 'Other', count: 10 },
];

const sampleKeywordCloud = [
  { text: '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', weight: 32 },
  { text: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á', weight: 24 },
  { text: '‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á', weight: 18 },
  { text: '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', weight: 15 },
  { text: '‡∏£‡∏≤‡∏Ñ‡∏≤', weight: 21 },
  { text: '‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï', weight: 12 },
  { text: '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°', weight: 19 },
  { text: '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏á', weight: 14 },
  { text: '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤', weight: 17 },
  { text: '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á', weight: 11 },
];

const sampleSentimentCloud = {
  positive: [
    { text: '‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß', weight: 20 },
    { text: '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì', weight: 18 },
    { text: '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°', weight: 16 },
    { text: '‡∏™‡∏∞‡∏î‡∏ß‡∏Å', weight: 14 },
    { text: '‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏µ', weight: 12 },
    { text: '‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', weight: 10 },
    { text: '‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÉ‡∏à', weight: 9 },
    { text: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', weight: 8 },
    { text: '‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', weight: 7 },
    { text: '‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á', weight: 6 },
  ],
  negative: [
    { text: '‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤', weight: 19 },
    { text: '‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î', weight: 16 },
    { text: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á', weight: 15 },
    { text: '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏¢‡∏≤‡∏Å', weight: 13 },
    { text: '‡∏Ç‡∏≤‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', weight: 11 },
    { text: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', weight: 10 },
    { text: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', weight: 9 },
    { text: '‡∏õ‡∏±‡∏ç‡∏´‡∏≤', weight: 8 },
    { text: '‡πÄ‡∏Ñ‡∏•‡∏°', weight: 7 },
    { text: '‡∏£‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°', weight: 6 },
  ],
};

const sampleFunnel = [
  { period: '2024-W35', stage: 'Inquiry', count: 128 },
  { period: '2024-W35', stage: 'Quote', count: 102 },
  { period: '2024-W35', stage: 'PurchaseOrder', count: 78 },
  { period: '2024-W35', stage: 'Payment', count: 61 },
  { period: '2024-W35', stage: 'Delivered', count: 54 },
  { period: '2024-W36', stage: 'Inquiry', count: 134 },
  { period: '2024-W36', stage: 'Quote', count: 110 },
  { period: '2024-W36', stage: 'PurchaseOrder', count: 84 },
  { period: '2024-W36', stage: 'Payment', count: 69 },
  { period: '2024-W36', stage: 'Delivered', count: 58 },
];

const sampleAgentResponse = [
  { agent_id: 'AG01', name: 'Ratchaphon.Don‚öôÔ∏è‚öôÔ∏è‚öôÔ∏è', avgFirstReplySec: 115, medianFirstReplySec: 92, p90FirstReplySec: 210, slaPct: 0.94 },
  { agent_id: 'AG02', name: 'üêßRabbit_Bearüêß', avgFirstReplySec: 148, medianFirstReplySec: 120, p90FirstReplySec: 260, slaPct: 0.88 },
  { agent_id: 'AG03', name: 'PM ‡∏†‡∏≤‡∏Ñ‡∏¥‡∏ô(‡πÄ‡∏ó‡πá‡∏î) (KRR)', avgFirstReplySec: 132, medianFirstReplySec: 104, p90FirstReplySec: 230, slaPct: 0.91 },
  { agent_id: 'AG04', name: 'PUY ‡πç', avgFirstReplySec: 165, medianFirstReplySec: 138, p90FirstReplySec: 310, slaPct: 0.82 },
  { agent_id: 'AG05', name: 'üíïTonaorüíï', avgFirstReplySec: 189, medianFirstReplySec: 150, p90FirstReplySec: 340, slaPct: 0.79 },
  { agent_id: 'AG06', name: 'Man MinKhat', avgFirstReplySec: 124, medianFirstReplySec: 101, p90FirstReplySec: 216, slaPct: 0.9 },
  { agent_id: 'AG07', name: 'üíöSP.KRRüíö', avgFirstReplySec: 172, medianFirstReplySec: 143, p90FirstReplySec: 320, slaPct: 0.84 },
  { agent_id: 'AG08', name: '‡∏®‡∏¥‡∏£‡∏¥‡∏ä‡∏±‡∏¢ ‡∏Å‡∏•‡∏±‡∏î‡∏™‡∏≠‡∏≤‡∏î', avgFirstReplySec: 156, medianFirstReplySec: 133, p90FirstReplySec: 298, slaPct: 0.86 },
  { agent_id: 'AG09', name: 'NOK SUMALEE', avgFirstReplySec: 141, medianFirstReplySec: 118, p90FirstReplySec: 244, slaPct: 0.89 },
  { agent_id: 'AG10', name: 'anndew3.‡∏Å‡∏¥‡∏ï‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á', avgFirstReplySec: 167, medianFirstReplySec: 140, p90FirstReplySec: 305, slaPct: 0.83 },
];

const sampleAgentLeaderboard = [
  { agent_id: 'AG01', name: 'Ratchaphon.Don‚öôÔ∏è‚öôÔ∏è‚öôÔ∏è', conversationCount: 64, avgFirstReplySec: 115, slaPct: 0.94, avgSentiment: 0.72 },
  { agent_id: 'AG02', name: 'üêßRabbit_Bearüêß', conversationCount: 59, avgFirstReplySec: 148, slaPct: 0.88, avgSentiment: 0.65 },
  { agent_id: 'AG03', name: 'PM ‡∏†‡∏≤‡∏Ñ‡∏¥‡∏ô(‡πÄ‡∏ó‡πá‡∏î) (KRR)', conversationCount: 61, avgFirstReplySec: 132, slaPct: 0.91, avgSentiment: 0.69 },
  { agent_id: 'AG04', name: 'PUY ‡πç', conversationCount: 57, avgFirstReplySec: 165, slaPct: 0.82, avgSentiment: 0.62 },
  { agent_id: 'AG05', name: 'üíïTonaorüíï', conversationCount: 55, avgFirstReplySec: 189, slaPct: 0.79, avgSentiment: 0.58 },
  { agent_id: 'AG06', name: 'Man MinKhat', conversationCount: 53, avgFirstReplySec: 124, slaPct: 0.90, avgSentiment: 0.71 },
  { agent_id: 'AG07', name: 'üíöSP.KRRüíö', conversationCount: 52, avgFirstReplySec: 172, slaPct: 0.84, avgSentiment: 0.63 },
  { agent_id: 'AG08', name: '‡∏®‡∏¥‡∏£‡∏¥‡∏ä‡∏±‡∏¢ ‡∏Å‡∏•‡∏±‡∏î‡∏™‡∏≠‡∏≤‡∏î', conversationCount: 51, avgFirstReplySec: 156, slaPct: 0.86, avgSentiment: 0.67 },
  { agent_id: 'AG09', name: 'NOK SUMALEE', conversationCount: 49, avgFirstReplySec: 141, slaPct: 0.89, avgSentiment: 0.68 },
  { agent_id: 'AG10', name: 'anndew3.‡∏Å‡∏¥‡∏ï‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á', conversationCount: 47, avgFirstReplySec: 167, slaPct: 0.83, avgSentiment: 0.61 },
];

const sampleTopCustomers = [
  { user_id: 'U1001', displayName: 'Coup√©üá∞üá∑', messageCount: 42, sessionCount: 7, sentimentAvg: 0.68, engagementScore: 86 },
  { user_id: 'U1002', displayName: 'Nuttinan', messageCount: 38, sessionCount: 6, sentimentAvg: 0.54, engagementScore: 79 },
  { user_id: 'U1003', displayName: '‡∏ö‡∏∏‡∏ç‡∏™‡πà‡∏á', messageCount: 44, sessionCount: 8, sentimentAvg: 0.61, engagementScore: 91 },
  { user_id: 'U1004', displayName: '‡∏™‡∏°‡∏†‡∏π‡∏°‡∏¥', messageCount: 31, sessionCount: 5, sentimentAvg: 0.49, engagementScore: 73 },
  { user_id: 'U1005', displayName: 'üéÑJ_GiFTüéÑ', messageCount: 36, sessionCount: 6, sentimentAvg: 0.57, engagementScore: 84 },
  { user_id: 'U1006', displayName: 'Chalomkarnyotha', messageCount: 29, sessionCount: 5, sentimentAvg: 0.46, engagementScore: 70 },
  { user_id: 'U1007', displayName: '‡∏û‡∏π‡∏•', messageCount: 33, sessionCount: 6, sentimentAvg: 0.59, engagementScore: 78 },
  { user_id: 'U1008', displayName: 'Rotjamat', messageCount: 27, sessionCount: 4, sentimentAvg: 0.52, engagementScore: 66 },
  { user_id: 'U1009', displayName: 'an ‚Äòs', messageCount: 30, sessionCount: 5, sentimentAvg: 0.55, engagementScore: 74 },
  { user_id: 'U1010', displayName: 'Somnuek 289', messageCount: 34, sessionCount: 6, sentimentAvg: 0.51, engagementScore: 80 },
];

const sampleRetention = [
  { cohort: '2024-W32', weekOffset: 0, rate: 1.0 },
  { cohort: '2024-W32', weekOffset: 1, rate: 0.76 },
  { cohort: '2024-W32', weekOffset: 2, rate: 0.64 },
  { cohort: '2024-W32', weekOffset: 3, rate: 0.56 },
  { cohort: '2024-W33', weekOffset: 0, rate: 1.0 },
  { cohort: '2024-W33', weekOffset: 1, rate: 0.72 },
  { cohort: '2024-W33', weekOffset: 2, rate: 0.58 },
  { cohort: '2024-W33', weekOffset: 3, rate: 0.49 },
  { cohort: '2024-W34', weekOffset: 0, rate: 1.0 },
  { cohort: '2024-W34', weekOffset: 1, rate: 0.69 },
];

const sampleChurn = [
  { user_id: 'U2001', displayName: 'poon', lastSeen: '2024-08-28T09:30:00Z', gapDays: 12.2, sentimentTrend: -0.3 },
  { user_id: 'U2002', displayName: 'pirust‡πÑ‡∏û‡∏£‡∏±‡∏ï‡∏ô‡πå‡∏°‡∏≤‡∏Å‡∏∏‡∏•', lastSeen: '2024-08-27T10:12:00Z', gapDays: 13.4, sentimentTrend: -0.1 },
  { user_id: 'U2003', displayName: 'Khak', lastSeen: '2024-08-21T14:22:00Z', gapDays: 19.7, sentimentTrend: -0.4 },
  { user_id: 'U2004', displayName: 'bus see', lastSeen: '2024-08-29T08:18:00Z', gapDays: 11.0, sentimentTrend: -0.2 },
  { user_id: 'U2005', displayName: '‡∏â‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏¢‡∏ò‡∏≤', lastSeen: '2024-08-24T16:08:00Z', gapDays: 15.8, sentimentTrend: -0.35 },
  { user_id: 'U2006', displayName: 'Ko_phan.M', lastSeen: '2024-08-20T09:02:00Z', gapDays: 20.3, sentimentTrend: -0.25 },
  { user_id: 'U2007', displayName: '‡∏≠‡∏î‡∏¥‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏Å‡πâ‡∏ß‡∏Ñ‡∏∏‡∏ì', lastSeen: '2024-08-25T11:42:00Z', gapDays: 14.6, sentimentTrend: -0.28 },
  { user_id: 'U2008', displayName: 'Aom Àöüêªü´ß', lastSeen: '2024-08-30T13:15:00Z', gapDays: 9.9, sentimentTrend: -0.18 },
  { user_id: 'U2009', displayName: 'Ratchaphon.Don‚öôÔ∏è‚öôÔ∏è‚öôÔ∏è', lastSeen: '2024-08-19T10:10:00Z', gapDays: 21.4, sentimentTrend: -0.32 },
  { user_id: 'U2010', displayName: 'üêßRabbit_Bearüêß', lastSeen: '2024-08-23T07:52:00Z', gapDays: 16.5, sentimentTrend: -0.22 },
];

const sampleAnomalies = [
  { date: '2024-09-01', metric: 'complaints', deltaSigma: 3.2, keyword: '‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤' },
  { date: '2024-09-02', metric: 'complaints', deltaSigma: 3.1, keyword: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á' },
  { date: '2024-09-03', metric: 'complaints', deltaSigma: 2.9, keyword: '‡πÄ‡∏Ñ‡∏•‡∏°' },
  { date: '2024-09-04', metric: 'negative_sentiment', deltaSigma: 3.4, keyword: '‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î' },
  { date: '2024-09-05', metric: 'complaints', deltaSigma: 3.0, keyword: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô' },
  { date: '2024-09-06', metric: 'negative_sentiment', deltaSigma: 3.5, keyword: '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏¢‡∏≤‡∏Å' },
  { date: '2024-09-07', metric: 'complaints', deltaSigma: 3.3, keyword: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' },
  { date: '2024-09-08', metric: 'negative_sentiment', deltaSigma: 3.1, keyword: '‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°' },
  { date: '2024-09-09', metric: 'complaints', deltaSigma: 3.6, keyword: '‡∏Ç‡∏≤‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' },
  { date: '2024-09-10', metric: 'negative_sentiment', deltaSigma: 3.2, keyword: '‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤' },
];

const sampleNetwork = {
  nodes: [
    { id: 'U1001', label: 'Coup√©üá∞üá∑', group: 'customer' },
    { id: 'U1002', label: 'Nuttinan', group: 'customer' },
    { id: 'U1003', label: '‡∏ö‡∏∏‡∏ç‡∏™‡πà‡∏á', group: 'customer' },
    { id: 'U1004', label: '‡∏™‡∏°‡∏†‡∏π‡∏°‡∏¥', group: 'customer' },
    { id: 'U1005', label: 'üéÑJ_GiFTüéÑ', group: 'customer' },
    { id: 'AG01', label: 'Ratchaphon.Don‚öôÔ∏è‚öôÔ∏è‚öôÔ∏è', group: 'agent' },
    { id: 'AG02', label: 'üêßRabbit_Bearüêß', group: 'agent' },
    { id: 'AG03', label: 'PM ‡∏†‡∏≤‡∏Ñ‡∏¥‡∏ô(‡πÄ‡∏ó‡πá‡∏î) (KRR)', group: 'agent' },
    { id: 'AG04', label: 'PUY ‡πç', group: 'agent' },
    { id: 'AG05', label: 'üíïTonaorüíï', group: 'agent' },
  ],
  links: [
    { source: 'U1001', target: 'AG01', conversations: 18 },
    { source: 'U1002', target: 'AG02', conversations: 14 },
    { source: 'U1003', target: 'AG03', conversations: 16 },
    { source: 'U1004', target: 'AG02', conversations: 11 },
    { source: 'U1005', target: 'AG01', conversations: 12 },
    { source: 'U1001', target: 'AG04', conversations: 9 },
    { source: 'U1003', target: 'AG05', conversations: 7 },
    { source: 'U1002', target: 'AG03', conversations: 10 },
    { source: 'U1004', target: 'AG05', conversations: 8 },
    { source: 'U1005', target: 'AG04', conversations: 6 },
  ],
};
%>

<% const interactionSeries = (Array.isArray(behavior.timeSeries) && behavior.timeSeries.length) ? behavior.timeSeries : sampleInteractionSeries; %>
<% const interactionSeriesJSON = JSON.stringify(interactionSeries); %>
<% const heatmapData = (Array.isArray(behavior.heatmap) && behavior.heatmap.length) ? behavior.heatmap : sampleHeatmap; %>
<% const heatmapJSON = JSON.stringify(heatmapData); %>
<% const sentimentTrendData = (Array.isArray(behavior.sentimentTrend) && behavior.sentimentTrend.length) ? behavior.sentimentTrend : sampleSentimentTrend; %>
<% const sentimentTrendJSON = JSON.stringify(sentimentTrendData); %>
<% const intentStackData = (Array.isArray(behavior.intentDistribution) && behavior.intentDistribution.length) ? behavior.intentDistribution : sampleIntentStack; %>
<% const intentStackJSON = JSON.stringify(intentStackData); %>
<% const keywordCloudData = (Array.isArray(behavior.keywordCloud) && behavior.keywordCloud.length) ? behavior.keywordCloud : sampleKeywordCloud; %>
<% const keywordCloudJSON = JSON.stringify(keywordCloudData); %>
<% const sentimentCloudData = (behavior.sentimentWordCloud && (behavior.sentimentWordCloud.positive?.length || behavior.sentimentWordCloud.negative?.length)) ? behavior.sentimentWordCloud : sampleSentimentCloud; %>
<% const sentimentCloudJSON = JSON.stringify(sentimentCloudData); %>
<% const funnelData = (Array.isArray(behavior.conversionFunnel) && behavior.conversionFunnel.length) ? behavior.conversionFunnel : sampleFunnel; %>
<% const funnelJSON = JSON.stringify(funnelData); %>
<% const agentResponseData = (Array.isArray(behavior.agentResponse) && behavior.agentResponse.length) ? behavior.agentResponse : sampleAgentResponse; %>
<% const agentResponseJSON = JSON.stringify(agentResponseData); %>
<% const agentLeaderboard = (Array.isArray(behavior.agentLeaderboard) && behavior.agentLeaderboard.length) ? behavior.agentLeaderboard : sampleAgentLeaderboard; %>
<% const topCustomers = (Array.isArray(behavior.topCustomers) && behavior.topCustomers.length) ? behavior.topCustomers : sampleTopCustomers; %>
<% const retentionData = (Array.isArray(behavior.retentionCohorts) && behavior.retentionCohorts.length) ? behavior.retentionCohorts : sampleRetention; %>
<% const retentionJSON = JSON.stringify(retentionData); %>
<% const churnList = (Array.isArray(behavior.churnRisks) && behavior.churnRisks.length) ? behavior.churnRisks : sampleChurn; %>
<% const anomalyList = (Array.isArray(behavior.anomalies) && behavior.anomalies.length) ? behavior.anomalies : sampleAnomalies; %>
<% const networkData = (behavior.networkGraph && Array.isArray(behavior.networkGraph.links) && behavior.networkGraph.links.length) ? behavior.networkGraph : sampleNetwork; %>
<% const networkJSON = JSON.stringify(networkData); %>
<% const networkNodeLabel = new Map(networkData.nodes.map((node) => [node.id, node.label || node.name || node.id])); %>
<% const networkLinksSorted = (networkData.links || []).slice().sort((a, b) => (Number(b.conversations || 0) - Number(a.conversations || 0))).slice(0, 10); %>
<% const sentimentTotals = sentimentTrendData.reduce((acc, row) => ({
  positive: acc.positive + Number(row.positive || row.pos || 0),
  neutral: acc.neutral + Number(row.neutral || row.neu || 0),
  negative: acc.negative + Number(row.negative || row.neg || 0),
}), { positive: 0, neutral: 0, negative: 0 }); %>
<% const intentTotals = intentStackData.reduce((acc, row) => {
  const key = row.category || row.intent || '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ';
  acc[key] = (acc[key] || 0) + Number(row.count || row.volume || 0);
  return acc;
}, {}); %>
<% const funnelStages = ['Inquiry', 'Quote', 'PurchaseOrder', 'Payment', 'Delivered']; %>
<% const funnelTotals = funnelStages.map((stage) => ({
  stage,
  count: funnelData.filter((row) => (row.stage || row.status || '').toLowerCase() === stage.toLowerCase()).reduce((sum, row) => sum + Number(row.count || row.value || 0), 0),
})); %>
<% const heatmapTopSlots = heatmapData.slice().sort((a, b) => Number(b.volume || b.count || 0) - Number(a.volume || a.count || 0)).slice(0, 5); %>
<% const retentionSummary = retentionData.slice(0, 6); %>
<% const filters = behavior.filters || {}; %>
<% const logicModules = behavior.logicModules || [
     { name: 'Intent Classification', description: 'Classify each message into inquiry/order/complaint etc.', query: 'POST /nlp/intent -> intents collection update' },
     { name: 'Sentiment Analysis', description: 'Thai language polarity + strength using finetuned model', query: 'db.chat_messages.updateOne({_id}, {$set:{sentiment_label,...}})' },
     { name: 'Entity Extraction', description: 'Product/PO/location/date extraction with NER+regex', query: 'SELECT entity, type FROM message_entities WHERE message_id=?' },
     { name: 'User Profiling', description: 'RFM-like metrics per user', query: 'INSERT INTO user_profiles (user_id, recency_days, frequency_30d, avg_msg_len)...' },
     { name: 'Engagement Scoring', description: 'Score f(message frequency, session length, sentiment)', query: 'db.users.updateOne({_id:user_id}, {$set:{engagement_score:score}})' },
     { name: 'Response Efficiency', description: 'First reply time + SLA tracking', query: 'SELECT AVG(first_reply_seconds) FROM agent_metrics' },
     { name: 'Conversation Clustering', description: 'Topic modeling with BERTopic/HDBSCAN', query: 'INSERT INTO conversation_topics (conversation_id, cluster_id)' },
     { name: 'Churn Prediction', description: 'Predict inactivity risk', query: 'UPDATE users SET churn_score=? WHERE user_id=?' },
     { name: 'Next Best Action', description: 'Rule/ML recommended action', query: 'INSERT INTO nba_recommendations (user_id, action, reason)' },
     { name: 'Anomaly Detection', description: 'Detect spikes using rolling z-score', query: 'INSERT INTO anomalies (date, metric, delta_sigma)' },
   ]; %>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-sA+e2jXUgXu3kGEXHOIa0GpCCMbnYIY01tZ5JfL0z0k="
  crossorigin="" />
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j7kC3U1JzDvsPWVn0AqfZbG9JQIvIDi64tT0+3s="
  crossorigin=""></script>



<div class="dashboard-shell dashboard-light">
  <aside class="dashboard-sidebar">
    <div class="sidebar-brand">
      <div class="sidebar-logo">
        <img src="/static/img/sorni.png" alt="Sorni" />
      </div>
      <span class="sidebar-title">Sorni</span>
    </div>
    <nav class="sidebar-nav">
      <a href="#overview" class="active">
        <span class="icon">üè†</span>
        <span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span>
      </a>
      <a href="#excel">
        <span class="icon">üì¶</span>
        <span>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
      </a>
      <a href="#companies">
        <span class="icon">üè¢</span>
        <span>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</span>
      </a>
      <a href="#customer-insights" data-tab-jump="behavior">
        <span class="icon">üí¨</span>
        <span>‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
      </a>
      <a href="#tools">
        <span class="icon">üõ†Ô∏è</span>
        <span>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</span>
      </a>
    </nav>
    <div class="sidebar-meta">
      <span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
      <strong><%= summaryTimestamp %></strong>
    </div>
    <div class="sidebar-footer">
      <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
    </div>
  </aside>

  <div class="dashboard-main">
    <header class="dashboard-top" id="overview" data-dashboard-section="core behavior">
      <div>
        <h1>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h1>
        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ</p>
      </div>
      <div class="top-actions">
        <div class="top-search">
          <span class="icon">üîç</span>
          <input type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" />
        </div>
        <button class="btn primary">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
      </div>
    </header>

    <section class="dashboard-tabs">
      <button type="button" class="is-active" data-dashboard-tab="core">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å</button>
      <button type="button" data-dashboard-tab="behavior">‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
    </section>

    <section class="panel-block panel-insights" id="customer-insights" data-dashboard-section="behavior">
      <div class="panel-heading">
        <div>
          <h2>Customer Insights</h2>
          <p>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å LINE Official Account</p>
        </div>
        <div class="insight-meta">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 14 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
      </div>
      <div class="panel-body panel__body insight-body" data-behavior-root>
        <div class="filter-block" data-filter-wrapper>
          <div class="filter-toolbar">
            <button type="button" class="btn ghost small" data-filter-toggle aria-expanded="true">‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå</button>
          </div>
          <form class="insight-filters glass" data-filter-section>
            <div>
              <label>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
              <select name="dateRange">
                <% (filters.dateRanges || ['7d','14d','30d','90d','custom']).forEach(range => { %>
                  <option value="<%= range %>"><%= range.toUpperCase() %></option>
                <% }) %>
              </select>
            </div>
            <div>
              <label>Channel</label>
              <select name="channel">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <% (filters.channels || ['1-1','group','portal']).forEach(ch => { %>
                  <option value="<%= ch %>"><%= ch %></option>
                <% }) %>
              </select>
            </div>
            <div>
              <label>Project</label>
              <select name="project">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <% (filters.projects || []).forEach(project => { %>
                  <option value="<%= project %>"><%= project %></option>
                <% }) %>
              </select>
            </div>
            <div>
              <label>Customer Code</label>
              <input type="text" name="customer_code" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" />
            </div>
            <div>
              <label>Agent</label>
              <select name="agent">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <% (filters.agents || []).forEach(agent => { %>
                  <option value="<%= agent.id || agent %>"><%= agent.name || agent %></option>
                <% }) %>
              </select>
            </div>
            <div>
              <label>Intent</label>
              <select name="intent">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <% (filters.intents || []).forEach(intent => { %>
                  <option value="<%= intent %>"><%= intent %></option>
                <% }) %>
              </select>
            </div>
            <div>
              <label>Sentiment</label>
              <select name="sentiment">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="positive">Positive</option>
                <option value="neutral">Neutral</option>
                <option value="negative">Negative</option>
              </select>
            </div>
            <div class="filter-actions">
              <button type="submit" class="btn primary">Apply</button>
              <button type="button" class="btn ghost" data-export="json">Export JSON</button>
              <button type="button" class="btn ghost" data-export="csv">Export CSV</button>
            </div>
          </form>
        </div>
        <div class="insight-metrics row-kpi">
          <article class="metric-card primary">
            <span class="metric-label">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ Active (7 ‡∏ß‡∏±‡∏ô)</span>
            <div class="metric-value"><%= fmtCount(chatStats.active7d) %><span>‡∏Ñ‡∏ô</span></div>
            <span class="metric-sub">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <%= fmtCount(chatStats.totalUsers) %> ‡∏Ñ‡∏ô</span>
          </article>
          <article class="metric-card">
            <span class="metric-label">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà (7 ‡∏ß‡∏±‡∏ô)</span>
            <div class="metric-value"><%= fmtCount(chatStats.new7d) %><span>‡∏Ñ‡∏ô</span></div>
            <span class="metric-sub"><%= chatStats.active7d ? ((chatStats.new7d / Math.max(chatStats.active7d, 1)) * 100).toFixed(1) : '0.0' %>% ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà active</span>
          </article>
          <article class="metric-card">
            <span class="metric-label">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤</span>
            <div class="metric-value"><%= fmtCount(chatStats.returning7d) %><span>‡∏Ñ‡∏ô</span></div>
            <span class="metric-sub">‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô</span>
          </article>
          <article class="metric-card">
            <span class="metric-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (7 ‡∏ß‡∏±‡∏ô)</span>
            <div class="metric-value"><%= fmtCount(chatStats.messages7d) %><span>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span></div>
            <span class="metric-sub">‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <%= fmtCount(chatStats.messagesTotal) %> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
          </article>
        </div>
        <details class="metric-definitions">
          <summary>Metric Definitions</summary>
          <ul>
            <li><strong>Active Users (7d)</strong> = COUNT(DISTINCT user_id) WHERE message_ts &ge; (CURRENT_DATE - INTERVAL '7 day')</li>
            <li><strong>Returning Users</strong> = Active 7d AND EXISTS message between 8‚Äì30 days ago</li>
            <li><strong>First Reply Time</strong> = MIN(agent_ts) - MIN(user_ts) per conversation</li>
            <li><strong>SLA%</strong> = conversations WHERE first_reply_time &le; SLA target √∑ total conversations</li>
            <li><strong>Retention</strong> = returning_users / cohort_users per week offset</li>
            <li><strong>Churn Risk</strong> = gap &gt; 2√ó median gap OR last 3 sentiments &le; 0</li>
          </ul>
        </details>
        <div class="insight-row row-timeseries">
          <div class="card glass insight-chart chart-card full" data-chart-trend='<%- interactionSeriesJSON %>' data-drilldown="interaction-volume">
            <div class="card-heading chart-card__header">
              <h3>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô</h3>
              <span class="muted">‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á 7 / 14 / 30 / 90 ‡∏ß‡∏±‡∏ô</span>
            </div>
            <div class="chart-frame chart-card__body">
              <canvas id="chat-trend-chart" height="240"></canvas>
              <div class="chart-fallback">
                <strong>Top Activity</strong>
                <ul>
                  <% interactionSeries.slice(-5).forEach((row) => { %>
                    <li>
                      <strong><%= new Date(`${row.date}T00:00:00`).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }) %></strong>
                      ¬∑ <%= Number(row.messageCount || 0).toLocaleString('th-TH') %> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ¬∑
                      <%= Number(row.uniqueUsers || 0).toLocaleString('th-TH') %> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                    </li>
                  <% }) %>
                </ul>
              </div>
            </div>
            <p class="chart-note">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô</p>
            <details class="card-foot chart-card__footer query-toggle">
              <summary>‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£ / Query</summary>
              <pre><code>SELECT date::date AS d,
SUM(CASE WHEN direction='in' THEN 1 ELSE 0 END) AS inbound,
SUM(CASE WHEN direction='out' THEN 1 ELSE 0 END) AS outbound
FROM fact_chat_message
WHERE timestamp BETWEEN $start AND $end
GROUP BY 1 ORDER BY 1</code></pre>
            </details>
          </div>
          <div class="card glass insight-chart chart-card" data-heatmap='<%- heatmapJSON %>' data-drilldown="keyword-intent-heatmap">
            <div class="card-heading chart-card__header">
              <h3>Heatmap ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
              <span class="muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö hour √ó weekday</span>
            </div>
            <div class="chart-frame chart-card__body">
              <canvas id="chat-heatmap-chart" height="240"></canvas>
              <div class="chart-fallback">
                <strong>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</strong>
                <ul>
                  <% heatmapTopSlots.forEach((slot) => { %>
                    <li>
                      <strong>‡∏ß‡∏±‡∏ô <%= ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'][Number(slot.dow || slot.day || 0)] || slot.dow %></strong>
                      ‡πÄ‡∏ß‡∏•‡∏≤ <%= String(slot.hour || slot.h || 0).padStart(2,'0') %>:00 ¬∑
                      <%= Number(slot.volume || slot.count || 0).toLocaleString('th-TH') %> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                    </li>
                  <% }) %>
                </ul>
              </div>
            </div>
            <p class="chart-note">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÅ‡∏ä‡∏ó‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡πÄ‡∏Ç‡πâ‡∏°=‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏≤‡∏Å)</p>
            <details class="card-foot chart-card__footer query-toggle">
              <summary>‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£ / Query</summary>
              <pre><code>SELECT EXTRACT(DOW FROM timestamp) AS dow,
EXTRACT(HOUR FROM timestamp) AS hour,
COUNT(*) AS volume
FROM fact_chat_message
WHERE timestamp BETWEEN $start AND $end
GROUP BY 1,2</code></pre>
            </details>
          </div>
          <div class="card glass insight-chart chart-card" data-sentiment='<%- sentimentTrendJSON %>' data-drilldown="sentiment-trend">
            <div class="card-heading chart-card__header">
              <h3>Sentiment Distribution</h3>
              <span class="muted">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏ß‡∏Å/‡∏Å‡∏•‡∏≤‡∏á/‡∏•‡∏ö ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 14 ‡∏ß‡∏±‡∏ô</span>
            </div>
            <div class="chart-frame sentiment">
              <canvas id="sentiment-pie-chart" height="220"></canvas>
              <div class="chart-fallback">
                <strong>‡∏£‡∏ß‡∏° 14 ‡∏ß‡∏±‡∏ô</strong>
                <ul>
                  <li>Positive ¬∑ <%= sentimentTotals.positive.toLocaleString('th-TH') %> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</li>
                  <li>Neutral ¬∑ <%= sentimentTotals.neutral.toLocaleString('th-TH') %> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</li>
                  <li>Negative ¬∑ <%= sentimentTotals.negative.toLocaleString('th-TH') %> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</li>
                </ul>
              </div>
            </div>
            <p class="chart-note">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏ß‡∏Å/‡∏Å‡∏•‡∏≤‡∏á/‡∏•‡∏ö ‡πÉ‡∏ô‡∏£‡∏≠‡∏ö 14 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
            <details class="card-foot chart-card__footer query-toggle">
              <summary>‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£ / Query</summary>
              <pre><code>SELECT sentiment_label,
COUNT(*) AS cnt,
AVG(sentiment_score) AS avg_score
FROM fact_chat_message
WHERE timestamp BETWEEN $start AND $end
GROUP BY 1</code></pre>
            </details>
          </div>
        </div>

        <div class="insight-row row-intents">
          <div class="card glass insight-chart chart-card" data-intent-stack='<%- intentStackJSON %>' data-drilldown="intent-distribution">
            <div class="card-heading chart-card__header">
              <h3>Intent Distribution</h3>
              <span class="muted">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô Inquiry / Order / Complaint / ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</span>
            </div>
            <div class="chart-frame chart-card__body">
              <canvas id="intent-stack-chart" height="260"></canvas>
              <div class="chart-fallback">
                <strong>Intent ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</strong>
                <ul>
                  <% Object.entries(intentTotals).slice(0,6).forEach(([label,value]) => { %>
                    <li><strong><%= label %></strong> ¬∑ <%= Number(value).toLocaleString('th-TH') %> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</li>
                  <% }) %>
                </ul>
              </div>
            </div>
            <p class="chart-note">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î (Inquiry, Order, Complaint ‡∏Ø‡∏•‡∏Ø) ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</p>
            <details class="card-foot chart-card__footer query-toggle">
              <summary>‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£ / Query</summary>
              <pre><code>SELECT week_start, intent_category, COUNT(*)
FROM fact_chat_message
GROUP BY 1,2</code></pre>
            </details>
          </div>
          <div class="card glass keyword-card" data-drilldown="top-keywords">
            <div class="card-heading chart-card__header">
              <h3>Top Keywords Cloud</h3>
              <span class="muted">N-grams (stopwords removed)</span>
            </div>
            <div class="chart-frame keyword">
              <div id="keyword-cloud" class="keyword-cloud" data-keyword-cloud='<%- keywordCloudJSON %>'></div>
            </div>
            <p class="chart-note">‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á‡∏ö‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏≥‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</p>
            <details class="card-foot chart-card__footer query-toggle">
              <summary>‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£ / Query</summary>
              <pre><code>SELECT keyword, SUM(weight) AS score
FROM keyword_stats
WHERE period='current'
GROUP BY 1
ORDER BY score DESC LIMIT 200</code></pre>
            </details>
          </div>
          <div class="card glass insight-chart chart-card" data-consent-status='<%- consentStatusJSON %>' data-drilldown="consent-status">
            <div class="card-heading chart-card__header">
              <h3>Consent Status</h3>
              <span class="muted">Granted / Pending / Revoked</span>
            </div>
            <div class="chart-frame chart-card__body">
              <canvas id="consent-status-chart" height="240"></canvas>
            </div>
            <p class="chart-note">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
            <details class="card-foot chart-card__footer query-toggle">
              <summary>‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£ / Query</summary>
              <pre><code>SELECT latest_status, COUNT(*)
FROM consent_audit_latest
GROUP BY 1</code></pre>
            </details>
          </div>
          <div class="card glass sentiment-cloud" data-drilldown="sentiment-wordcloud">
            <div class="card-heading chart-card__header">
              <h3>Word Clouds ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Sentiment</h3>
            </div>
            <div class="sentiment-cloud-wrap" data-sentiment-cloud='<%- sentimentCloudJSON %>'>
              <div class="sentiment-column" data-sentiment="positive">
                <h4>Positive</h4>
                <div class="cloud-list"></div>
              </div>
              <div class="sentiment-column" data-sentiment="negative">
                <h4>Negative</h4>
                <div class="cloud-list"></div>
              </div>
            </div>
            <p class="chart-note">‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏ß‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à/‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à</p>
          </div>
        </div>

        <div class="insight-row row-agent">
          <div class="card glass funnel-card" data-funnel='<%- funnelJSON %>' data-drilldown="conversion-funnel">
            <div class="card-heading chart-card__header">
              <h3>Conversion Funnel</h3>
              <span class="muted">Inquiry ‚Üí Quote ‚Üí PO ‚Üí Payment ‚Üí Delivered</span>
            </div>
            <div class="chart-frame chart-card__body">
              <canvas id="conversion-funnel-chart" height="260"></canvas>
              <div class="chart-fallback">
                <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡πâ‡∏ô</strong>
                <ul>
                  <% funnelTotals.forEach((item) => { %>
                    <li><strong><%= item.stage %></strong> ¬∑ <%= Number(item.count).toLocaleString('th-TH') %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>
                  <% }) %>
                </ul>
              </div>
            </div>
            <p class="chart-note">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏•‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‚Üí ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ‚Üí ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</p>
            <details class="card-foot chart-card__footer query-toggle">
              <summary>‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£ / Query</summary>
              <pre><code>SELECT stage, COUNT(*)
FROM conversion_events
WHERE event_ts BETWEEN $start AND $end
GROUP BY stage
ORDER BY stage_order</code></pre>
            </details>
          </div>
          <div class="card glass insight-chart chart-card" data-agent-response='<%- agentResponseJSON %>' data-drilldown="agent-response">
            <div class="card-heading chart-card__header">
              <h3>Agent Response Time</h3>
              <span class="muted">Avg / Median / P90 + SLA Target</span>
            </div>
            <div class="chart-frame chart-card__body">
              <canvas id="agent-response-chart" height="260"></canvas>
              <div class="chart-fallback">
                <strong>‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</strong>
                <ul>
                  <% agentResponseData.slice(0,6).forEach((agent) => { %>
                    <li>
                      <strong><%= agent.name || agent.agent_id %></strong>
                      ¬∑ <%= Number(agent.avgFirstReplySec || agent.avg || 0).toFixed(0) %>s ¬∑ SLA <%= ((agent.slaPct || 0) * 100).toFixed(1) %>%
                    </li>
                  <% }) %>
                </ul>
              </div>
            </div>
            <p class="chart-note">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏°‡∏±‡∏ò‡∏¢‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏≠‡πÄ‡∏à‡∏ô‡∏ï‡πå ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ SLA ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô</p>
            <details class="card-foot chart-card__footer query-toggle">
              <summary>‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£ / Query</summary>
              <pre><code>SELECT agent_id,
AVG(first_reply_sec) AS avg,
PERCENTILE_CONT(0.5) WITHIN GROUP(ORDER BY first_reply_sec) AS median,
PERCENTILE_CONT(0.9) WITHIN GROUP(ORDER BY first_reply_sec) AS p90,
AVG(CASE WHEN first_reply_sec &lt;= 300 THEN 1 ELSE 0 END) AS sla_pct
FROM agent_metrics
WHERE week_start BETWEEN $start AND $end
GROUP BY agent_id</code></pre>
            </details>
          </div>
          <div class="card glass" data-drilldown="agent-performance-table">
            <div class="card-heading chart-card__header">
              <h3>Agent Leaderboard</h3>
              <span class="muted">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° SLA% ‡πÅ‡∏•‡∏∞ Sentiment</span>
            </div>
            <div class="table-wrap table-scroll">
              <table class="table compact ghost">
                <thead>
                  <tr>
                    <th>Agent</th>
                    <th class="right">Conversations</th>
                    <th class="right">First Reply (avg)</th>
                    <th class="right">SLA%</th>
                    <th class="right">Avg Sentiment</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (agentLeaderboard.length) { %>
                    <% agentLeaderboard.forEach(agent => { %>
                      <tr>
                        <td><strong><%= agent.name || agent.agent_id %></strong></td>
                        <td class="right"><%= fmtCount(agent.conversationCount) %></td>
                        <td class="right"><%= (agent.avgFirstReplySec || 0).toFixed(1) %>s</td>
                        <td class="right"><%= ((agent.slaPct || 0) * 100).toFixed(1) %>%</td>
                        <td class="right"><%= (agent.avgSentiment || 0).toFixed(2) %></td>
                      </tr>
                    <% }) %>
                  <% } else { %>
                    <tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡πÄ‡∏à‡∏ô‡∏ï‡πå</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
            <p class="chart-note">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ô‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ sentiment ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏£‡∏∏‡∏Å</p>
            <p class="chart-note">‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°</p>
          </div>
        </div>

        <div class="insight-row row-engagement">
          <div class="card glass" data-drilldown="customer-engagement">
            <div class="card-heading chart-card__header">
              <h3>Top Customers by Engagement</h3>
              <span class="muted">Ranking ‡πÇ‡∏î‡∏¢ Frequency ¬∑ Sessions ¬∑ Sentiment</span>
            </div>
            <div class="table-wrap table-scroll">
              <table class="table compact ghost">
                <thead>
                  <tr>
                    <th>Customer</th>
                    <th class="right">Messages</th>
                    <th class="right">Sessions</th>
                    <th class="right">Avg Sentiment</th>
                    <th class="right">Engagement Score</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (topCustomers.length) { %>
                    <% topCustomers.forEach(c => { %>
                      <tr>
                        <td><strong><%= c.displayName || c.user_id %></strong></td>
                        <td class="right"><%= fmtCount(c.messageCount) %></td>
                        <td class="right"><%= fmtCount(c.sessionCount) %></td>
                        <td class="right"><%= (c.sentimentAvg || 0).toFixed(2) %></td>
                        <td class="right"><%= (c.engagementScore || 0).toFixed(1) %></td>
                      </tr>
                    <% }) %>
                  <% } else { %>
                    <tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• engagement</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
            <p class="chart-note">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÇ‡∏î‡∏¢‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô sentiment</p>
            <details class="card-foot chart-card__footer query-toggle">
              <summary>‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£ / Query</summary>
              <pre><code>SELECT user_id,
COUNT(*) AS messages,
COUNT(DISTINCT conversation_id) AS sessions,
AVG(sentiment_score) AS avg_sentiment,
engagement_score
FROM user_daily_metrics
WHERE date BETWEEN $start AND $end
ORDER BY engagement_score DESC
LIMIT 20</code></pre>
            </details>
          </div>
        </div>

        <div class="insight-row row-retention">
          <div class="card glass insight-chart chart-card" data-retention='<%- retentionJSON %>' data-drilldown="retention-cohort">
            <div class="card-heading chart-card__header">
              <h3>Retention Cohort</h3>
              <span class="muted">Cohort ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</span>
            </div>
            <div class="chart-frame chart-card__body">
              <canvas id="retention-cohort-chart" height="260"></canvas>
              <div class="chart-fallback">
                <strong>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤</strong>
                <ul>
                  <% retentionSummary.forEach((row) => { %>
                    <li>
                      Cohort <strong><%= row.cohort %></strong> ¬∑ ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå <%= row.weekOffset %>
                      ¬∑ <%= ((row.rate || 0) * 100).toFixed(1) %>%
                    </li>
                  <% }) %>
                </ul>
              </div>
            </div>
            <p class="chart-note">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Ñ‡∏∏‡∏¢‡∏ã‡πâ‡∏≥‡∏´‡∏•‡∏±‡∏á onboarding ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</p>
            <details class="card-foot chart-card__footer query-toggle">
              <summary>‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£ / Query</summary>
              <pre><code>SELECT cohort_week,
week_offset,
returning_users / total_users AS rate
FROM retention_cohorts</code></pre>
            </details>
          </div>
          <div class="card glass" data-drilldown="churn-risk">
            <div class="card-heading chart-card__header">
              <h3>Churn Risk (Top 10)</h3>
              <span class="muted">‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° &gt; 2√ó median ‡∏´‡∏£‡∏∑‡∏≠ sentiment ‡∏ï‡∏¥‡∏î‡∏•‡∏ö</span>
            </div>
            <div class="table-wrap table-scroll">
              <table class="table compact ghost">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Last Seen</th>
                    <th>Gap (days)</th>
                    <th>Sentiment Trend</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (churnList.length) { %>
                    <% churnList.forEach(item => { %>
                      <tr>
                        <td><strong><%= item.displayName || item.user_id %></strong></td>
                        <td><%= item.lastSeen ? new Date(item.lastSeen).toLocaleDateString('th-TH') : '-' %></td>
                        <td class="right"><%= (item.gapDays || 0).toFixed(1) %></td>
                        <td class="right"><%= (item.sentimentTrend || 0).toFixed(2) %></td>
                      </tr>
                    <% }) %>
                  <% } else { %>
                    <tr><td colspan="4" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á churn</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card glass" data-drilldown="anomaly-alerts">
            <div class="card-heading chart-card__header">
              <h3>Escalation &amp; Complaint Alerts</h3>
              <span class="muted">‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö negativity spike</span>
            </div>
            <div class="table-wrap table-scroll">
              <table class="table compact ghost">
                <thead>
                  <tr>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th>Metric</th>
                    <th>Œî Sigma</th>
                    <th>Keyword</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (anomalyList.length) { %>
                    <% anomalyList.forEach(alert => { %>
                      <tr>
                        <td><%= alert.date ? new Date(alert.date).toLocaleDateString('th-TH') : '-' %></td>
                        <td><strong><%= alert.metric %></strong></td>
                        <td class="right"><%= (alert.deltaSigma || 0).toFixed(2) %></td>
                        <td><%= alert.keyword || '-' %></td>
                      </tr>
                    <% }) %>
                  <% } else { %>
                    <tr><td colspan="4" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
            <p class="chart-note">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏ö‡∏ó‡∏µ‡πà‡∏û‡∏∏‡πà‡∏á‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
            <details class="card-foot chart-card__footer query-toggle">
              <summary>‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£ / Query</summary>
              <pre><code>INSERT INTO anomalies(date, metric, delta_sigma)
SELECT day, 'complaints', z_score
FROM complaint_spike_detector</code></pre>
            </details>
          </div>
        </div>

        <div class="insight-row row-network">
          <div class="card glass network-card" data-drilldown="customer-agent-network">
            <div class="card-heading chart-card__header">
              <h3>Customer ‚Üî Agent Network</h3>
              <span class="muted">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</span>
            </div>
            <div class="chart-frame network">
              <ul class="network-list">
                <% if (networkLinksSorted.length) { %>
                  <% networkLinksSorted.forEach((link) => { %>
                    <% const sourceLabel = networkNodeLabel.get(link.source) || link.source; %>
                    <% const targetLabel = networkNodeLabel.get(link.target) || link.target; %>
                    <li>
                      <span class="network-party customer"><%= sourceLabel %></span>
                      <span class="network-connector">‚Üî</span>
                      <span class="network-party agent"><%= targetLabel %></span>
                      <span class="network-volume"><%= Number(link.conversations || 0).toLocaleString('th-TH') %> ‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</span>
                    </li>
                  <% }) %>
                <% } else { %>
                  <li class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ</li>
                <% } %>
              </ul>
            </div>
            <p class="chart-note">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏≠‡πÄ‡∏à‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡∏°</p>
            <details class="card-foot chart-card__footer query-toggle">
              <summary>‡∏î‡∏π‡∏™‡∏π‡∏ï‡∏£ / Query</summary>
              <pre><code>SELECT user_id,
agent_id,
COUNT(*) AS conversations
FROM fact_conversation
WHERE first_agent_reply_ts IS NOT NULL
GROUP BY 1,2</code></pre>
            </details>
          </div>
        </div>

        <div class="insight-table-grid row-legacy">
          <div class="card glass">
            <div class="card-heading chart-card__header">
              <h3>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h3>
            </div>
            <div class="table-wrap table-scroll">
              <table class="table compact ghost">
                <thead>
                  <tr>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  </tr>
                </thead>
                <tbody>
                  <% const msgKeys = Object.keys(chat.messageTypeCount || {}); %>
                  <% msgKeys.forEach(key => { %>
                    <tr>
                      <td><%= key %></td>
                      <td class="right"><%= fmtCount(chat.messageTypeCount[key]) %></td>
                    </tr>
                  <% }) %>
                  <% if (!msgKeys.length) { %>
                    <tr><td colspan="2" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ä‡∏ó</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card glass">
            <div class="card-heading chart-card__header">
              <h3>‡∏´‡∏°‡∏ß‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î</h3>
            </div>
            <div class="table-wrap table-scroll">
              <table class="table compact ghost">
                <thead>
                  <tr>
                    <th>‡∏´‡∏°‡∏ß‡∏î</th>
                    <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</th>
                  </tr>
                </thead>
                <tbody>
                  <% (chat.topicSummary || []).forEach(item => { %>
                    <tr>
                      <td><strong><%= item.label %></strong></td>
                      <td class="right"><%= fmtCount(item.count) %></td>
                      <td>
                        <% (item.samples || []).forEach(sample => { %>
                          <div class="muted">‚Ä¢ <%= sample %></div>
                        <% }) %>
                      </td>
                    </tr>
                  <% }) %>
                  <% if (!chat.topicSummary || chat.topicSummary.length === 0) { %>
                    <tr><td colspan="3" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card glass">
            <div class="card-heading chart-card__header">
              <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            </div>
            <div class="table-wrap table-scroll">
              <table class="table compact ghost">
                <thead>
                  <tr>
                    <th>Display Name</th>
                    <th>userId</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                  </tr>
                </thead>
                <tbody>
                  <% (chat.latestUsers || []).forEach(u => { %>
                    <tr>
                      <td><strong><%= u.displayName %></strong></td>
                      <td><code><%= u.userId %></code></td>
                      <td>
                        <% if (u.status === 'granted') { %>
                          <span class="badge success">granted</span>
                        <% } else if (u.status === 'pending') { %>
                          <span class="badge warn">pending</span>
                        <% } else { %>
                          <span class="badge gray"><%= u.status %></span>
                        <% } %>
                      </td>
                      <td><%= u.updatedAt ? new Date(u.updatedAt).toLocaleString('th-TH') : '-' %></td>
                    </tr>
                  <% }) %>
                  <% if (!chat.latestUsers || chat.latestUsers.length === 0) { %>
                    <tr><td colspan="4" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card glass logic-card">
          <div class="card-heading chart-card__header">
            <h3>Analytics Logic &amp; Pipelines</h3>
            <span class="muted">10 ‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö</span>
          </div>
          <div class="logic-list">
            <ol>
              <% logicModules.forEach((module) => { %>
                <li>
                  <strong><%= module.name %></strong> ‚Äì <%= module.description %>
                  <pre><code><%= module.query %></code></pre>
                </li>
              <% }) %>
            </ol>
          </div>
        </div>

        <div class="card glass checklist-card">
          <div class="card-heading chart-card__header">
            <h3>Coverage Checklist</h3>
            <span class="muted">10 Analysis ¬∑ 10 Charts ¬∑ 10 Logics</span>
          </div>
          <% const checklist = {
               analysis: ['Customer Interaction Volume','Response Time Analysis','Topic/Intent Distribution','Sentiment Trend','Top Customers by Engagement','Keyword/Intent Heatmap','Agent Performance','Conversion Funnel','Customer Lifecycle/Retention','Escalation/Complaint Detection'],
               charts: ['Messages Time Series','Intent Stacked Bar','Sentiment Pie+Trend','Active Hours Heatmap','Top Keywords Cloud','Conversion Funnel','Agent Response Bar','Customer-Agent Network','Retention Cohort','Word Clouds by Sentiment'],
               logic: ['Intent Classification','Sentiment Analysis','Entity Extraction','User Profiling','Engagement Scoring','Response Efficiency','Conversation Clustering','Churn Prediction','Next Best Action','Anomaly Detection']
             }; %>
          <div class="checklist-columns">
            <div>
              <h4>Analysis</h4>
              <ul>
                <% checklist.analysis.forEach(item => { %>
                  <li>‚úÖ <%= item %></li>
                <% }) %>
              </ul>
            </div>
            <div>
              <h4>Charts</h4>
              <ul>
                <% checklist.charts.forEach(item => { %>
                  <li>‚úÖ <%= item %></li>
                <% }) %>
              </ul>
            </div>
            <div>
              <h4>Logic Pipelines</h4>
              <ul>
                <% checklist.logic.forEach(item => { %>
                  <li>‚úÖ <%= item %></li>
                <% }) %>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="summary-cards" data-dashboard-section="core">
      <article class="summary-card">
        <div class="summary-label">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏°</div>
        <div class="summary-value"><%= fmtTons(totals.totalTons, { max: 2 }) %><small>‡∏ï‡∏±‡∏ô</small></div>
        <span class="summary-foot">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</span>
      </article>
      <article class="summary-card">
        <div class="summary-label">BUY</div>
        <div class="summary-value"><%= fmtTons(totals.buyTons) %><small>‡∏ï‡∏±‡∏ô</small></div>
        <span class="summary-foot"><%= totals.totalTons ? ((totals.buyTons / totals.totalTons) * 100).toFixed(1) : 0 %>% ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
      </article>
      <article class="summary-card">
        <div class="summary-label">SELL</div>
        <div class="summary-value"><%= fmtTons(totals.sellTons) %><small>‡∏ï‡∏±‡∏ô</small></div>
        <span class="summary-foot"><%= totals.totalTons ? ((totals.sellTons / totals.totalTons) * 100).toFixed(1) : 0 %>% ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
      </article>
      <article class="summary-card">
        <div class="summary-label">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ LINE</div>
        <div class="summary-value"><%= fmtCount(chat.distinctUsers) %><small>‡∏Ñ‡∏ô</small></div>
        <span class="summary-foot"><%= fmtCount(chat.recentCount) %> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
      </article>
    </section>

    <section class="panel-block" id="map-overview" data-dashboard-section="core">
      <div
        class="dashboard-map-card"
        data-province-map
        data-map-payload='<%- provinceDataJSON %>'
        data-mapbox-token="<%= mapboxToken || '' %>">
        <div class="map-card-header">
          <span class="tag">Real-time map</span>
          <h3>‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</h3>
          <p>‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <strong><%= fmtCount(provinceStats.totalLocations) %></strong> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
        </div>
        <div class="map-card-body">
          <div class="map-card-figure <%= hasProvinceCoords ? 'has-data' : '' %>">
            <div class="map-placeholder">
              <img src="/static/img/Locations.png" alt="Locations illustration" />
            </div>
            <div class="province-map" data-map-canvas></div>
            <% if (hasProvinceCoords) { %>
              <div class="map-overlay">
                <div>
                  <span>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                  <strong><%= fmtCount(provinceStats.totalLocations) %></strong>
                </div>
                <div>
                  <span>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</span>
                  <strong><%= fmtCount(provinceStats.provincesWithCoords) %></strong>
                </div>
              </div>
            <% } %>
            <% if (!hasProvinceCoords) { %>
              <div class="map-empty">
                <div class="map-empty__icon">üõ∞Ô∏è</div>
                <div class="map-empty__text">
                  <strong>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î</strong>
                  <span>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ä‡∏£‡πå location ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span>
                  <small>Tip: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‚Äú‡πÅ‡∏ä‡∏£‡πå‡∏û‡∏¥‡∏Å‡∏±‡∏î‚Äù ‡πÉ‡∏ô LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö</small>
                </div>
              </div>
            <% } %>
          </div>
          <aside class="map-card-sidebar">
            <div class="map-stat">
              <span>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
              <strong><%= fmtCount(provinceStats.uniqueUsers) %></strong>
            </div>
            <div class="map-stat">
              <span>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
              <strong><%= fmtCount(provinceStats.provincesWithCoords) %></strong>
              <small>‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <%= fmtCount(provinceStats.totalProvinces) %></small>
            </div>
            <ul class="map-top-list">
              <% if (provinceTopList.length) { %>
                <% provinceTopList.forEach(function(item, idx){
                     const provinceName = (item.province || '').replace(/^‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î\s*/, '');
                %>
                  <li>
                    <span class="rank"><%= idx + 1 %></span>
                    <div>
                      <strong><%= provinceName || item.province %></strong>
                      <small><%= fmtCount(item.count) %> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</small>
                    </div>
                  </li>
                <% }) %>
              <% } else { %>
                <li class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</li>
              <% } %>
            </ul>
            <% if (provinceStats.lastUpdatedAt) { %>
              <span class="map-updated">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <%= new Date(provinceStats.lastUpdatedAt).toLocaleString('th-TH') %></span>
            <% } %>
          </aside>
        </div>
      </div>
    </section>

    <section class="panel-block" id="excel" data-dashboard-section="core">
      <div class="panel-heading">
        <div>
          <h2>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
          <p>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
        </div>
      </div>
      <div class="panel-body panel__body grid-2 gap-xl">
        <div class="card glass donut-card">
          <div class="card-heading chart-card__header">
            <h3>Top ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <span class="muted">‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 8 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
          </div>
          <div class="donut-layout">
            <div class="donut-wrap" data-chart="product" data-chart-payload='<%- JSON.stringify(productChart || []) %>' data-chart-total="<%= productChartTotal %>">
              <canvas width="260" height="260"></canvas>
              <div class="donut-total">
                <span>‡∏£‡∏ß‡∏°</span>
                <strong><%= fmtTons(productChartTotal, { min: 0, max: 0 }) %></strong>
                <small>‡∏ï‡∏±‡∏ô</small>
              </div>
            </div>
            <div class="donut-legend">
              <% if (productChart && productChart.length) { %>
                <ul>
                  <% (productChart || []).forEach((item, idx) => { %>
                    <% const percent = productChartTotal ? Math.round((item.totalTons / productChartTotal) * 10000) / 100 : 0; %>
                    <% const qty = formatQuantity(item.product, '', item.totalTons); %>
                    <li>
                      <span class="donut-legend__dot" data-color-index="<%= idx %>"></span>
                      <div>
                        <strong><%= item.product %></strong>
                        <span><%= `${qty.formatted} ${qty.unit} ¬∑ ${percent.toFixed(1)}%` %></span>
                      </div>
                    </li>
                  <% }) %>
                </ul>
              <% } else { %>
                <p class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
              <% } %>
            </div>
          </div>
        </div>
        <div class="card glass">
          <div class="card-heading chart-card__header">
            <h3>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° 7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</h3>
            <span class="muted">‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</span>
          </div>
          <div class="table-wrap table-scroll">
            <table class="table compact ghost">
              <thead>
                <tr>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th class="right">‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ô</th>
                  <th class="right">BUY</th>
                  <th class="right">SELL</th>
                  <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß</th>
                </tr>
              </thead>
              <tbody>
                <% (dailySeries || []).forEach(day => { %>
                  <tr>
                    <td><strong><%= day.date %></strong></td>
                    <td class="right"><%= fmtTons(day.totalTons) %></td>
                    <td class="right"><%= fmtTons(day.buyTons) %></td>
                    <td class="right"><%= fmtTons(day.sellTons) %></td>
                    <td class="right"><%= fmtCount(day.entryCount) %></td>
                  </tr>
                <% }) %>
                <% if (!dailySeries || dailySeries.length === 0) { %>
                  <tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</td></tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="panel-body panel__body">
        <div class="card glass">
          <div class="card-heading chart-card__header">
            <h3>‡∏™‡∏£‡∏∏‡∏õ MIX ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h3>
            <span class="muted">‡∏£‡∏ß‡∏° netWeight <strong><%= fmtTons(mixSummaryTotalTons || 0, { max: 2 }) %></strong> ‡∏ï‡∏±‡∏ô</span>
          </div>
          <div class="table-wrap table-scroll">
            <table class="table compact ghost">
              <thead>
                <tr>
                  <th>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Name)</th>
                  <th>‡∏£‡∏´‡∏±‡∏™</th>
                  <th>Mix</th>
                  <th class="right">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (‡∏ï‡∏±‡∏ô)</th>
                  <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß</th>
                </tr>
              </thead>
              <tbody>
                <% if (mixSummary && mixSummary.length) { %>
                  <% mixSummary.forEach(item => { %>
                    <tr>
                      <td><strong><%= item.projectName %></strong></td>
                      <td><%= item.projectCode || '-' %></td>
                      <td><%= item.mixName || '-' %></td>
                      <td class="right"><%= fmtTons(item.totalNetWeightTons, { max: 2 }) %></td>
                      <td class="right"><%= fmtCount(item.entryCount) %></td>
                    </tr>
                  <% }) %>
                <% } else { %>
                  <tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å MIX</td></tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="panel-body panel__body">
        <div class="card glass line-card" data-chart="daily-lines" data-chart-payload='<%- dailySeriesPayload %>'>
          <div class="card-heading chart-card__header">
            <h3>‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
            <span class="muted">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (‡∏ï‡∏±‡∏ô)</span>
          </div>
          <div class="line-chart-wrap">
            <canvas height="220"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section class="panel-block" id="companies" data-dashboard-section="core">
      <div class="panel-heading">
        <div>
          <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h2>
          <p>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
        </div>
      </div>
      <div class="panel-body panel__body grid-2 gap-xl">
        <div class="card glass">
          <div class="card-heading chart-card__header">
            <h3>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</h3>
          </div>
          <div class="table-wrap table-scroll">
            <table class="table compact ghost">
              <thead>
                <tr>
                  <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
                  <th class="right">‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ô</th>
                  <th class="right">BUY</th>
                  <th class="right">SELL</th>
                  <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß</th>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                </tr>
              </thead>
              <tbody>
                <% (companySummary || []).forEach(item => { %>
                  <tr>
                    <td><strong><%= item.name %></strong></td>
                    <td class="right"><%= fmtTons(item.totalTons) %></td>
                    <td class="right"><%= fmtTons(item.buyTons) %></td>
                    <td class="right"><%= fmtTons(item.sellTons) %></td>
                    <td class="right"><%= fmtCount(item.entryCount) %></td>
                    <td><%= item.latestDate || '-' %></td>
                  </tr>
                <% }) %>
                <% if (!companySummary || companySummary.length === 0) { %>
                  <tr><td colspan="6" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card glass">
          <div class="card-heading chart-card__header">
            <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</h3>
          </div>
          <div class="table-wrap table-scroll">
            <table class="table compact ghost">
              <thead>
                <tr>
                  <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                  <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                  <th class="right">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</th>
                  <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                  <th>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                </tr>
              </thead>
              <tbody>
                <% (latestRecords || []).forEach(rec => { %>
                  <% const qty = formatQuantity(rec.product, rec.unit, rec.weightTons); %>
                  <tr>
                    <td><strong><%= rec.companyId ? rec.companyId.name : (rec.sourceCompanyName || rec.sourceCompanyId || 'Unknown') %></strong></td>
                    <td><%= rec.dateStr %></td>
                    <td><%= rec.type || '-' %></td>
                    <td><%= rec.product || '-' %></td>
                    <td class="right"><%= qty.formatted %></td>
                    <td><%= qty.unit %></td>
                    <td><%= rec.createdAt ? new Date(rec.createdAt).toLocaleString('th-TH') : '-' %></td>
                  </tr>
                <% }) %>
                <% if (!latestRecords || latestRecords.length === 0) { %>
                  <tr><td colspan="7" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</td></tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="panel-block" id="tools" data-dashboard-section="core">
      <div class="panel-heading">
        <div>
          <h2>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏î‡πà‡∏ß‡∏ô</h2>
          <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>
      </div>
      <div class="panel-body panel__body quick-actions">
        <a class="action-card" href="/admin/upload">
          <span class="icon">‚§¥Ô∏è</span>
          <span>
            <strong>Upload Excel</strong>
            <em>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</em>
          </span>
        </a>
        <a class="action-card" href="/admin/test">
          <span class="icon">üß™</span>
          <span>
            <strong>Test &amp; Send</strong>
            <em>‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß LINE</em>
          </span>
        </a>
        <a class="action-card" href="/admin/richmenu">
          <span class="icon">üß≠</span>
          <span>
            <strong>Rich Menu</strong>
            <em>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</em>
          </span>
        </a>
        <a class="action-card" href="/admin/tools/purge">
          <span class="icon">üóëÔ∏è</span>
          <span>
            <strong>Purge Data</strong>
            <em>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</em>
          </span>
        </a>
        <a class="action-card" href="/admin/consents">
          <span class="icon">‚úÖ</span>
          <span>
            <strong>Consents</strong>
            <em>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</em>
          </span>
        </a>
      </div>
    </section>
  </div>
</div>

<script src="/static/js/dashboard_map.js"></script>
<script>
  (function () {
    const TAB_KEYS = ['core', 'behavior'];
    const sections = Array.prototype.slice.call(document.querySelectorAll('[data-dashboard-section]'));
    const tabButtons = Array.prototype.slice.call(document.querySelectorAll('[data-dashboard-tab]'));
    const behaviorLink = document.querySelector('[data-tab-jump="behavior"]');

    function parseGroups(section) {
      return String(section.dataset.dashboardSection || '')
        .split(/\s+/)
        .map((s) => s.trim())
        .filter(Boolean);
    }

    function showTab(key) {
      const target = TAB_KEYS.includes(key) ? key : 'core';
      tabButtons.forEach((btn) => {
        btn.classList.toggle('is-active', btn.dataset.dashboardTab === target);
      });
      sections.forEach((section) => {
        const groups = parseGroups(section);
        const visible = groups.includes(target) || (target === 'core' && groups.length === 0);
        section.classList.toggle('dashboard-tab-hidden', !visible);
      });
      try {
        window.localStorage.setItem('dashboard-tab', target);
      } catch (_) {
        /* ignore storage errors */
      }
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        showTab(btn.dataset.dashboardTab);
      });
    });

    if (behaviorLink) {
      behaviorLink.addEventListener('click', (ev) => {
        ev.preventDefault();
        showTab('behavior');
        document.querySelector('#customer-insights')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }

    let initial = 'core';
    try {
      const stored = window.localStorage.getItem('dashboard-tab');
      if (TAB_KEYS.includes(stored)) initial = stored;
    } catch (_) {
      /* ignore storage errors */
    }
    showTab(initial);
  })();
</script>
  .network-list{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .network-list li{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    background:rgba(15,23,42,0.05);
    border-radius:14px;
    padding:12px 16px;
  }
  .network-list li.empty{
    justify-content:center;
    color:#6b7280;
    font-style:italic;
  }
  .network-party{
    font-weight:600;
  }
  .network-party.customer{ color:#2563eb; }
  .network-party.agent{ color:#ef476f; }
  .network-volume{
    margin-left:auto;
    font-weight:600;
    color:#0f172a;
  }
