<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= (typeof title === 'string' && title ? `${title} · ` : '') %>Sorrni · Admin Console</title>
  <link rel="icon" href="/static/img/nila-logo.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" />
  <link rel="stylesheet" href="/static/css/main.css" />
  <link rel="stylesheet" href="/static/styles/responsive-fixes.css" />
  <link rel="stylesheet" href="/static/styles/brand-login.css" />
  <!-- hotfix responsive 20251015 -->
  <link rel="stylesheet" href="/static/css/hotfix-layout-20251015.css?v=3.1" />
  <!-- fullwidth redesign v4 -->
  <link rel="stylesheet" href="/static/css/fullwidth-v4.css?v=4.0" />
  <link rel="stylesheet" href="/static/css/console-redesign.css?v=1.2" />
  <link rel="stylesheet" href="/static/css/dashboard-neo.css?v=1.0" />
</head>
<%
  const hideChrome = (typeof noChrome !== 'undefined') ? !!noChrome : false;
  const isLineShell = (typeof locals.isLine !== 'undefined') ? !!locals.isLine : false;
  const isGuest = (typeof locals.isGuest !== 'undefined') ? !!locals.isGuest : !(locals.user && locals.user.username);
  const displayName = (user && user.username) ? user.username : (isGuest ? 'Guest' : 'User');
  const redirectTarget = (typeof locals.redirectTo === 'string' && locals.redirectTo.length)
    ? locals.redirectTo
    : (typeof req !== 'undefined' ? req.originalUrl || '/admin' : '/admin');
  const redirectQuery = encodeURIComponent(redirectTarget);

  const headerTitle = typeof locals.lineHeaderTitle === 'string' ? locals.lineHeaderTitle : (typeof title === 'string' ? title : 'Workspace');
  const headerSubtitle = typeof locals.lineHeaderSubtitle === 'string'
    ? locals.lineHeaderSubtitle
    : (isGuest ? 'โหมดอ่านอย่างเดียว' : 'พร้อมดำเนินการ');

  const bodyClasses = ['app-shell'];
  if (hideChrome) bodyClasses.push('auth');
  if (!hideChrome) bodyClasses.push('has-chrome');
  if (hideChrome) bodyClasses.push('no-chrome');
  if (isLineShell) bodyClasses.push('line-shell');
  if (typeof bodyVariant === 'string' && bodyVariant) bodyClasses.push(bodyVariant);
  if (!bodyClasses.includes('use-fullwidth')) bodyClasses.push('use-fullwidth');

  const fullWidth = typeof locals.fullWidth === 'boolean' ? locals.fullWidth : false;
  const navGroups = [
    {
      label: 'Overview',
      items: [
        { key: 'dashboard', href: '/admin', title: 'Dashboard' },
        { key: 'insights', href: '/admin/insights', title: 'Insights' },
        { key: 'locations', href: '/admin/locations', title: 'Locations' },
        { key: 'consents', href: '/admin/consents', title: 'Consents' },
      ],
    },
    {
      label: 'Data Ops',
      items: [
        { key: 'upload', href: '/admin/upload', title: 'Upload' },
        { key: 'test', href: '/admin/test', title: 'Test & Send' },
        { key: 'keywords', href: '/admin/keywords', title: 'Keywords' },
        { key: 'procurement-pr', href: '/admin/pr', title: 'PR Board' },
        { key: 'procurement-po', href: '/admin/po', title: 'PO Board' },
        { key: 'procurement-vendors', href: '/admin/vendors', title: 'Vendors' },
        { key: 'procurement-settings', href: '/admin/settings/procurement', title: 'Settings' },
      ],
    },
    {
      label: 'Organization',
      items: [
        { key: 'companies', href: '/admin/companies', title: 'Companies' },
        { key: 'members', href: '/admin/members', title: 'Members' },
        { key: 'link', href: '/admin/members/link', title: 'Link Users' },
      ],
    },
    {
      label: 'LINE',
      items: [
        { key: 'richmenu', href: '/admin/richmenu', title: 'Rich Menu' },
        { key: 'bot-faq', href: '/admin/bot-faq', title: 'Bot Q&A' },
      ],
    },
    {
      label: 'Tools',
      items: [
        { key: 'tools', href: '/admin/tools/purge', title: 'Purge Data' },
        { key: 'tools-send-daily', href: '/admin/tools/send-daily', title: 'Send Daily' },
      ],
    },
  ];

  const isNavItemActive = (item) => {
    if (active === item.key) return true;
    if (active === 'tools' && typeof item.href === 'string' && item.href.startsWith('/admin/tools')) return true;
    return false;
  };
  const isGroupActive = (group) => group.items.some((item) => isNavItemActive(item));
%>
<body class="<%= bodyClasses.join(' ') %>">
  <% if (!hideChrome) { %>
    <% if (isLineShell) { %>
      <header class="line-header">
        <div class="line-header__brand">
          <img src="/static/img/nila-logo.png" alt="Sorrni" />
          <div>
            <strong><%= headerTitle %></strong>
            <span><%= headerSubtitle %></span>
          </div>
        </div>
        <div class="line-header__user">
          <span><%= displayName %></span>
        </div>
      </header>
    <% } else { %>
      <header class="topbar" role="banner">
        <div class="topbar__inner">
          <div class="topbar__brand">
            <button
              type="button"
              class="nav-toggle"
              aria-expanded="false"
              aria-controls="main-nav"
              data-nav-toggle
            >
              <span></span><span></span><span></span>
            </button>
            <a href="/admin" class="brand">
              <img src="/static/img/nila-logo.png" alt="Sorrni" />
              <span class="brand__text">
                <strong>Sorrni Control</strong>
                <small>Unified Ops & CDP</small>
              </span>
            </a>
          </div>
          <nav class="topnav" id="main-nav" aria-label="เมนูหลัก">
            <div class="topnav__content">
              <% navGroups.forEach((group, groupIndex) => { const groupActive = isGroupActive(group); %>
                <div class="topnav-menu <%= groupActive ? 'is-active' : '' %>" data-topnav-menu>
                  <button
                    type="button"
                    class="topnav-menu__trigger"
                    aria-expanded="<%= groupActive ? 'true' : 'false' %>"
                    data-menu-trigger
                  >
                    <span><%= group.label %></span>
                    <svg width="12" height="12" viewBox="0 0 12 12" aria-hidden="true">
                      <path d="M2.5 4.5 6 8l3.5-3.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                  <ul class="topnav-menu__list" data-menu-list role="menu" <%= groupActive ? '' : 'hidden' %>>
                    <% group.items.forEach((item) => { %>
                      <li role="none">
                        <a role="menuitem" href="<%= item.href %>" class="<%= isNavItemActive(item) ? 'active' : '' %>"><%= item.title %></a>
                      </li>
                    <% }) %>
                  </ul>
                </div>
              <% }) %>
            </div>
          </nav>
          <div class="topbar__account">
            <span class="user-pill"><%= displayName %></span>
            <% if (isGuest) { %>
              <a class="btn ghost" href="/admin/login?redirect=<%= redirectQuery %>">Login</a>
            <% } else { %>
              <a class="btn ghost" href="/admin/logout">Logout</a>
            <% } %>
          </div>
        </div>
      </header>
      <aside class="drawer" data-nav-drawer aria-hidden="true">
        <div class="drawer__header">
          <a href="/admin" class="brand">
            <img src="/static/img/nila-logo.png" alt="Sorrni" />
            <span class="brand__text">
              <strong>Sorrni Control</strong>
              <small>Unified Ops & CDP</small>
            </span>
          </a>
          <button type="button" class="btn icon ghost" data-drawer-close aria-label="ปิดเมนู">
            ✕
          </button>
        </div>
        <nav class="drawer__nav" aria-label="เมนูหลัก (มือถือ)">
          <% navGroups.forEach((group, idx) => { const groupId = `drawer-group-${idx}`; %>
            <section class="drawer-group" data-drawer-group data-group-key="<%= group.label %>">
              <button
                type="button"
                class="drawer-group__toggle"
                aria-expanded="false"
                aria-controls="<%= groupId %>"
              >
                <span><%= group.label %></span>
                <span class="drawer-group__icon" aria-hidden="true">▾</span>
              </button>
              <ul id="<%= groupId %>" class="drawer-group__list" hidden>
                <% group.items.forEach((item) => { %>
                  <li>
                    <a href="<%= item.href %>" class="<%= isNavItemActive(item) ? 'is-active' : '' %>"><%= item.title %></a>
                  </li>
                <% }) %>
              </ul>
            </section>
          <% }) %>
        </nav>
        <div class="drawer__meta">
          <span class="user-pill"><%= displayName %></span>
          <% if (isGuest) { %>
            <a class="btn primary btn-block" href="/admin/login?redirect=<%= redirectQuery %>">Login</a>
          <% } else { %>
            <a class="btn ghost btn-block" href="/admin/logout">Logout</a>
          <% } %>
        </div>
      </aside>
      <div class="drawer-backdrop" data-drawer-backdrop aria-hidden="true"></div>
    <% } %>
  <% } %>

  <main class="app-main <%= fullWidth ? 'app-main--full' : '' %>">
    <% if (!hideChrome && isGuest) { %>
      <div class="guest-callout">
        <div>
          <strong>โหมดอ่านอย่างเดียว</strong>
          <span>ล็อกอินเพื่อสร้าง/อนุมัติเอกสาร</span>
        </div>
        <a class="btn primary" href="/admin/login?redirect=<%= redirectQuery %>">ล็อกอิน</a>
      </div>
    <% } %>
    <div class="<%= hideChrome ? (fullWidth ? 'full-container' : 'bare-container') : 'container' %>">
      <%- body %>
    </div>
  </main>

  <% if (!hideChrome && !isLineShell) { %>
    <footer class="app-footer">
      © <%= new Date().getFullYear() %> Nila Solutions · All rights reserved.
    </footer>
  <% } %>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" crossorigin="anonymous" defer></script>
  <script src="/static/js/main.js" defer></script>
  <!-- hotfix layout helper -->
  <script src="/static/js/layout-hotfix-v3.js?v=3.1" defer></script>
  <script src="/static/js/fullwidth-boot.js?v=4.0" defer></script>
</body>
</html>
