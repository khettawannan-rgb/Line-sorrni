<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= (typeof title === 'string' && title ? `${title} · ` : '') %>NILA · Admin</title>
  <link rel="icon" href="/static/img/Nila_Flatcolour_Logo-.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=IBM+Plex+Sans+Thai:wght@400;500;600;700&display=swap" />
  <link rel="stylesheet" href="/static/css/main.css" />
</head>
<%
  const hideChrome = (typeof noChrome !== 'undefined') ? !!noChrome : false;
  const isLineShell = (typeof locals.isLine !== 'undefined') ? !!locals.isLine : false;
  const isGuest = (typeof locals.isGuest !== 'undefined') ? !!locals.isGuest : !(locals.user && locals.user.username);
  const displayName = (user && user.username) ? user.username : (isGuest ? 'Guest' : 'User');
  const redirectTarget = (typeof locals.redirectTo === 'string' && locals.redirectTo.length)
    ? locals.redirectTo
    : (typeof req !== 'undefined' ? req.originalUrl || '/admin' : '/admin');
  const redirectQuery = encodeURIComponent(redirectTarget);

  const headerTitle = typeof locals.lineHeaderTitle === 'string' ? locals.lineHeaderTitle : (typeof title === 'string' ? title : 'Workspace');
  const headerSubtitle = typeof locals.lineHeaderSubtitle === 'string'
    ? locals.lineHeaderSubtitle
    : (isGuest ? 'โหมดอ่านอย่างเดียว' : 'พร้อมดำเนินการ');

  const bodyClasses = ['app-shell'];
  if (hideChrome) bodyClasses.push('no-chrome');
  if (isLineShell) bodyClasses.push('line-shell');
  if (typeof bodyVariant === 'string' && bodyVariant) bodyClasses.push(bodyVariant);

  const navGroups = [
    {
      label: 'ภาพรวม',
      items: [
        { key: 'dashboard', href: '/admin', title: 'Dashboard' },
        { key: 'insights', href: '/admin/insights', title: 'Insights' },
        { key: 'locations', href: '/admin/locations', title: 'Locations' },
        { key: 'consents', href: '/admin/consents', title: 'Consents' },
      ],
    },
    {
      label: 'งานจัดซื้อ',
      items: [
        { key: 'procurement-pr', href: '/admin/pr', title: 'PR Board' },
        { key: 'procurement-po', href: '/admin/po', title: 'PO Board' },
        { key: 'procurement-vendors', href: '/admin/vendors', title: 'Vendors' },
        { key: 'procurement-settings', href: '/admin/settings/procurement', title: 'Settings' },
        { key: 'upload', href: '/admin/upload', title: 'Upload' },
      ],
    },
    {
      label: 'Directory',
      items: [
        { key: 'companies', href: '/admin/companies', title: 'Companies' },
        { key: 'members', href: '/admin/members', title: 'Members' },
        { key: 'link', href: '/admin/members/link', title: 'Link Users' },
        { key: 'keywords', href: '/admin/keywords', title: 'Keywords' },
        { key: 'bot-faq', href: '/admin/bot-faq', title: 'Bot Q&A' },
      ],
    },
  ];
%>
<body class="<%= bodyClasses.join(' ') %>">
  <% if (!hideChrome) { %>
    <% if (isLineShell) { %>
      <header class="line-header">
        <div class="line-header__brand">
          <img src="/static/img/Nila_Flatcolour_Logo-.png" alt="NILA" />
          <div>
            <strong><%= headerTitle %></strong>
            <span><%= headerSubtitle %></span>
          </div>
        </div>
        <div class="line-header__user">
          <span><%= displayName %></span>
        </div>
      </header>
    <% } else { %>
      <header class="topbar" role="banner">
        <div class="topbar__brand">
          <a href="/admin" class="brand">
            <img src="/static/img/Nila_Flatcolour_Logo-.png" alt="NILA" />
            <span>NILA · Admin</span>
          </a>
          <button type="button" class="nav-toggle" aria-expanded="false" data-nav-toggle>
            <span></span><span></span><span></span>
          </button>
        </div>
        <nav class="topnav" id="main-nav">
          <% navGroups.forEach((group) => { %>
            <div class="topnav-group">
              <span class="topnav-label"><%= group.label %></span>
              <ul>
                <% group.items.forEach((item) => { %>
                  <li>
                    <a href="<%= item.href %>" class="<%= active === item.key ? 'active' : '' %>"><%= item.title %></a>
                  </li>
                <% }) %>
              </ul>
            </div>
          <% }) %>
        </nav>
        <div class="topbar__account">
          <span class="user-pill"><%= displayName %></span>
          <% if (isGuest) { %>
            <a class="btn ghost" href="/admin/login?redirect=<%= redirectQuery %>">Login</a>
          <% } else { %>
            <a class="btn ghost" href="/admin/logout">Logout</a>
          <% } %>
        </div>
      </header>
    <% } %>
  <% } %>

  <main class="app-main">
    <% if (!hideChrome && isGuest) { %>
      <div class="guest-callout">
        <div>
          <strong>โหมดอ่านอย่างเดียว</strong>
          <span>ล็อกอินเพื่อสร้าง/อนุมัติเอกสาร</span>
        </div>
        <a class="btn primary" href="/admin/login?redirect=<%= redirectQuery %>">ล็อกอิน</a>
      </div>
    <% } %>
    <div class="<%= hideChrome ? 'bare-container' : 'container' %>">
      <%- body %>
    </div>
  </main>

  <% if (!hideChrome && !isLineShell) { %>
    <footer class="app-footer">
      © <%= new Date().getFullYear() %> Nila Solutions · All rights reserved.
    </footer>
  <% } %>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" crossorigin="anonymous" defer></script>
  <script src="/static/js/main.js" defer></script>
</body>
</html>
