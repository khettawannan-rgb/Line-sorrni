<div class="panel">
  <div class="panel-header panel__header">
    <h2>ส่งสรุปรายวัน (Manual)</h2>
  </div>
  <div class="panel-body panel__body">
    <% if (result?.error) { %><div class="alert error"><%= result.error %></div><% } %>
    <% if (result?.ok) { %>
      <div class="alert success">ส่งสำเร็จบางส่วน/ทั้งหมด ดูรายละเอียดด้านล่าง</div>
      <pre class="code"><%= result.preview %></pre>
      <div class="form-help">picked date: <%= result.picked %> (<%= result.reason %>)</div>
      <hr class="sep"/>
      <div class="table-wrap table-scroll">
        <table class="table compact">
          <thead>
            <tr>
              <th>ผู้รับ</th>
              <th>สถานะ</th>
              <th>หมายเหตุ</th>
            </tr>
          </thead>
          <tbody>
            <% (result.sent||[]).forEach(s=>{ %>
              <tr>
                <td class="muted"><%= s.to %></td>
                <td><span class="badge <%= s.ok ? 'success' : 'danger' %>"><%= s.ok?'OK':'Fail' %></span></td>
                <td class="muted"><%= s.error || '-' %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>

    <form class="form" method="post">
      <div class="form-grid">
        <div class="field">
          <label>บริษัท</label>
          <select name="companyId" required onchange="location.href='/admin/tools/send-daily?companyId='+this.value">
            <option value="">— เลือก —</option>
            <% companies.forEach(c => { %>
              <option value="<%= c._id %>" <%= (form?.companyId===c._id.toString()?'selected':'') %>><%= c.name %></option>
            <% }) %>
          </select>
        </div>
        <div class="field">
          <label>วันที่</label>
          <input type="date" name="date" value="<%= form?.date || '' %>" required />
        </div>
        <div class="field">
          <label>ผู้รับ (LINE userId)</label>
          <select name="to">
            <option value="">— ส่งให้สมาชิกทุกคน —</option>
            <% (members||[]).forEach(m => { if (m.lineUserId) { %>
              <option value="<%= m.lineUserId %>" <%= (form?.to===m.lineUserId?'selected':'') %>><%= (m.displayName||'-')+' · '+m.lineUserId %></option>
            <% } }) %>
          </select>
          <div class="form-help">หรือใส่ userId เอง: <input name="to" value="<%= form?.to || '' %>" placeholder="Uxxxxxxxxxxxxxxxxxxxxxxxxxxxx" style="min-width:280px" /></div>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn primary" type="submit">ส่งเลย</button>
      </div>
    </form>
  </div>
</div>
