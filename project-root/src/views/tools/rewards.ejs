<div class="panel">
  <div class="panel-header panel__header">
    <h2>ของรางวัล (Rewards)</h2>
  </div>
  <div class="panel-body panel__body">
    <% if (result?.error) { %><div class="alert error"><%= result.error %></div><% } %>
    <% if (result?.ok) { %><div class="alert success"><%= result.message %></div><% } %>

    <div class="stat-cards" style="display:flex;gap:12px;flex-wrap:wrap;margin:8px 0 16px;">
      <div class="card small"><div class="card-body"><strong>รวมทั้งหมด</strong><div><%= summary.total %></div></div></div>
      <div class="card small"><div class="card-body"><strong>คงเหลือ</strong><div><%= summary.available %></div></div></div>
      <div class="card small"><div class="card-body"><strong>ค้างแจก</strong><div><%= summary.reserved %></div></div></div>
      <div class="card small"><div class="card-body"><strong>ใช้แล้ว</strong><div><%= summary.used %></div></div></div>
    </div>

    <form class="form" method="post" action="/admin/tools/rewards/allocate" style="margin-bottom:16px">
      <div class="form-actions">
        <button class="btn primary" type="submit" <%= summary.available<=0 ? 'disabled' : '' %>>สุ่มแจกให้ผู้ชนะ</button>
        <% if (summary.available<=0) { %>
          <span class="form-help" style="margin-left:8px;opacity:0.7">ของรางวัลหมดแล้ว</span>
        <% } %>
      </div>
    </form>

    <div class="table-wrap table-scroll">
      <table class="table compact">
        <thead>
          <tr>
            <th>รายการ</th>
            <th>รวม</th>
            <th>คงเหลือ</th>
            <th>ค้างแจก</th>
            <th>ใช้แล้ว</th>
            <th>การทำงาน</th>
          </tr>
        </thead>
        <tbody>
          <% (prizes||[]).forEach(p => { %>
            <tr>
              <td><strong><%= p.name %></strong></td>
              <td><%= p.total %></td>
              <td><%= p.available %></td>
              <td><%= p.reserved %></td>
              <td><%= p.used %></td>
              <td>
                <form method="post" action="/admin/tools/rewards/<%= p._id %>/mark-used" style="display:inline-block;margin-right:6px">
                  <button class="btn small" type="submit" <%= p.reserved>0 ? '' : 'disabled' %>>Mark ใช้แล้ว -1</button>
                </form>
                <form method="post" action="/admin/tools/rewards/<%= p._id %>/revert" style="display:inline-block;margin-right:6px">
                  <input type="hidden" name="from" value="reserved" />
                  <button class="btn small ghost" type="submit" <%= p.reserved>0 ? '' : 'disabled' %>>คืนสถานะ -1</button>
                </form>
                <form method="post" action="/admin/tools/rewards/<%= p._id %>/revert" style="display:inline-block">
                  <input type="hidden" name="from" value="used" />
                  <button class="btn small ghost" type="submit" <%= p.used>0 ? '' : 'disabled' %>>คืนจากใช้แล้ว -1</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
  <div class="panel-footer panel__footer">
    <div class="muted">หมายเหตุ: ระบบจะสุ่มโดยถ่วงน้ำหนักตามจำนวนคงเหลือของแต่ละรายการ</div>
  </div>
  
</div>

