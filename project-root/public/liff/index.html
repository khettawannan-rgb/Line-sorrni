<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini Games ¬∑ LIFF</title>
  <link rel="stylesheet" href="/static/css/main.css" />
  <style>
    :root { --ci-primary: var(--brand-primary, #0ea5e9); --ci-text: #0f172a; --ci-soft: #eef2ff; }
    body { background: var(--ci-soft); color: var(--ci-text); }
    .hub { max-width: 680px; margin: 18px auto; }
    .card { background: #fff; border: 1px solid rgba(0,0,0,0.06); border-radius: 16px; padding: 16px; }
    .actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 12px; margin-top: 12px; }
    .btn-ci { background: var(--ci-primary); color: #fff; border: none; border-radius: 10px; padding: 12px 14px; cursor: pointer; }
    .muted { color: #64748b }
    .q { font-weight: 600; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="/liff/config.js"></script>
</head>
<body>
  <main class="hub container" id="app">
    <div class="card">
      <h2 id="title">Mini Game</h2>
      <p class="muted" id="subtitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Å‡∏°...</p>
      <div id="view"></div>
    </div>
  </main>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const qp = new URL(location.href).searchParams;
    const game = (qp.get('game') || 'quiz').toLowerCase();
    const state = { userId: '', sessionId: Math.random().toString(36).slice(2), score: 0, step: 0 };

    async function track(name, payload){
      try { await fetch('/cdp/track', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, payload })}); } catch {}
    }

    async function initLIFF(){
      const liffId = (window.__LIFF__ && window.__LIFF__.GAMES) || '';
      try { if (liffId) await liff.init({ liffId }); } catch(e) {}
      try { const profile = await liff.getProfile(); state.userId = profile.userId || ''; } catch {}
    }

    function renderQuiz(){
      const data = [
        { q:'‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏™‡∏ü‡∏±‡∏•‡∏ï‡πå‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?', c:['‡∏ö‡∏¥‡∏ó‡∏π‡πÄ‡∏°‡∏ô','‡∏õ‡∏π‡∏ô‡∏ã‡∏µ‡πÄ‡∏°‡∏ô‡∏ï‡πå','‡∏ó‡∏£‡∏≤‡∏¢','‡∏î‡∏¥‡∏ô'], a:0 },
        { q:'‡∏ù‡∏ô‡∏ï‡∏Å‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏π‡∏¢‡∏≤‡∏á?', c:['‡∏ó‡∏≥‡∏ï‡πà‡∏≠','‡∏´‡∏¢‡∏∏‡∏î','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡πâ‡∏≥','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥'], a:1 },
        { q:'‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏ú‡∏™‡∏°‡∏¢‡∏≤‡∏á‡∏Ñ‡∏ß‡∏£...', c:['‡∏ï‡πà‡∏≥','‡∏û‡∏≠‡πÄ‡∏´‡∏°‡∏≤‡∏∞','‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å','‡∏™‡∏∏‡πà‡∏°'], a:1 },
        { q:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏°‡∏µ‡∏ú‡∏•?', c:['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•','‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏•‡∏î','‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô','‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà'], a:1 },
        { q:'‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏π‡∏¢‡∏≤‡∏á‡∏Ñ‡∏ß‡∏£...', c:['‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à','‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏∑‡πâ‡∏ô‡∏ú‡∏¥‡∏ß','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡πâ‡∏≥','‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô'], a:1 },
      ];
      state.step = 0; state.score = 0;
      $('#title').textContent = 'Road Builder Quiz';
      $('#subtitle').textContent = '‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 5 ‡∏Ç‡πâ‡∏≠';
      const root = $('#view');
      root.innerHTML = '';
      const qEl = document.createElement('div');
      const btns = document.createElement('div'); btns.className='actions';
      root.appendChild(qEl); root.appendChild(btns);
      function next(){
        if(state.step>=5){
          const win = state.score>=4;
          root.innerHTML = `<p class="q">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${state.score}/5</p><p>${win? '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: <strong>WIN-'+state.sessionId.slice(0,4).toUpperCase()+'</strong>' : '‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ'}</p>`;
          track('finish', { userId: state.userId, game:'quiz', score: state.score });
          if(win) track('win_reward', { userId: state.userId, game:'quiz', code: 'WIN-'+state.sessionId.slice(0,4).toUpperCase() });
          return;
        }
        const cur = data[state.step];
        qEl.innerHTML = `<p class="q">${state.step+1}) ${cur.q}</p>`;
        btns.innerHTML = '';
        cur.c.forEach((choice,idx)=>{
          const b=document.createElement('button'); b.className='btn-ci'; b.textContent=choice;
          b.onclick=()=>{ if(idx===cur.a) state.score++; state.step++; track('answer',{ userId:state.userId, game:'quiz', step: state.step, correct: idx===cur.a }); next(); };
          btns.appendChild(b);
        });
      }
      next();
    }

    function renderRunner(){
      $('#title').textContent = 'Asphalt Runner';
      $('#subtitle').textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠/‡∏´‡∏¢‡∏∏‡∏î‡∏á‡∏≤‡∏ô (5 ‡∏£‡∏≠‡∏ö)';
      const scenarios = ['‡πÅ‡∏î‡∏î‡∏à‡∏±‡∏î','‡πÄ‡∏°‡∏Ü‡∏°‡∏≤‡∏Å','‡∏ù‡∏ô‡∏õ‡∏£‡∏≠‡∏¢','‡∏ù‡∏ô‡∏´‡∏ô‡∏±‡∏Å','‡∏•‡∏°‡πÅ‡∏£‡∏á'];
      const root=$('#view'); root.innerHTML=''; const box=document.createElement('div'); const btns=document.createElement('div'); btns.className='actions'; root.appendChild(box); root.appendChild(btns);
      state.step=0; state.score=0;
      function next(){
        if(state.step>=5){
          const win=state.score>=4; root.innerHTML=`<p class="q">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${state.score}/5</p><p>${win?'‡∏ú‡πà‡∏≤‡∏ô! ‡πÇ‡∏Ñ‡πâ‡∏î: <strong>WIN-'+state.sessionId.slice(0,4).toUpperCase()+'</strong>':'‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'}</p>`;
          track('finish',{ userId:state.userId, game:'runner', score:state.score }); if(win) track('win_reward',{ userId:state.userId, game:'runner' }); return;
        }
        const w = scenarios[Math.floor(Math.random()*scenarios.length)];
        const shouldStop = /‡∏ù‡∏ô|‡∏•‡∏°‡πÅ‡∏£‡∏á/.test(w);
        box.innerHTML = `<p class="q">‡∏£‡∏≠‡∏ö ${state.step+1} ‚Ä¢ ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®: ${w}</p>`;
        btns.innerHTML='';
        [['‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠',false],['‡∏´‡∏¢‡∏∏‡∏î‡∏á‡∏≤‡∏ô',true]].forEach(([label,stop])=>{
          const b=document.createElement('button'); b.className='btn-ci'; b.textContent=label;
          b.onclick=()=>{ const correct = (stop===shouldStop); if(correct) state.score++; state.step++; track('answer',{ userId:state.userId, game:'runner', step: state.step, correct }); next(); };
          btns.appendChild(b);
        });
      }
      next();
    }

    function renderSign(){
      $('#title').textContent = 'Guess the Road Sign';
      $('#subtitle').textContent = '‡∏ó‡∏≤‡∏¢‡∏õ‡πâ‡∏≤‡∏¢‡∏à‡∏£‡∏≤‡∏à‡∏£ (5 ‡∏£‡∏≠‡∏ö)';
      const data=[['üö´','‡∏´‡πâ‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô'],['‚ö†Ô∏è','‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢'],['‚¨ÖÔ∏è','‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢'],['üÖøÔ∏è','‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ'],['üö∏','‡∏ó‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏°']];
      const root=$('#view'); root.innerHTML=''; const q=document.createElement('div'); const btns=document.createElement('div'); btns.className='actions'; root.appendChild(q); root.appendChild(btns);
      state.step=0; state.score=0; function next(){ if(state.step>=5){ const win=state.score>=4; root.innerHTML=`<p class="q">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${state.score}/5</p><p>${win?'‡∏ú‡πà‡∏≤‡∏ô! ‡πÇ‡∏Ñ‡πâ‡∏î: <strong>WIN-'+state.sessionId.slice(0,4).toUpperCase()+'</strong>':'‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'}</p>`; track('finish',{ userId:state.userId, game:'sign', score: state.score }); if(win) track('win_reward',{ userId:state.userId, game:'sign' }); return; } const cur=data[state.step]; q.innerHTML=`<div style="font-size:52px">${cur[0]}</div><p class="muted">‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏∞‡πÑ‡∏£?</p>`; btns.innerHTML=''; const choices=['‡∏´‡πâ‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô','‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢','‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢','‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ','‡∏ó‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏°'].sort(()=>Math.random()-0.5).slice(0,4); choices.forEach((c)=>{ const b=document.createElement('button'); b.className='btn-ci'; b.textContent=c; b.onclick=()=>{ const correct=c===cur[1]; if(correct) state.score++; state.step++; track('answer',{ userId:state.userId, game:'sign', step: state.step, correct }); next(); }; btns.appendChild(b);});}
      next();
    }

    function allowPlay(){
      const key = `game-count-${state.userId || 'guest'}-${game}-${new Date().toISOString().slice(0,10)}`;
      const n = Number(localStorage.getItem(key) || '0');
      if (n >= 3) { $('#view').innerHTML = '<p class="q">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß (3/‡∏ß‡∏±‡∏ô)</p>'; return false; }
      localStorage.setItem(key, String(n+1));
      return true;
    }

    (async () => {
      await initLIFF();
      track('open_game', { userId: state.userId, game });
      if (!allowPlay()) return;
      if (game==='runner') renderRunner();
      else if (game==='sign') renderSign();
      else renderQuiz();
    })();
  </script>
</body>
</html>
